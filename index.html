<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>徐靖峰|个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="徐靖峰|个人博客">
<meta property="og:url" content="http://lexburner.github.io/index.html">
<meta property="og:site_name" content="徐靖峰|个人博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="徐靖峰|个人博客">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    



</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">徐靖峰|个人博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">徐靖峰</h2>
            <h3 id="title">JAVA Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shanghai, China</span>
            <a id="follow" target="_blank" href="https://github.com/lexburner">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                62
                <span>文章</span>
            </div>
            <div class="article-info-block">
                29
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/lexburner" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/css/images/kirito_wechat.jpg" target="_blank" title="wechat" class=tooltip>
                            <i class="fa fa-wechat"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-rpc-dynamic-proxy" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/15/rpc-dynamic-proxy/">深入理解RPC之动态代理篇</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/15/rpc-dynamic-proxy/">
            <time datetime="2017-12-15T12:16:28.000Z" itemprop="datePublished">2017-12-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/RPC/">RPC</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/RPC/">RPC</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>提到 JAVA 中的动态代理，大多数人都不会对 JDK 动态代理感到陌生，Proxy，InvocationHandler 等类都是 J2SE 中的基础概念。动态代理发生在服务调用方/客户端，RPC 框架需要解决的一个问题是：像调用本地接口一样调用远程的接口。于是如何组装数据报文，经过网络传输发送至服务提供方，屏蔽远程接口调用的细节，便是动态代理需要做的工作了。RPC 框架中的代理层往往是单独的一层，以方便替换代理方式（如 motan 代理层位于<code>com.weibo.api.motan.proxy</code> ，dubbo代理层位于 <code>com.alibaba.dubbo.common.bytecode</code> ）。</p>
<p>实现动态代理的方案有下列几种：</p>
<ul>
<li>jdk 动态代理</li>
<li>cglib 动态代理</li>
<li>javassist 动态代理</li>
<li>ASM 字节码</li>
<li>javassist 字节码</li>
</ul>
<p>其中 cglib 底层实现依赖于 ASM，javassist 自成一派。由于 ASM 和 javassist 需要程序员直接操作字节码，导致使用门槛相对较高，但实际上他们的应用是非常广泛的，如 Hibernate 底层使用了 javassist（默认）和 cglib，Spring 使用了 cglib 和 jdk 动态代理。</p>
<p>RPC 框架无论选择何种代理技术，所需要完成的任务其实是固定的，不外乎‘整理报文’，‘确认网络位置’，‘序列化’,’网络传输’，‘反序列化’，’返回结果’…</p>
<h2 id="技术选型的影响因素"><a href="#技术选型的影响因素" class="headerlink" title="技术选型的影响因素"></a>技术选型的影响因素</h2><p>框架中使用何种动态代理技术，影响因素也不少。</p>
<h3 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h3><p>从早期 dubbo 的作者梁飞的博客 <a href="http://javatar.iteye.com/blog/814426" target="_blank" rel="external">http://javatar.iteye.com/blog/814426</a> 中可以得知 dubbo 选择使用 javassist 作为动态代理方案主要考虑的因素是<strong>性能</strong>。</p>
<p>从其博客的测试结果来看 javassist &gt; cglib &gt; jdk 。但实际上他的测试过程稍微有点瑕疵：在 cglib 和 jdk 代理对象调用时，走的是反射调用，而在 javassist 生成的代理对象调用时，走的是直接调用（可以先阅读下梁飞大大的博客）。这意味着 cglib 和 jdk 慢的原因并不是由动态代理产生的，而是由反射调用产生的（顺带一提，很多人认为 jdk 动态代理的原理是反射，其实它的底层也是使用的字节码技术）。而最终我的测试结果，结论如下： javassist ≈ cglib &gt; jdk 。javassist 和 cglib 的效率基本持平 ，而他们两者的执行效率基本可以达到 jdk 动态代理的2倍（这取决于测试的机器以及 jdk 的版本，jdk1.8 相较于 jdk1.6 动态代理技术有了质的提升，所以并不是传闻中的那样：cglib 比 jdk 快 10倍）。文末会给出我的测试代码。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><blockquote>
<p>motan默认的实现是jdk动态代理，代理方案支持SPI扩展，可以自行扩展其他实现方式。</p>
<p>使用jdk做为默认，主要是减少core包依赖，性能不是唯一考虑因素。另外使用字节码方式javaassist性能比较优秀，动态代理模式下jdk性能也不会差多少。</p>
<p>– <strong>rayzhang0603</strong>(motan贡献者)</p>
</blockquote>
<p>motan 选择使用 jdk 动态代理，原因主要有两个：减少 motan-core 的依赖，方便。至于扩展性，dubbo 并没有预留出动态代理的扩展接口，而是写死了 bytecode ，这点上 motan 做的较好。</p>
<h3 id="易用性"><a href="#易用性" class="headerlink" title="易用性"></a>易用性</h3><p>从 dubbo 和 motan 的源码中便可以直观的看出两者的差距了，dubbo 为了使用 javassist 技术花费不少的精力，而 motan 使用 jdk 动态代理只用了一个类。dubbo 的设计者为了追求极致的性能而做出的工作是值得肯定的，motan 也预留了扩展机制，两者各有千秋。</p>
<h2 id="动态代理入门指南"><a href="#动态代理入门指南" class="headerlink" title="动态代理入门指南"></a>动态代理入门指南</h2><p>为了方便对比几种动态代理技术，先准备一个统一接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookApi</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sell</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createJdkDynamicProxy</span><span class="params">(<span class="keyword">final</span> BookApi delegate)</span> </span>&#123;</div><div class="line">        BookApi jdkProxy = (BookApi) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),</div><div class="line">                <span class="keyword">new</span> Class[]&#123;BookApi.class&#125;, <span class="keyword">new</span> JdkHandler(delegate));</div><div class="line">        <span class="keyword">return</span> jdkProxy;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Object delegate;</div><div class="line"></div><div class="line">        JdkHandler(Object delegate) &#123;</div><div class="line">            <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] objects)</span></span></div><div class="line"><span class="function">                <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">//添加代理逻辑&lt;1&gt;</span></div><div class="line">            <span class="keyword">if</span>(method.getName().equals(<span class="string">"sell"</span>))&#123;</div><div class="line">                System.out.print(<span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="comment">//            return method.invoke(delegate, objects);</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p><1> 在真正的 RPC 调用中 ，需要填充‘整理报文’，‘确认网络位置’，‘序列化’,’网络传输’，‘反序列化’，’返回结果’等逻辑。</1></p>
<h3 id="Cglib动态代理"><a href="#Cglib动态代理" class="headerlink" title="Cglib动态代理"></a>Cglib动态代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createCglibDynamicProxy</span><span class="params">(<span class="keyword">final</span> BookApi delegate)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> CglibInterceptor(delegate));</div><div class="line">        enhancer.setInterfaces(<span class="keyword">new</span> Class[]&#123;BookApi.class&#125;);</div><div class="line">        BookApi cglibProxy = (BookApi) enhancer.create();</div><div class="line">        <span class="keyword">return</span> cglibProxy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Object delegate;</div><div class="line"></div><div class="line">        CglibInterceptor(Object delegate) &#123;</div><div class="line">            <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, Object[] objects,</span></span></div><div class="line"><span class="function"><span class="params">                                MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">//添加代理逻辑</span></div><div class="line">            <span class="keyword">if</span>(method.getName().equals(<span class="string">"sell"</span>)) &#123;</div><div class="line">                System.out.print(<span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="comment">//            return methodProxy.invoke(delegate, objects);</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>和 JDK 动态代理的操作步骤没有太大的区别，只不过是替换了 cglib 的API而已。</p>
<p>需要引入 cglib 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Javassist字节码"><a href="#Javassist字节码" class="headerlink" title="Javassist字节码"></a>Javassist字节码</h3><p>到了 javassist，稍微有点不同了。因为它是通过直接操作字节码来生成代理对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createJavassistBytecodeDynamicProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ClassPool mPool = <span class="keyword">new</span> ClassPool(<span class="keyword">true</span>);</div><div class="line">    CtClass mCtc = mPool.makeClass(BookApi.class.getName() + <span class="string">"JavaassistProxy"</span>);</div><div class="line">    mCtc.addInterface(mPool.get(BookApi.class.getName()));</div><div class="line">    mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line">    mCtc.addMethod(CtNewMethod.make(</div><div class="line">            <span class="string">"public void sell() &#123; System.out.print(\"\") ; &#125;"</span>, mCtc));</div><div class="line">    Class&lt;?&gt; pc = mCtc.toClass();</div><div class="line">    BookApi bytecodeProxy = (BookApi) pc.newInstance();</div><div class="line">    <span class="keyword">return</span> bytecodeProxy;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要引入 javassist 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.21.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="动态代理测试"><a href="#动态代理测试" class="headerlink" title="动态代理测试"></a>动态代理测试</h2><p>测试环境：window i5 8g jdk1.8 cglib3.2.5 javassist3.21.0-GA</p>
<p>动态代理其实分成了两步：代理对象的创建，代理对象的调用。坊间流传的动态代理性能对比主要指的是后者；前者一般不被大家考虑，如果远程Refer的对象是单例的，其只会被创建一次，而如果是原型模式，多例对象的创建其实也是性能损耗的一个考虑因素（只不过远没有调用占比大）。</p>
<blockquote>
<p>Create JDK Proxy: 21 ms</p>
<p>Create CGLIB Proxy: 342 ms</p>
<p>Create Javassist Bytecode Proxy: 419 ms</p>
</blockquote>
<p>可能出乎大家的意料，JDK 创建动态代理的速度比后两者要快10倍左右。</p>
<p>下面是调用速度的测试：</p>
<blockquote>
<p>case 1:</p>
<p>JDK Proxy invoke cost 1912 ms</p>
<p>CGLIB Proxy invoke cost 1015 ms</p>
<p>JavassistBytecode Proxy invoke cost 1280 ms</p>
<p>case 2:</p>
<p>JDK Proxy invoke cost 1747 ms</p>
<p>CGLIB Proxy invoke cost 1234 ms</p>
<p>JavassistBytecode Proxy invoke cost 1175 ms</p>
<p>case 3:</p>
<p>JDK Proxy invoke cost 2616 ms</p>
<p>CGLIB Proxy invoke cost 1373 ms</p>
<p>JavassistBytecode Proxy invoke cost 1335 ms</p>
</blockquote>
<p>Jdk 的执行速度一定会慢于 Cglib 和 Javassist，但最慢也就2倍，并没有达到数量级的差距；Cglib 和 Javassist不相上下，差距不大（测试中偶尔发现Cglib实行速度会比平时慢10倍，不清楚是什么原因）</p>
<p>所以出于易用性和性能，私以为使用 Cglib 是一个很好的选择（性能和 Javassist 持平，易用性和 Jdk 持平）。</p>
<h2 id="反射调用"><a href="#反射调用" class="headerlink" title="反射调用"></a>反射调用</h2><p>既然提到了动态代理和 cglib ，顺带提一下反射调用如何加速的问题。RPC 框架中在 Provider 服务端需要根据客户端传递来的 className + method + param 来找到容器中的实际方法执行反射调用。除了反射调用外，还可以使用 Cglib 来加速。</p>
<h3 id="JDK反射调用"><a href="#JDK反射调用" class="headerlink" title="JDK反射调用"></a>JDK反射调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Method method = serviceClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">method.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div></pre></td></tr></table></figure>
<h3 id="Cglib调用"><a href="#Cglib调用" class="headerlink" title="Cglib调用"></a>Cglib调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FastClass serviceFastClass = FastClass.create(serviceClass);</div><div class="line">FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">serviceFastMethod.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div></pre></td></tr></table></figure>
<p>但实测效果发现 Cglib 并不一定比 JDK 反射执行速度快，还会跟具体的方法实现有关(大雾)。</p>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>略长…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        BookApi delegate = <span class="keyword">new</span> BookApiImpl();</div><div class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</div><div class="line">        BookApi jdkProxy = createJdkDynamicProxy(delegate);</div><div class="line">        time = System.currentTimeMillis() - time;</div><div class="line">        System.out.println(<span class="string">"Create JDK Proxy: "</span> + time + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        time = System.currentTimeMillis();</div><div class="line">        BookApi cglibProxy = createCglibDynamicProxy(delegate);</div><div class="line">        time = System.currentTimeMillis() - time;</div><div class="line">        System.out.println(<span class="string">"Create CGLIB Proxy: "</span> + time + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        time = System.currentTimeMillis();</div><div class="line">        BookApi javassistBytecodeProxy = createJavassistBytecodeDynamicProxy();</div><div class="line">        time = System.currentTimeMillis() - time;</div><div class="line">        System.out.println(<span class="string">"Create JavassistBytecode Proxy: "</span> + time + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            jdkProxy.sell();<span class="comment">//warm</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</div><div class="line">            jdkProxy.sell();</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"JDK Proxy invoke cost "</span> + (System.currentTimeMillis() - start) + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            cglibProxy.sell();<span class="comment">//warm</span></div><div class="line">        &#125;</div><div class="line">        start = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</div><div class="line">            cglibProxy.sell();</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"CGLIB Proxy invoke cost "</span> + (System.currentTimeMillis() - start) + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            javassistBytecodeProxy.sell();<span class="comment">//warm</span></div><div class="line">        &#125;</div><div class="line">        start = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</div><div class="line">            javassistBytecodeProxy.sell();</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"JavassistBytecode Proxy invoke cost "</span> + (System.currentTimeMillis() - start) + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        Class&lt;?&gt; serviceClass = delegate.getClass();</div><div class="line">        String methodName = <span class="string">"sell"</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            cglibProxy.sell();<span class="comment">//warm</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 执行反射调用</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;<span class="comment">//warm</span></div><div class="line">            Method method = serviceClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">            method.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div><div class="line">        &#125;</div><div class="line">        start = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</div><div class="line">            Method method = serviceClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">            method.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"反射 invoke cost "</span> + (System.currentTimeMillis() - start) + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 使用 CGLib 执行反射调用</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;<span class="comment">//warm</span></div><div class="line">            FastClass serviceFastClass = FastClass.create(serviceClass);</div><div class="line">            FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">            serviceFastMethod.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div><div class="line">        &#125;</div><div class="line">        start = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</div><div class="line">            FastClass serviceFastClass = FastClass.create(serviceClass);</div><div class="line">            FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, <span class="keyword">new</span> Class[]&#123;&#125;);</div><div class="line">            serviceFastMethod.invoke(delegate, <span class="keyword">new</span> Object[]&#123;&#125;);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"CGLIB invoke cost "</span> + (System.currentTimeMillis() - start) + <span class="string">" ms"</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createJdkDynamicProxy</span><span class="params">(<span class="keyword">final</span> BookApi delegate)</span> </span>&#123;</div><div class="line">        BookApi jdkProxy = (BookApi) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),</div><div class="line">                <span class="keyword">new</span> Class[]&#123;BookApi.class&#125;, <span class="keyword">new</span> JdkHandler(delegate));</div><div class="line">        <span class="keyword">return</span> jdkProxy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Object delegate;</div><div class="line"></div><div class="line">        JdkHandler(Object delegate) &#123;</div><div class="line">            <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] objects)</span></span></div><div class="line"><span class="function">                <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">//添加代理逻辑</span></div><div class="line">            <span class="keyword">if</span>(method.getName().equals(<span class="string">"sell"</span>))&#123;</div><div class="line">                System.out.print(<span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="comment">//            return method.invoke(delegate, objects);</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createCglibDynamicProxy</span><span class="params">(<span class="keyword">final</span> BookApi delegate)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> CglibInterceptor(delegate));</div><div class="line">        enhancer.setInterfaces(<span class="keyword">new</span> Class[]&#123;BookApi.class&#125;);</div><div class="line">        BookApi cglibProxy = (BookApi) enhancer.create();</div><div class="line">        <span class="keyword">return</span> cglibProxy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Object delegate;</div><div class="line"></div><div class="line">        CglibInterceptor(Object delegate) &#123;</div><div class="line">            <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, Object[] objects,</span></span></div><div class="line"><span class="function"><span class="params">                                MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">//添加代理逻辑</span></div><div class="line">            <span class="keyword">if</span>(method.getName().equals(<span class="string">"sell"</span>)) &#123;</div><div class="line">                System.out.print(<span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="comment">//            return methodProxy.invoke(delegate, objects);</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BookApi <span class="title">createJavassistBytecodeDynamicProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ClassPool mPool = <span class="keyword">new</span> ClassPool(<span class="keyword">true</span>);</div><div class="line">        CtClass mCtc = mPool.makeClass(BookApi.class.getName() + <span class="string">"JavaassistProxy"</span>);</div><div class="line">        mCtc.addInterface(mPool.get(BookApi.class.getName()));</div><div class="line">        mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line">        mCtc.addMethod(CtNewMethod.make(</div><div class="line">                <span class="string">"public void sell() &#123; System.out.print(\"\") ; &#125;"</span>, mCtc));</div><div class="line">        Class&lt;?&gt; pc = mCtc.toClass();</div><div class="line">        BookApi bytecodeProxy = (BookApi) pc.newInstance();</div><div class="line">        <span class="keyword">return</span> bytecodeProxy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/12/15/rpc-dynamic-proxy/" data-id="cjbbm27r1002phcudlvtfqopk" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/12/15/rpc-dynamic-proxy/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/12/15/rpc-dynamic-proxy/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-rpc-serialize-2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/11/rpc-serialize-2/">深入理解RPC之序列化篇--总结篇</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/11/rpc-serialize-2/">
            <time datetime="2017-12-11T14:58:54.000Z" itemprop="datePublished">2017-12-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/RPC/">RPC</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/RPC/">RPC</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>上一篇<a href="https://www.cnkirito.moe/2017/11/28/kryo-1/" target="_blank" rel="external">《深入理解RPC之序列化篇–Kryo》</a>,介绍了序列化的基础概念，并且详细介绍了Kryo的一系列特性，在这一篇中，简略的介绍其他常用的序列化器，并对它们进行一些比较。序列化篇仅仅由Kryo篇和总结篇构成可能有点突兀，等待后续有时间会补充详细的探讨。</p>
<h2 id="定义抽象接口"><a href="#定义抽象接口" class="headerlink" title="定义抽象接口"></a>定义抽象接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException;</div><div class="line"></div><div class="line">   &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RPC框架中的序列化实现自然是种类多样，但它们必须遵循统一的规范，于是我们使用 <code>Serialization</code> 作为序列化的统一接口，无论何种方案都需要实现该接口。</p>
<h2 id="Kryo实现"><a href="#Kryo实现" class="headerlink" title="Kryo实现"></a>Kryo实现</h2><p>Kryo篇已经给出了实现代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoSerialization</span> <span class="keyword">implements</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) &#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Output output = <span class="keyword">new</span> Output(byteArrayOutputStream);</div><div class="line">        kryo.writeObject(output, obj);</div><div class="line">        output.close();</div><div class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> </span>&#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Input input = <span class="keyword">new</span> Input(byteArrayInputStream);</div><div class="line">        input.close();</div><div class="line">        <span class="keyword">return</span> (T) kryo.readObject(input, clz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryoLocal = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">            kryo.setReferences(<span class="keyword">true</span>);</div><div class="line">            kryo.setRegistrationRequired(<span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> kryo;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所需依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="Hessian实现"><a href="#Hessian实现" class="headerlink" title="Hessian实现"></a>Hessian实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hessian2Serialization</span> <span class="keyword">implements</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object data) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Hessian2Output out = <span class="keyword">new</span> Hessian2Output(bos);</div><div class="line">        out.writeObject(data);</div><div class="line">        out.flush();</div><div class="line">        <span class="keyword">return</span> bos.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Hessian2Input input = <span class="keyword">new</span> Hessian2Input(<span class="keyword">new</span> ByteArrayInputStream(bytes));</div><div class="line">        <span class="keyword">return</span> (T) input.readObject(clz);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所需依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.51<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>大名鼎鼎的 Hessian 序列化方案经常被RPC框架用来作为默认的序列化方案，可见其必然具备一定的优势。其具体的优劣我们放到文末的总结对比中与其他序列化方案一起讨论。而在此，着重提一点Hessian使用时的坑点。</p>
<p><strong>BigDecimal的反序列化</strong></p>
<p>使用 Hessian 序列化包含 BigDecimal 字段的对象时会导致其值一直为0，不注意这个bug会导致很大的问题，在最新的4.0.51版本仍然可以复现。解决方案也很简单，指定 BigDecimal 的序列化器即可，通过添加两个文件解决这个bug：</p>
<p><strong>resources\META-INF\hessian\serializers</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.math.BigDecimal=com.caucho.hessian.io.StringValueSerializer</div></pre></td></tr></table></figure>
<p><strong>resources\META-INF\hessian\deserializers</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.math.BigDecimal=com.caucho.hessian.io.BigDecimalDeserializer</div></pre></td></tr></table></figure>
<h2 id="Protostuff实现"><a href="#Protostuff实现" class="headerlink" title="Protostuff实现"></a>Protostuff实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtostuffSerialization</span> <span class="keyword">implements</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        Class clz = obj.getClass();</div><div class="line">        LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Schema schema = RuntimeSchema.createFrom(clz);</div><div class="line">            <span class="keyword">return</span> ProtostuffIOUtil.toByteArray(obj, schema, buffer);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            buffer.clear();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        T message = objenesis.newInstance(clz); <span class="comment">// &lt;1&gt;</span></div><div class="line">        Schema&lt;T&gt; schema = RuntimeSchema.createFrom(clz);</div><div class="line">        ProtostuffIOUtil.mergeFrom(bytes, message, schema);</div><div class="line">        <span class="keyword">return</span> message;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Objenesis objenesis = <span class="keyword">new</span> ObjenesisStd(); <span class="comment">// &lt;2&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所需依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Protostuff --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyuproject.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- Objenesis --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.objenesis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>objenesis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Protostuff 可以理解为 google protobuf 序列化的升级版本，protostuff-runtime 无需静态编译，这比较适合RPC通信时的特性，很少见到有人直接拿 protobuf  作为RPC的序列化器，而 protostuff-runtime 仍然占据一席之地。</p>
<p><1>  使用 Protostuff 的一个坑点在于其反序列化时需用户自己实例化序列化后的对象，所以才有了 <code>T message = objenesis.newInstance(clz);</code> 这行代码。使用 objenesis 工具实例化一个需要的对象，而后使用 <code>ProtostuffIOUtil</code> 完成赋值操作。</1></p>
<p><2> 上述的 <code>objenesis.newInstance(clz)</code> 可以由 <code>clz.newInstance()</code> 代替，后者也可以实例化一个对象，但如果对象缺少无参构造函数，则会报错。借助于<code>objenesis</code> 可以绕开无参构造器实例化一个对象，且性能优于直接反射创建。所以一般在选择 Protostuff  作为序列化器时，一般配合 objenesis 使用。</2></p>
<h2 id="Fastjson实现"><a href="#Fastjson实现" class="headerlink" title="Fastjson实现"></a>Fastjson实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastJsonSerialization</span> <span class="keyword">implements</span> <span class="title">Serialization</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String charsetName = <span class="string">"UTF-8"</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object data) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        SerializeWriter out = <span class="keyword">new</span> SerializeWriter();</div><div class="line">        JSONSerializer serializer = <span class="keyword">new</span> JSONSerializer(out);</div><div class="line">        serializer.config(SerializerFeature.WriteEnumUsingToString, <span class="keyword">true</span>);<span class="comment">//&lt;1&gt;</span></div><div class="line">        serializer.config(SerializerFeature.WriteClassName, <span class="keyword">true</span>);<span class="comment">//&lt;1&gt;</span></div><div class="line">        serializer.write(data);</div><div class="line">        <span class="keyword">return</span> out.toBytes(charsetName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] data, Class&lt;T&gt; clz)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> JSON.parseObject(<span class="keyword">new</span> String(data), clz);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所需依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><1> JSON序列化注意对枚举类型的特殊处理；额外补充类名可以在反序列化时获得更丰富的信息。</1></p>
<h2 id="序列化对比"><a href="#序列化对比" class="headerlink" title="序列化对比"></a>序列化对比</h2><p>在我的PC上对上述序列化方案进行测试：</p>
<p><strong>测试用例：对一个简单POJO对象序列化/反序列化100W次</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>serialize/ms</th>
<th>deserialize/ms</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fastjson</td>
<td>2832</td>
<td>2242</td>
</tr>
<tr>
<td>Kryo</td>
<td>2975</td>
<td>1987</td>
</tr>
<tr>
<td>Hessian</td>
<td>4598</td>
<td>3631</td>
</tr>
<tr>
<td>Protostuff</td>
<td>2944</td>
<td>2541</td>
</tr>
</tbody>
</table>
<p><strong>测试用例：序列化包含1000个简单对象的List，循环1000次</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>serialize/ms</th>
<th>deserialize/ms</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fastjson</td>
<td>2551</td>
<td>2821</td>
</tr>
<tr>
<td>Kryo</td>
<td>1951</td>
<td>1342</td>
</tr>
<tr>
<td>Hessian</td>
<td>1828</td>
<td>2213</td>
</tr>
<tr>
<td>Protostuff</td>
<td>1409</td>
<td>2813</td>
</tr>
</tbody>
</table>
<p>对于耗时类型的测试需要做到预热+平均值等条件，测试后效果其实并不如人意，从我不太严谨的测试来看，并不能明显地区分出他们的性能。另外，Kryo关闭Reference可以加速，Protostuff支持静态编译加速，Schema缓存等特性，每个序列化方案都有自身的特殊性，启用这些特性会伴随一些限制。但在RPC实际地序列化使用中不会利用到这些特性，所以在测试时并没有特别关照它们。</p>
<p><strong>序列化包含1000个简单对象的List，查看字节数</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>字节数/byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fastjson</td>
<td>120157</td>
</tr>
<tr>
<td>Kryo</td>
<td>39134</td>
</tr>
<tr>
<td>Hessian</td>
<td>86166</td>
</tr>
<tr>
<td>Protostuff</td>
<td>86084</td>
</tr>
</tbody>
</table>
<p>字节数这个指标还是很直观的，Kryo拥有绝对的优势，只有Hessian，Protostuff的一半，而Fastjson作为一个文本类型的序列化方案，自然无法和字节类型的序列化方案比较。而字节最终将用于网络传输，是RPC框架非常在意的一个性能点。</p>
<p><strong>综合评价</strong></p>
<p>经过个人测试，以及一些官方的测试结果，我觉得在 RPC 场景下，序列化的速度并不是一个很大考量标准，因为各个序列化方案都在有意优化速度，只要不是 jdk 序列化，速度就不会太慢。</p>
<p>Kryo：专为 JAVA 定制的序列化协议，序列化后字节数少，利于网络传输。但不支持跨语言（或支持的代价比较大）。dubbox 扩展中支持了 kryo 序列化协议。github 3018 star。</p>
<p>Hessian：支持跨语言，序列化后字节数适中，API 易用。是国内主流 rpc 框架：dubbo，motan 的默认序列化协议。<a href="http://hessian.caucho.com/" target="_blank" rel="external">hessian.caucho.com</a> 未托管在github</p>
<p>Protostuff：提起 Protostuff 不得不说到 Protobuf。Protobuf可能更出名一些，因为其是google的亲儿子，grpc框架便是使用protobuf作为序列化协议，虽然protobuf与语言无关平台无关，但需要使用特定的语法编写 <code>.prpto</code> 文件，然后静态编译，这带了一些复杂性。而 protostuff 实际是对 protobuf 的扩展，protostuff-runtime 模块继承了protobuf 性能，且不需要预编译文件，但与此同时，也失去了跨语言的特性。所以 protostuff 的定位是一个 JAVA 序列化框架，其性能略优于 Hessian。tip ：protostuff 反序列化时需用户自己初始化序列化后的对象，其只负责将该对象进行赋值。github 719 star。</p>
<p>Fastjson：作为一个 json 工具，被拉到 RPC 的序列化方案中似乎有点不妥，但 motan 该 RPC 框架除了支持 hessian 之外，还支持了 fastjson 的序列化。可以将其作为一个跨语言序列化的简易实现方案。github 11.8k star。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/12/11/rpc-serialize-2/" data-id="cjbbm27r1002whcudw3apuzdm" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/12/11/rpc-serialize-2/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/12/11/rpc-serialize-2/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-NJIAS2017" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/06/NJIAS2017/">南京IAS架构师峰会观后感</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/06/NJIAS2017/">
            <time datetime="2017-12-05T17:15:28.000Z" itemprop="datePublished">2017-12-06</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术杂谈/">技术杂谈</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/技术杂谈/">技术杂谈</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p><img src="http://ov0zuistv.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171204230556.gif" alt=""></p>
<p>上周六，周日在南京举办了IAS架构师峰会，这么多人的技术分享会还是头一次参加，大佬云集，涨了不少姿势。特此一篇记录下印象深刻的几场分享。由于全凭记忆叙述，故只能以流水账的形式还原出现场的收获。</p>
<h2 id="大型支付交易平台的演进过程"><a href="#大型支付交易平台的演进过程" class="headerlink" title="大型支付交易平台的演进过程"></a>大型支付交易平台的演进过程</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/%E9%99%88%E6%96%8C.jpg" alt="大型支付交易平台的演进过程">   </p>
<blockquote>
<p>陈斌，《架构即未来》译者，易宝支付CTO。</p>
</blockquote>
<p>交易系统具备以下特点，交易量大，并发度高，业务敏感度高，响应速度容忍度低…从而使得支付交易平台需要有以下的特点：</p>
<ul>
<li>高可用：7X24*365随时可用</li>
<li>高安全：需满足PCI-DSS要求</li>
<li>高效率：每笔交易的成本要低</li>
<li>高扩展：随业务的快速发展扩张</li>
</ul>
<p>从以上几点话题引申出了系统扩展的三个阶段</p>
<p><strong>X轴扩展–扩展机器</strong></p>
<p>也就是通俗意义中集群方案，横向扩展，通过添加多台机器负载均衡，从而扩展计算能力，这是最简单粗暴，也是最直接易用的方案。</p>
<p><strong>Y轴扩展–拆分服务</strong></p>
<p>当水平扩展遇到瓶颈后，可以进行服务的拆分，将系统按照业务模块进行拆分，从而可以选择性定制化地扩展特定的模块。如电商系统中拆分出订单模块，商品模块，会员模块，地址模块…由于各个模块的职责不同，如订单模块在双11时压力很大，可以多部署一些订单模块，而其他压力不大的模块，则进行少量地部署。</p>
<p><strong>Z轴扩展–拆分数据</strong></p>
<p>服务拆分之后仍然无法解决与日俱增的数据量问题，于是引发了第三层扩展，数据的分片，我理解的sharding，不仅仅存在于数据库，还包含了redis，文件等。</p>
<p>另外陈斌老师还聊了一个有意思的话题，系统可用性下降的原因根源是什么？最终他给出的答案是：人。系统升级后引发的事故80%是由于人的误操作或者触发了bug等人为因素导致的，是人就会手抖。借此引出了单元测试，持续集成，持续交付的重要性。健全这三者是保障系统可用性的最大利器。</p>
<p>在技术晚宴，陈斌老师又分享了一些管理经验：<strong>如何打造一支优秀的技术团队</strong>。</p>
<p>分析了构成团队的四要素：</p>
<ul>
<li>人员：健全职级体系，区别考评，挖掘潜能，及时鼓励，扁平化管理</li>
<li>组织：面向产出，利于创新，敏捷小团队</li>
<li>过程：聚集问题的根源，适当地使⽤用ITIL，不断优化过程，自动化取代人工</li>
<li>文化：鼓励分享，打破devops的边界，鼓励创新，树⽴立正确的技术负债观</li>
</ul>
<p>对于技术人员来说可能有点抽象，不过对于立志于要成为CIO的人肯定是大有裨益的，具体的理解可以参考《架构即未来》中的具体阐释。(ps：这里的架构并不是指技术架构，别问我为什么知道，问问我看了一半后在落灰的那本书，你什么都明白了)</p>
<h2 id="轻量级微服务架构实践之路"><a href="#轻量级微服务架构实践之路" class="headerlink" title="轻量级微服务架构实践之路"></a>轻量级微服务架构实践之路</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/%E9%BB%84%E5%8B%87.jpg" alt="轻量级微服务架构实践之路"></p>
<blockquote>
<p>黄勇，特赞科技CTO，《轻量级微服务架构》作者。</p>
</blockquote>
<p>非常具有人格魅力的一位演讲者，这可能是当天最有价值的一场分享。</p>
<p>他首先提出了一个问题：什么是微服务？怎么理解这个’微’字。随后他给出了自己的理解：微=合理。一知半解的微服务实践者可能盲目地拆分服务，微并不是代表颗粒越小越好，用领域驱动的术语来说，微服务模块需要用合适的限界上下文。黄勇老师给出了4个微服务拆分的技巧：</p>
<ol>
<li>业务先行</li>
<li>由粗到细</li>
<li>避免耦合</li>
<li>持续改进</li>
</ol>
<p>非常实用且具有指导意义的4个思想，当你还在犹豫到底该如何拆分你的模块时，可以尝试先从单体式开始开发，业务发展会指引你拆分出合适模块，合适的粒度。当一个个业务被剥离出Monolithic这个怪物，持续重构，持续改进，这样可以指引你深入理解微服务。</p>
<p>随后给出了轻量级微服务架构的技术选型，非常有参考价值。</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1.png" alt="轻量级微服务架构"></p>
<p>其PPT总结了很多经验list，可以在文末链接获取。</p>
<p>顺带一提，没记错的话黄勇老师介绍到其公司的语言栈有：Java，Node，Go，在后面其他老师的分享中集中介绍多语言栈的意义。</p>
<p>《轻量级微服务架构》上下册一起购买，赠送“技能图谱”，感兴趣的朋友可以阅读一下他的书籍。<a href="https://detail.tmall.com/item.htm?id=557228266081" target="_blank" rel="external">购买链接</a> ps:谁让我白得了一本上册呢。</p>
<h2 id="Cloud-Native架构一致性问题及解决方案"><a href="#Cloud-Native架构一致性问题及解决方案" class="headerlink" title="Cloud Native架构一致性问题及解决方案"></a>Cloud Native架构一致性问题及解决方案</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/%E4%B8%80%E8%87%B4%E6%80%A7.jpg" alt="Cloud Native架构一致性问题及解决方案"></p>
<blockquote>
<p>王启军，华为架构部资深架构师。</p>
</blockquote>
<p>王启军老师则是带来了如今微服务架构最难的一个技术点的分享：分布式中的一致性问题。</p>
<p>他的分享中涵盖了很多经典的分布式一致性问题的案例，如两军问题，拜占庭将军问题。引出了经典的CAP理论，NWR，Lease，Replicated state machine，Paxos算法。由于时间问题，45分钟根本无法详细地介绍他们的流程，实属可惜。</p>
<p>一致性问题被分成了两类，包括：</p>
<p><strong>以数据为中心的一致性模型</strong></p>
<ul>
<li>严格一致性</li>
<li>顺序一致性</li>
<li>因果一致性</li>
<li>FIFO一致性</li>
<li>弱一致性</li>
<li>释放一致性</li>
<li>入口一致性</li>
</ul>
<p><strong>以用户为中心的一致性模型</strong></p>
<ul>
<li>单调读一致性</li>
<li>单调写一致性</li>
<li>写后读一致性</li>
<li>读后写一致性</li>
</ul>
<p>这么多一致性分类太过于学术范，所以业界通常将他们简单的归为了三类：</p>
<ul>
<li>弱一致性</li>
<li>最终一致性</li>
<li>强一致性</li>
</ul>
<p>对于各个一致性模型的科普，以及一些事务模型和解决方案如2PC，3PC，TCC型事务，PPT中都给出了简单的介绍。</p>
<h2 id="技术架构演变全景图-从单体式到云原生"><a href="#技术架构演变全景图-从单体式到云原生" class="headerlink" title="技术架构演变全景图-从单体式到云原生"></a>技术架构演变全景图-从单体式到云原生</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/%E5%BC%A0%E4%BA%AE&amp;%E6%9B%B9%E7%A5%96%E9%B9%8F.jpg" alt="技术架构演变全景图-从单体式到云原生"></p>
<blockquote>
<p>千米网首席架构师，曹祖鹏（右） &amp; 当当网首席架构师，张亮（左）。知名开源框架sharding-jdbc，elastic-job作者。</p>
</blockquote>
<p>别开生面的面向对象技术分享。也是我本次大会最期待的一场分享，分享涵盖的知识点很多，深度和广度得兼，其分享中阐释了云原生，服务编排、治理、调度等2017年处于潮流前线的技术热点，通俗易懂地介绍了service mesh的概念，让观众在惊叹于互联网技术变化如此之快的同时，也带来了很多思考。</p>
<p>分享中还对比了Spring Cloud和Dubbo，当当网和千米网的团队都向Dubbo贡献过代码，Spring Cloud又是国内话题最多的框架之一，台下观众对这样的话题自然是非常感兴趣。张亮老师着重介绍了Spring Cloud相关的组件，而曹祖鹏老师重点对比了其与Dubbo的区别。</p>
<p>Spring Cloud的出现同时宣告了Cloud Native云原生的首映，其为微服务的构架带来了一整套初具雏形的解决方案，包含了Zuul网关，Ribbon客户端负载均衡，Eureka服务注册与发现，Hystrix熔断…并且有强大的Spring终端组件支持，活跃的社区，丰富的文档。</p>
<p>随后，介绍了云原生的技术全景图：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E5%9B%BE%E7%89%871.png" alt="技术全景图"></p>
<p>之后，简单解释了治理，编排，调度的概念后，并重点介绍了服务治理，编排相关的技术栈，老牌的nginx，netflix ribbon，zuul等产品，如今风靡的k8s。尤其是介绍到service mesh这一比较新的概念时，分析了服务的治理，编排，调度从应用层转移到基础设施层的趋势，无疑是非常exciting的一件事。如dubbo等rpc框架的服务注册发现依赖于zk，consul，而spring cloud的服务注册发现组件eureka，以及其客户端路由组件ribbon，服务端路由组件zuul等都是从应用层解决了服务的相关问题，而service mesh提供了一个新的思路，从基础设施层解决服务的相关问题：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171206002523.png" alt="service mesh"></p>
<p>如果service mesh的开源产品Linkerd和Lstio能够保持好的势头，配合k8s在运维层的大一统，很有可能带来架构的新格局。与此同时，java一枝独秀的时代即将宣告终结，多语言的优势将会被service mesh发扬光大，使用go编写高并发的模块，使用java编写业务型模块，nodejs打通前端模块，python处理性能要求不高模块提升开发效率…而不用关心多语言交互的问题，这都交由service mesh解决，这几乎是2017最潮流的知识点，没有之一。</p>
<p>（引用一张jimmysong博客中的图片）</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/d21919a64f89d6c722688d8c1951fc58.jpg" alt="云原生演进"></p>
<p>如上图所示，得知Spring Cloud竟然是2015兴起的技术栈时，可能还会有些吃惊，等到可以预见的2018，运维层的技术栈开始向上侵蚀应用层的技术栈，不得不感叹互联网技术的日新月异。</p>
<p>两位老师从可追溯的历史到可预见的未来展现了云原生架构的演进史，着实给小白们好好科普了一番。</p>
<h2 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h2><p>此次技术分享会收获颇丰，不枉我早上5点起来赶高铁去南京了。但还是得吐槽一句，这门票真tl的贵啊，就不能便宜点吗！！！[微笑face]</p>
<p>其他分享者的话题也很有意思，不仅包含了微服务方向，还囊括了人工智能，机器学习，运维，领导力，架构演变，游戏架构等多个方向，笔者选择性的介绍了一些，全部的PPT可以在下方的链接中获得。</p>
<p><a href="https://pan.baidu.com/s/1eSbCu5c" target="_blank" rel="external">https://pan.baidu.com/s/1eSbCu5c</a></p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/12/06/NJIAS2017/" data-id="cjbbm27ov0002hcudsnwo2z47" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/12/06/NJIAS2017/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/12/06/NJIAS2017/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-rpc-serialize-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/28/rpc-serialize-1/">深入理解RPC之序列化篇--Kryo</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/28/rpc-serialize-1/">
            <time datetime="2017-11-28T14:15:28.000Z" itemprop="datePublished">2017-11-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/RPC/">RPC</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/RPC/">RPC</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>一年前，笔者刚刚接触RPC框架，从单体式应用向分布式应用的变革无疑是让人兴奋的，同时也对RPC背后到底做了哪些工作产生了兴趣，但其底层的设计对新手而言并不是很友好，其涉及的一些常用技术点都有一定的门槛。如传输层常常使用的netty，之前完全没听过，想要学习它，需要掌握前置知识点nio；协议层，包括了很多自定义的协议，而每个RPC框架的实现都有差异；代理层的动态代理技术，如jdk动态代理，虽然实战经验不多，但至少还算会用，而cglib则又有一个盲区；序列化层倒还算是众多层次中相对简单的一环，但RPC为了追求可扩展性，性能等诸多因素，通常会支持多种序列化方式以供使用者插拔使用，一些常用的序列化方案hessian，kryo，Protobuf又得熟知…</p>
<p>这个系列打算就RPC框架涉及到的一些知识点进行探讨，本篇先从序列化层的一种选择–kryo开始进行介绍。</p>
<h2 id="序列化概述"><a href="#序列化概述" class="headerlink" title="序列化概述"></a>序列化概述</h2><p>大白话介绍下RPC中序列化的概念，可以简单理解为对象–&gt;字节的过程，同理，反序列化则是相反的过程。为什么需要序列化？因为网络传输只认字节。所以互信的过程依赖于序列化。有人会问，FastJson转换成字符串算不算序列化？对象持久化到数据库算不算序列化？没必要较真，广义上理解即可。</p>
<h2 id="JDK序列化"><a href="#JDK序列化" class="headerlink" title="JDK序列化"></a>JDK序列化</h2><p>可能你没用过kryo，没用过hessian，但你一定用过jdk序列化。我最早接触jdk序列化，是在大二的JAVA大作业中，《XX管理系统》需要把对象保存到文件中（那时还没学数据库），jdk原生支持的序列化方式用起来也很方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;  </div><div class="line">   <span class="keyword">private</span> String name;  </div><div class="line">&#125;  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;  </div><div class="line">      <span class="comment">// create a Student</span></div><div class="line">      Student st = <span class="keyword">new</span> Student(<span class="string">"kirito"</span>);  </div><div class="line">     <span class="comment">// serialize the st to student.db file  </span></div><div class="line">     ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"student.db"</span>));  </div><div class="line">     oos.writeObject(st);  </div><div class="line">     oos.close();  </div><div class="line">     <span class="comment">// deserialize the object from student.db</span></div><div class="line">     ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"student.db"</span>));  </div><div class="line">     Student kirito = (Student) ois.readObject();  </div><div class="line">     ois.close();  </div><div class="line">    <span class="comment">// assert</span></div><div class="line">    <span class="keyword">assert</span> <span class="string">"kirito"</span>.equals(kirito.getName());  </div><div class="line">   &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Student实体类需要实现Serializable接口，以告知其可被序列化。</p>
<p>序列化协议的选择通常有下列一些常用的指标：</p>
<ol>
<li>通用性。是否只能用于java间序列化/反序列化，是否跨语言，跨平台。</li>
<li>性能。分为空间开销和时间开销。序列化后的数据一般用于存储或网络传输，其大小是很重要的一个参数；解析的时间也影响了序列化协议的选择，如今的系统都在追求极致的性能。</li>
<li>可扩展性。系统升级不可避免，某一实体的属性变更，会不会导致反序列化异常，也应该纳入序列化协议的考量范围。</li>
<li>易用性。API使用是否复杂，会影响开发效率。</li>
</ol>
<p>容易用的模型通常性能不好，性能好的模型通常用起来都比较麻烦。显然，JDK序列化属于前者。我们不过多介绍它，直接引入今天的主角kryo作为它的替代品。</p>
<h2 id="Kryo入门"><a href="#Kryo入门" class="headerlink" title="Kryo入门"></a>Kryo入门</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>由于其底层依赖于ASM技术，与Spring等框架可能会发生ASM依赖的版本冲突（文档中表示这个冲突还挺容易出现）所以提供了另外一个依赖以供解决此问题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;  </div><div class="line">   <span class="keyword">private</span> String name;  </div><div class="line">&#125;  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">        Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">        Output output = <span class="keyword">new</span> Output(<span class="keyword">new</span> FileOutputStream(<span class="string">"student.db"</span>));</div><div class="line">        Student kirito = <span class="keyword">new</span> Student(<span class="string">"kirito"</span>);</div><div class="line">        kryo.writeObject(output, kirito);</div><div class="line">        output.close();</div><div class="line">        Input input = <span class="keyword">new</span> Input(<span class="keyword">new</span> FileInputStream(<span class="string">"student.db"</span>));</div><div class="line">        Student kiritoBak = kryo.readObject(input, Student.class);</div><div class="line">        input.close();</div><div class="line">        <span class="keyword">assert</span> <span class="string">"kirito"</span>.equals(kiritoBak.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不需要注释也能理解它的执行流程，和jdk序列化差距并不是很大。</p>
<h3 id="三种读写方式"><a href="#三种读写方式" class="headerlink" title="三种读写方式"></a>三种读写方式</h3><p>Kryo共支持三种读写方式</p>
<ol>
<li>如果知道class字节码，并且对象不为空</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kryo.writeObject(output, someObject);</div><div class="line"><span class="comment">// ...</span></div><div class="line">SomeClass someObject = kryo.readObject(input, SomeClass.class);</div></pre></td></tr></table></figure>
<p>快速入门中的序列化/反序列化的方式便是这一种。而Kryo考虑到someObject可能为null，也会导致返回的结果为null，所以提供了第二套读写方式。</p>
<ol>
<li>如果知道class字节码，并且对象可能为空</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kryo.writeObjectOrNull(output, someObject);</div><div class="line"><span class="comment">// ...</span></div><div class="line">SomeClass someObject = kryo.readObjectOrNull(input, SomeClass.class);</div></pre></td></tr></table></figure>
<p>但这两种方法似乎都不能满足我们的需求，在RPC调用中，序列化和反序列化分布在不同的端点，对象的类型确定，我们不想依赖于手动指定参数，最好是…emmmmm…将字节码的信息直接存放到序列化结果中，在反序列化时自行读取字节码信息。Kryo考虑到了这一点，于是提供了第三种方式。</p>
<ol>
<li>如果实现类的字节码未知，并且对象可能为null</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kryo.writeClassAndObject(output, object);</div><div class="line"><span class="comment">// ...</span></div><div class="line">Object object = kryo.readClassAndObject(input);</div><div class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> SomeClass) &#123;</div><div class="line">   <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们牺牲了一些空间一些性能去存放字节码信息，但这种方式是我们在RPC中应当使用的方式。</p>
<h3 id="我们关心的问题"><a href="#我们关心的问题" class="headerlink" title="我们关心的问题"></a>我们关心的问题</h3><p>继续介绍Kryo特性之前，不妨让我们先思考一下，一个序列化工具或者一个序列化协议，应当需要考虑哪些问题。比如，支持哪些类型的序列化？循环引用会不会出现问题？在某个类增删字段之后反序列化会报错吗？等等等等….</p>
<p>带着我们考虑到的这些疑惑，以及我们暂时没考虑到的，但Kryo帮我们考虑到的，来看看Kryo到底支持哪些特性。</p>
<h3 id="支持的序列化类型"><a href="#支持的序列化类型" class="headerlink" title="支持的序列化类型"></a>支持的序列化类型</h3><table>
<thead>
<tr>
<th>boolean</th>
<th>Boolean</th>
<th>byte</th>
<th>Byte</th>
<th>char</th>
</tr>
</thead>
<tbody>
<tr>
<td>Character</td>
<td>short</td>
<td>Short</td>
<td>int</td>
<td>Integer</td>
</tr>
<tr>
<td>long</td>
<td>Long</td>
<td>float</td>
<td>Float</td>
<td>double</td>
</tr>
<tr>
<td>Double</td>
<td>byte[]</td>
<td>String</td>
<td>BigInteger</td>
<td>BigDecimal</td>
</tr>
<tr>
<td>Collection</td>
<td>Date</td>
<td>Collections.emptyList</td>
<td>Collections.singleton</td>
<td>Map</td>
</tr>
<tr>
<td>StringBuilder</td>
<td>TreeMap</td>
<td>Collections.emptyMap</td>
<td>Collections.emptySet</td>
<td>KryoSerializable</td>
</tr>
<tr>
<td>StringBuffer</td>
<td>Class</td>
<td>Collections.singletonList</td>
<td>Collections.singletonMap</td>
<td>Currency</td>
</tr>
<tr>
<td>Calendar</td>
<td>TimeZone</td>
<td>Enum</td>
<td>EnumSet</td>
</tr>
</tbody>
</table>
<p>表格中支持的类型一览无余，这都是其默认支持的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">kryo.addDefaultSerializer(SomeClass.class, SomeSerializer.class);</div></pre></td></tr></table></figure>
<p>这样的方式，也可以为一个Kryo实例扩展序列化器。</p>
<p>总体而言，Kryo支持以下的类型：</p>
<ul>
<li>枚举</li>
<li>集合、数组</li>
<li>子类/多态</li>
<li>循环引用</li>
<li>内部类</li>
<li>泛型</li>
</ul>
<p>但需要注意的是，<strong>Kryo不支持Bean中增删字段</strong>。如果使用Kryo序列化了一个类，存入了Redis，对类进行了修改，会导致反序列化的异常。</p>
<p>另外需要注意的一点是使用反射创建的一些类序列化的支持。如使用Arrays.asList();创建的List对象，会引起序列化异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.Arrays$ArrayList</div></pre></td></tr></table></figure>
<p>但new ArrayList()创建的List对象则不会，使用时需要注意，可以使用第三方库对Kryo进行序列化类型的扩展。如<a href="https://github.com/magro/kryo-serializers所提供的。" target="_blank" rel="external">https://github.com/magro/kryo-serializers所提供的。</a></p>
<p><strong>不支持包含无参构造器类的反序列化</strong>，尝试反序列化一个不包含无参构造器的类将会得到以下的异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): moe.cnkirito.Xxx</div></pre></td></tr></table></figure>
<p>保证每个类具有无参构造器是应当遵守的编程规范，但实际开发中一些第三库的相关类不包含无参构造，的确是有点麻烦。</p>
<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><p>Kryo是线程不安全的，意味着每当需要序列化和反序列化时都需要实例化一次，或者借助ThreadLocal来维护以保证其线程安全。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryos = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">		Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">		<span class="comment">// configure kryo instance, customize settings</span></div><div class="line">		<span class="keyword">return</span> kryo;</div><div class="line">	&#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Somewhere else, use Kryo</span></div><div class="line">Kryo k = kryos.get();</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="Kryo相关配置参数详解"><a href="#Kryo相关配置参数详解" class="headerlink" title="Kryo相关配置参数详解"></a>Kryo相关配置参数详解</h3><p>每个Kryo实例都可以拥有两个配置参数，这值得被拉出来单独聊一聊。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kryo.setRegistrationRequired(<span class="keyword">false</span>);<span class="comment">//关闭注册行为</span></div><div class="line">kryo.setReferences(<span class="keyword">true</span>);<span class="comment">//支持循环引用</span></div></pre></td></tr></table></figure>
<p>Kryo支持对注册行为，如<code>kryo.register(SomeClazz.class);</code>,这会赋予该Class一个从0开始的编号，但Kryo使用注册行为最大的问题在于，其不保证同一个Class每一次注册的号码想用，这与注册的顺序有关，也就意味着在不同的机器、同一个机器重启前后都有可能拥有不同的编号，这会导致序列化产生问题，所以在分布式项目中，一般关闭注册行为。</p>
<p>第二个注意点在于循环引用，Kryo为了追求高性能，可以关闭循环引用的支持。不过我并不认为关闭它是一件好的选择，大多数情况下，请保持<code>kryo.setReferences(true)</code>。</p>
<h3 id="常用Kryo工具类"><a href="#常用Kryo工具类" class="headerlink" title="常用Kryo工具类"></a>常用Kryo工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoSerializer</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) &#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Output output = <span class="keyword">new</span> Output(byteArrayOutputStream);<span class="comment">//&lt;1&gt;</span></div><div class="line">        kryo.writeClassAndObject(output, obj);<span class="comment">//&lt;2&gt;</span></div><div class="line">        output.close();</div><div class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Input input = <span class="keyword">new</span> Input(byteArrayInputStream);<span class="comment">// &lt;1&gt;</span></div><div class="line">        input.close();</div><div class="line">        <span class="keyword">return</span> (T) kryo.readClassAndObject(input);<span class="comment">//&lt;2&gt;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryoLocal = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;<span class="comment">//&lt;3&gt;</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">            kryo.setReferences(<span class="keyword">true</span>);<span class="comment">//默认值为true,强调作用</span></div><div class="line">            kryo.setRegistrationRequired(<span class="keyword">false</span>);<span class="comment">//默认值为false,强调作用</span></div><div class="line">            <span class="keyword">return</span> kryo;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> Kryo的Input和Output接收一个InputStream和OutputStream，Kryo通常完成字节数组和对象的转换，所以常用的输入输出流实现为ByteArrayInputStream/ByteArrayOutputStream。</1></p>
<p><2> writeClassAndObject和readClassAndObject配对使用在分布式场景下是最常见的，序列化时将字节码存入序列化结果中，便可以在反序列化时不必要传入字节码信息。</2></p>
<p><3> 使用ThreadLocal维护Kryo实例，这样减少了每次使用都实例化一次Kryo的开销又可以保证其线程安全。</3></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://github.com/EsotericSoftware/kryo" target="_blank" rel="external">https://github.com/EsotericSoftware/kryo</a></p>
<p><a href="http://www.cnblogs.com/hntyzgn/p/7122709.html" target="_blank" rel="external">Kryo 使用指南</a></p>
<p><a href="https://kb.cnblogs.com/page/515982/" target="_blank" rel="external">序列化与反序列化</a></p>
<hr>
<p>更多的序列化方案，和RPC其他层次中会涉及到的技术，在后续的文章中进行逐步介绍。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/28/rpc-serialize-1/" data-id="cjbbm27r1002thcud78iysqae" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/28/rpc-serialize-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/28/rpc-serialize-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-view-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/28/view-1/">给初中级JAVA准备的面试题</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/28/view-1/">
            <time datetime="2017-11-28T14:15:28.000Z" itemprop="datePublished">2017-11-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>笔者作为一个今年刚毕业的初级JAVA，根据群里水友的讨论，也结合自己刚毕业时的一些面经，加上近期一点点在公司面试别人的经验，总结了如下的常见面试问题，适用于初级和中级JAVA。</p>
<h2 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h2><ol>
<li>HashMap相关</li>
</ol>
<p>HashMap一直是经典的面试题，所有面试官都喜欢问他，因为它可以牵扯出非常多的知识点，而面试者到底能了解到何种程度，则一定程度反映其综合能力。</p>
<p>细节聊扩容因子LoadFactor=0.75，初始大小InitailCapacity=16</p>
<p>纵向聊其底层实现，数据结构是数组+链表，提到jdk1.8之后对链表节点到达8之后转换为红黑树加分。继续追问的话便是引申出常用的数据结构：队列，栈，树，图。</p>
<p>横向聊线程安全，HashMap为线程不安全，一般问多线程操作会导致其死循环的原因。与线程安全的ConcurrentHashMap对比，又扩展到ConcurrentHashMap的实现。继续追问的话便是引申出线程安全的定义，问一些常用的并发容器，考察面试者对java.util.concurrent包的掌握情况。那么至少可以牵扯出如下的问题：</p>
<ol>
<li>ConcurrentHashMap相关</li>
</ol>
<p>面试者可以先说历史，1.8之前采用分段锁，核心就是一句话：尽量降低同步锁的粒度。1.8之后使用CAS思想代替冗杂的分段锁实现。不出意料，面试者答出CAS之后必定会被追问其思想以及应用，换做我自己的话会有如下思路作答：CAS采用乐观锁思想达到lock free，提一下sun.misc.Unsafe中的native方法，至于CAS的其他应用可以聊一聊Atomic原子类和一些无锁并发框架（如Amino），提到ABA问题加分。</p>
<ol>
<li>线程安全与锁</li>
</ol>
<p>线程安全这个词也是面试的高频词，说完上面的并发容器，回头说一说线程安全的定义，按照周志明大大的话回答私以为是极好的：</p>
<blockquote>
<p>当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替进行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么称这个类是线程安全的</p>
</blockquote>
<p>通常与锁一起出现：除了synchronized之外，还经常被问起的是juc中的Lock接口，其具体实现主要有两种：可重入锁，读写锁。这些都没问题的话，还会被询问到分布式下的同步锁，一般借助于中间件实现，如Redis，Zookeeper等，开源的Redis分布式锁实现有Redisson，回答注意点有两点：一是注意锁的可重入性（借助于线程编号），二是锁的粒度问题。除此之外就是一些juc的常用工具类如：CountdownLatch，CyclicBarrir，信号量</p>
<ol>
<li>线程</li>
</ol>
<p>创建线程有几种方式：这个时候应该毫不犹豫的回答1种。面试官会有些惊讶于你的回答，因为似乎他已经习惯了听到Thread和Runnable2种方式的“标准答案”。其实，仔细审题会发现，java创建线程只有一种方式：Thread。Runnable是代表任务，无论是Callable，Runnable，ThreadPool，最终都是Thread，所以2种的回答一定是错误的。</p>
<ol>
<li>设计模式</li>
</ol>
<p>如经典的单利模式。当被问到单例模式时，私以为在有准备的前提下，回答使用双检锁的方式实现可以很好地诱导面试官。双检锁实现线程安全的单利模式有两块注意点：1锁的粒度问题 2 静态变量需要被volatile修饰。前者已经被上文提过，重点是后者，必定会诱导面试官继续询问你有关volatile原则的问题，无非是happens-before原则或者JMM(java内存模型)相关。前者只需要熟记几条关键性的原则即可，而后者回答的重点便是需要提到主存与工作内存的关系。</p>
<p>工厂模式，观察者模式，模板方法模式，策略模式，职责链模式等等，通常会结合Spring和UML类图提问。</p>
<ol>
<li>JVM相关</li>
</ol>
<p>说实话，我自己对JVM的掌握几乎完全来自于《深入理解java虚拟机》，加上一点点线上的经验。初级岗位常问的问题也是固定的那么几个。</p>
<p>内存分区：主要就是堆和栈，严谨点回答可以答方法区，虚拟机栈，本地方法栈，堆，程序计数器。聊一聊Hotspot在jdk1.7中将常量池移到了堆中，jdk1.8移除永久代用MetaSpace代替起码可以佐证：你喜欢在一些JAVA群里面吹水。</p>
<p>垃圾回收算法：新生代由于对象朝生夕死使用标记-清除(or标记-整理)算法，老年代生命力强使用复制算法。提到一句分代收集即可。</p>
<p>垃圾回收器一两个名字还是得叫的上来：Serial，Parallel，CMS，G1…</p>
<p>如何判断一个对象可以被回收：引用计数（可以提到Netty中的使用案例），可达性分析（JVM使用）</p>
<ol>
<li>IO相关</li>
</ol>
<p>bio，nio区别要熟知，了解nio中的ByteBuffer，Selector，Channel可以帮助面试者度过不少难关。几乎提到nio必定会问netty，其实我分析了一下，问这个的面试官自己也不一定会，但就是有人喜欢问，所以咱们适当应付一下就好：一个封装很好扩展很好的nio框架，常用于RPC框架之间的传输层通信。</p>
<ol>
<li>反射</li>
</ol>
<p>聊一聊你对JAVA中反射的理解：运行时操作一个类的神器，可以获取构造器，方法，成员变量，参数化类型…使用案例如Hibernate，BeanUtils。</p>
<ol>
<li>动态代理</li>
</ol>
<p>jdk动态代理和cglib动态代理的区别：前者需要实现一个接口，后者不需要；前者依赖于jdk提供的InvocationHandler，后者依赖于字节码技术；前者我还能写一些代码，后者完全不会。大概就这些差别了。</p>
<h2 id="开源框架"><a href="#开源框架" class="headerlink" title="开源框架"></a>开源框架</h2><h3 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h3><p>我没看过源码，除了老生常谈的双亲委托类加载机制，似乎只能问一些相关参数了。</p>
<h3 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h3><p>在我不长的面试官生涯中，比较烦的一件事便是：当我还没问全：“聊一聊你对Spring的理解”这句话时，部分面试者的脸上已经浮现出了笑容，并迫不及待的回答：AOP和IOC。这本无可厚非，但一旦这成了条件反射式的回答，便违背了面试的初衷。</p>
<p>在面试中，Spring从狭义上可以被理解成Spring Framework&amp;SpringMVC。而广义上包含了Spring众多的开源项目，如果面试者连spring.io都没有访问过，私以为是不应该的扣分项。</p>
<p>Spring常见的问题包括：Spring Bean的scope取值，BeanFactory的地位，@Transactionl相关（传播机制和隔离级别），SpringMVC工作流程</p>
<h3 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h3><p>SpringBoot是当今最火的框架之一了，其starter模块自动配置的思想是面试中经常被问到的。如spring-boot-starter-data-jpa模块会默认配置JpaTransactionManager事务管理器，而spring-boot-starter-jdbc则会默认配置DataSourceTransactionManager事务管理器，两者的差异经常被用来做对比。@ConditionalOnMissingBean，@ConditionalOnBean等注解作用也需要被掌握。</p>
<h3 id="JPA-amp-Hibernate"><a href="#JPA-amp-Hibernate" class="headerlink" title="JPA&amp;Hibernate"></a>JPA&amp;Hibernate</h3><p>ORM的思想</p>
<p>懒加载如何配置以及意义</p>
<p>级联如何配置，什么时候应该使用级联</p>
<p>一级缓存：Session级别的缓存</p>
<p>@Version的使用：数据库的乐观锁</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>这里的数据库还是以传统的RDBMS为主，由于存储过程，触发器等操作一般在互联网公司禁止使用，所以基本传统数据库能问的东西也并不多。</p>
<ol>
<li>索引的分类有哪些？面试者可以尝试自己分类回答。索引和唯一索引；聚集索引和非聚集索引；数据结构可以分为Hash和B+树索引；单列索引和联合索引。常见的索引问题还包括（A,B,C）的联合索引，查询(B,C)时会不会走索引等一些数据库的小细节。</li>
<li>事务ACID的描述和隔离级别。</li>
<li>mysql的explain查询分析也是面试的重点对象，一条分析结果的查询时间，影响行数，走了哪些索引都是分析的依据。</li>
<li>如果面试官问到存储引擎，说实话也有点为了面试而面试的感觉，掌握基本的InnoDB和Myisam的区别即可。</li>
<li>互联网公司可能会比较关心面试者对分库分表的掌握：mysql自带的sharding为什么一般不使用？中间件级别和驱动级别的分库分表，sharding-jdbc，cobar，mycat等开源组件的使用，分布式ID和分库键的选择也备受面试官的青睐。</li>
</ol>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>这个的确很热，这年头不熟悉Redis真不好意思说自己是干互联网的。</p>
<ol>
<li>Redis的常用数据结构，这不用赘述了。</li>
<li>Redis的持久化策略。了解RDB和AOF的使用场景即可。</li>
<li>Redis的发布订阅。</li>
<li>列举Redis的使用场景。这个可以自由发挥，除了主要功能缓存之外，还包括session共享，基于Redis的分布式锁，简易的消息队列等。</li>
<li>了解Redis的集群和哨兵机制。</li>
<li>高级话题包括：缓存雪崩，缓存失效，缓存穿透，预热等。</li>
</ol>
<h3 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h3><p>至少掌握一种常用的消息队列中间件：RabbitMQ，ActiveMQ，RocketMQ，Kafka，了解MQ解耦，提高吞吐量，平滑处理消息的主要思想。常见的面试问题包括如下几点：</p>
<ol>
<li>列举MQ在项目中的使用场景</li>
<li>消息的可靠投递。每当要发生不可靠的操作（如RPC远程调用之前或者本地事务之中），保证消息的落地，然后同步发送。当失败或者不知道成功失败（比如超时）时，消息状态是待发送，定时任务轮询待发送消息表，最终一定可以送达。同时消费端保证幂等。也有朋友告诉过我RocketMQ中事务消息的概念，不过没有深入研究。</li>
<li>消息的ACK机制。如较为常用的事务机制和客户端ACK。</li>
<li>DLQ的设计。</li>
</ol>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><ol>
<li>解释反向代理。</li>
<li>常用的负载均衡算法。掌握ip_hash ，轮询，weight，fair即可。</li>
<li>配置动静分离。</li>
</ol>
<h3 id="RPC框架"><a href="#RPC框架" class="headerlink" title="RPC框架"></a>RPC框架</h3><p>Dubbo，Motan等主流rpc框架的设计思想也是面试中宠儿。</p>
<ol>
<li>说一说RPC的原理？可初步回答动态代理+网络通信，进一步补充RPC的主要分层：协议层，序列化层，通信层，代理层。每一层拉出来都可以被问很久：如序列化方式的选择，通信层的选择等。</li>
<li>注册中心的作用和选择。Zookeeper，Consul，Eureka等注册中心完成了什么工作，以及他们的对比。</li>
<li>netty相关的提问。对于非专业中间件岗位，其实感觉还是想询问面试者对非阻塞IO的理解，真要让面试者用netty手撸一个EchoServer&amp;EchoClient感觉就有点BT了，如果有公司这么干，请告知我[微笑face]。</li>
</ol>
<h3 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h3><p>就我所了解的情况，国内SpringCloud的普及程度还不是很高，但是SpringCloud的相关组件会被部分引用，这倒是很常见，所以简历中出现SpringCloud也会是一个初级JAVA的亮点。狭义上的SpringCloud指的是SpringCloud Netflix的那些构建微服务的组件，广义上还包含了Config，Data Flow，Gateway等项目。</p>
<ol>
<li>Feign，Ribbon，Eureka，Zuul的使用。了解各个组件的作用，会问一些常遇到的问题如Feign的重试机制，Eureka的保护机制，Zuul的路由机制等。</li>
<li>Spring Cloud使用的restful http通信与RPC通信的对比。毕竟…这是一个经久不衰的辩题，可以从耦合性，通信性能，异构系统的互信等角度对比。</li>
</ol>
<h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><ol>
<li>CAP和BASE原理。了解CAP只能同时保证两个的结论，以及CP和AP的选择依据。了解BASE的最终一致性原理。</li>
<li>重试和幂等性。如在支付场景中的异步支付回调，内外部系统对接保证一致性通常采取的保障手段。</li>
<li>分布式链路跟踪。Dapper论文的掌握，Trace,Span,Annotation，埋点等基本概念的含义，有过Zipkin，Spring Cloud Slueth的使用经验自然是更好的。</li>
<li>分布式事务。虽然我认为这本身并不是一种值得提倡的东西，出现分布式事务应当考虑一下你的限界上下文划分的是否合理。那既然有人会问，或许也有他的道理，可以尝试了解二阶段提交，三阶段提交，Paxos。</li>
<li>一致性Hash。抓住一致性hash环和虚拟节点两个关键点作答即可。</li>
<li>熔断、降级。两者的对比，以及分布式中为何两者地位很重要。</li>
<li>谷歌的三驾马车：分布式文件系统（如开源实现HDFS），分布式存储系统（如开源实现HBASE），分布式计算框架（Map-Reduce模型）。市面上绝大多数的海量数据问题，最终都是在考着三个东西。典型问题：2个1T的文本文件存储着URL，筛选出其中相同的URL。海量文件的word count…</li>
</ol>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><ol>
<li>常用指令cd(进入)，ls(列表显示)，rm -f /*(优化系统)这些指令当然是必须会的</li>
<li>Linux中的CoreUtils相关问题。如linux下对文本进行排序并取前十个这些面试题 sort xx.txt | tail -n 10，基本都是在围绕其在设计。</li>
<li>常用脚本的书写</li>
<li>高级话题：Linux下的IO模型，epoll和poll的区别等。</li>
</ol>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>通常考的算法题会是一些较为简单的算法或者经典算法。ACM经验会让你如鱼得水。</p>
<p>复杂度的概念，二分查找，快排的实现，一些贪心算法，DP，数据结构，树和图论，位操作，字符串。</p>
<p>总的来说不会很难，要么是考验思维的算法，要么是可以直接套用经典算法的模板，主要是考研面试者的算法思维，毕竟不是算法岗。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>业务场景的设计。诸如让你设计一个抢红包的流程，做一个秒杀的系统等等，重点考察的是一个面试者综合考虑问题的能力。</li>
<li>你项目中最有挑战的一个技术点。</li>
<li>HTTP协议，TCP/IP协议</li>
<li>容器技术Docker，k8s。这一块笔者没接触，不妄加讨论。</li>
</ol>
<h3 id="HR"><a href="#HR" class="headerlink" title="HR"></a>HR</h3><ol>
<li>你的职业规划是什么？emmmmm</li>
<li>期望薪资。别不好意思，你自己能拿多少心里没有点B+树吗！</li>
<li>你有没有女朋友？喵喵喵？</li>
</ol>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/28/view-1/" data-id="cjbbm27rw0046hcudyoen2lj9" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/28/view-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/28/view-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-orika" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/15/orika/">打开orika的正确方式</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/15/orika/">
            <time datetime="2017-11-15T11:09:57.000Z" itemprop="datePublished">2017-11-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><h3 id="架构分层"><a href="#架构分层" class="headerlink" title="架构分层"></a>架构分层</h3><p>开发分布式的项目时，DO持久化对象和DTO传输对象的转换是不可避免的。集中式项目中，DO-DAO-SERVICE-WEB的分层再寻常不过，但分布式架构（或微服务架构）需要拆分模块时，不得不思考一个问题：WEB层能不能出现DAO或者DO对象？我给出的答案是否定的。</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/52029421305_2.gif" alt="新的项目分层结构"></p>
<p>这张图曾出现在我过去的文章中，其强调了一个分层的要素：服务层(应用层)和表现层应当解耦，后者不应当触碰到任何持久化对象，其所有的数据来源，均应当由前者提供。</p>
<h3 id="DTO的位置"><a href="#DTO的位置" class="headerlink" title="DTO的位置"></a>DTO的位置</h3><p>就系统的某一个模块，可以大致分成领域层model，接口定义层api，接口实现层/服务层service，表现层web。</p>
<ul>
<li>service 依赖 model +  api </li>
<li>web 依赖 api</li>
</ul>
<p>在我们系统构建初期，DTO对象被想当然的丢到了model层，这导致web对model产生了依赖；而在后期，为了满足前面的架构分层，最终将DTO对象移动到了api层（没有单独做一层）</p>
<h3 id="没有DTO时的痛点"><a href="#没有DTO时的痛点" class="headerlink" title="没有DTO时的痛点"></a>没有DTO时的痛点</h3><p>激发出DTO这样一个新的分层其实还有两个原因。</p>
<p>其一，便是我们再也不能忍受在RPC调用时JPA/hibernate懒加载这一特性带来的坑点。如果试图在消费端获取服务端传来的一个懒加载持久化对象，那么很抱歉，下意识就会发现这行不通，懒加载技术本质是使用字节码技术完成对象的代理，然而代理对象无法天然地远程传输，这与你的协议（RPC or HTTP）无关。</p>
<p>其二，远程调用需要额外注意网络传输的开销，如果生产者方从数据库加载出了一个一对多的依赖，而消费者只需要一这个实体的某个属性，多的实体会使得性能产生下降，并没有很好的方式对其进行控制（忽略手动set）。可能有更多痛点，由此可见，共享持久层，缺少DTO层时，我们的系统灵活性和性能都受到了制约。</p>
<h2 id="从DTO到Orika"><a href="#从DTO到Orika" class="headerlink" title="从DTO到Orika"></a>从DTO到Orika</h2><p>各类博客不乏对DTO的讨论，对领域驱动的理解，但却鲜有文章介绍，如何完成DO对象到DTO对象的转换。我们期待有一款高性能的，易用的工具来帮助我们完成实体类的转换。便引出了今天的主角：Orika。</p>
<h3 id="Orika是什么？"><a href="#Orika是什么？" class="headerlink" title="Orika是什么？"></a>Orika是什么？</h3><blockquote>
<p>Orika是一个简单、快速的JavaBean拷贝框架，它能够递归地将数据从一个JavaBean复制到另一个JavaBean，这在多层应用开发中是非常有用的。</p>
</blockquote>
<h3 id="Orika的竞品"><a href="#Orika的竞品" class="headerlink" title="Orika的竞品"></a>Orika的竞品</h3><p>相信大多数朋友接触过apache的BeanUtils，直到认识了spring的BeanUtils，前者被后者完爆，后来又出现了Dozer，Orika等重量级的Bean拷贝工具，在性能和特性上都有了很大的提升。</p>
<p>先给结论，众多Bean拷贝工具中，今天介绍的Orika具有想当大的优势。口说无凭，可参考下面文章中的各个工具的对比：<a href="http://tech.dianwoda.com/2017/11/04/gao-xing-neng-te-xing-feng-fu-de-beanying-she-gong-ju-orika/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">http://tech.dianwoda.com/2017/11/04/gao-xing-neng-te-xing-feng-fu-de-beanying-she-gong-ju-orika/?utm_source=tuicool&amp;utm_medium=referral</a> </p>
<p>简单整理后，如下所示：</p>
<ul>
<li><strong>BeanUtils</strong></li>
</ul>
<p>apache的<code>BeanUtils</code>和spring的<code>BeanUtils</code>中拷贝方法的原理都是先用jdk中 <code>java.beans.Introspector</code>类的<code>getBeanInfo()</code>方法获取对象的属性信息及属性get/set方法，接着使用反射（<code>Method</code>的<code>invoke(Object obj, Object... args)</code>）方法进行赋值。apache支持名称相同但类型不同的属性的转换，spring支持忽略某些属性不进行映射，他们都设置了缓存保存已解析过的<code>BeanInfo</code>信息。</p>
<ul>
<li><strong>BeanCopier</strong></li>
</ul>
<p>cglib的<code>BeanCopier</code>采用了不同的方法：它不是利用反射对属性进行赋值，而是直接使用ASM的<code>MethodVisitor</code>直接编写各属性的<code>get/set</code>方法（具体过程可见<code>BeanCopier</code>类的<code>generateClass(ClassVisitor v)</code>方法）生成class文件，然后进行执行。由于是直接生成字节码执行，所以<code>BeanCopier</code>的性能较采用反射的<code>BeanUtils</code>有较大提高，这一点可在后面的测试中看出。</p>
<ul>
<li><strong>Dozer</strong></li>
</ul>
<p>使用以上类库虽然可以不用手动编写<code>get/set</code>方法，但是他们都不能对不同名称的对象属性进行映射。在定制化的属性映射方面做得比较好的有<a href="http://note.youdao.com/" target="_blank" rel="external">Dozer</a>，Dozer支持简单属性映射、复杂类型映射、双向映射、隐式映射以及递归映射。可使用xml或者注解进行映射的配置，支持自动类型转换，使用方便。但Dozer底层是使用reflect包下<code>Field</code>类的<code>set(Object obj, Object value)</code>方法进行属性赋值，执行速度上不是那么理想。</p>
<ul>
<li><strong>Orika</strong></li>
</ul>
<p>那么有没有特性丰富，速度又快的Bean映射工具呢，这就是下面要介绍的<a href="http://note.youdao.com/" target="_blank" rel="external">Orika</a>，Orika是近期在github活跃的项目，底层采用了javassist类库生成Bean映射的字节码，之后直接加载执行生成的字节码文件，因此在速度上比使用反射进行赋值会快很多，下面详细介绍Orika的使用方法。</p>
<h2 id="Orika入门"><a href="#Orika入门" class="headerlink" title="Orika入门"></a>Orika入门</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ma.glasnost.orika<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>orika-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;orika.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><ul>
<li><strong>MapperFactory</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div></pre></td></tr></table></figure>
<p>MapperFactory用于注册字段映射，配置转换器，自定义映射器等，而我们关注的主要是字段映射这个特性，在下面的小节中会介绍。</p>
<ul>
<li><strong>MapperFacade</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MapperFacade mapper = mapperFactory.getMapperFacade();</div><div class="line">PersonSource source = <span class="keyword">new</span> PersonSource();</div><div class="line">PersonDest destination = mapper.map(source, PersonDest.class);</div></pre></td></tr></table></figure>
<p>MapperFacade和spring，apache中的BeanUtils具有相同的地位，负责对象间的映射，也是实际使用中，我们使用的最多的类。</p>
<p>至于转换器，自定义映射器等等概念，属于Orika的高级特性，也是Orika为什么被称作一个重量级框架的原因，引入Orika的初衷是为了高性能，易用的拷贝对象，引入它们会给系统带来一定的侵入性，所以本文暂不介绍，详细的介绍，可参考官方文档：<a href="http://orika-mapper.github.io/orika-docs/intro.html" target="_blank" rel="external">http://orika-mapper.github.io/orika-docs/intro.html</a></p>
<h3 id="映射字段名完全相同的对象"><a href="#映射字段名完全相同的对象" class="headerlink" title="映射字段名完全相同的对象"></a>映射字段名完全相同的对象</h3><p>如果DO对象和DTO对象的命名遵守一定的规范，那无疑会减少我们很大的工作量。那么，规范是怎么样的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  List&lt;Address&gt; addresses; <span class="comment">// &lt;1&gt;</span></div><div class="line">  <span class="comment">// getters/setters omitted</span></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonDto</span> </span>&#123; </div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  List&lt;AddressDto&gt; addresses; <span class="comment">// &lt;1&gt;</span></div><div class="line">  <span class="comment">// getters/setters omitted</span></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddressDto</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本字段类型自不用说，关键是打上<1>标签的地方，按照通常的习惯，<code>List&lt;AddressDto&gt;</code>变量名会被命名为addressDtos，但我更加推荐与DO对象统一命名，命名为addresses。这样Orika在映射时便可以自动映射两者。</1></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">Person person = <span class="keyword">new</span> Person();</div><div class="line"><span class="comment">//一顿赋值</span></div><div class="line">PersonDto personDto = mapperFactory.getMapperFacade().map(person, PersonDto.class);</div></pre></td></tr></table></figure>
<p>这样便完成了两个对象之间的拷贝，你可能会思考：需要我们指定两个类的映射关系吗？集合可以自动映射吗？这一切Orika都帮助我们完成了，在默认行为下，只要类的字段名相同，Orika便会尽自己最大的努力帮助我们映射。</p>
<h3 id="映射字段名不一致的对象"><a href="#映射字段名不一致的对象" class="headerlink" title="映射字段名不一致的对象"></a>映射字段名不一致的对象</h3><p>我对于DTO的理解是：DTO应当尽可能与DO的字段保持一致，不增不减不改，但可能出于一些特殊原因，需要映射两个名称不同的字段，Orika当然也支持这样常见的需求。只需要在MapperFactory中事先注册便可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line">  <span class="keyword">private</span> Name name;</div><div class="line">  <span class="keyword">private</span> List&lt;Name&gt; knownAliases;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Name</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String first;</div><div class="line">  <span class="keyword">private</span> String last; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonDto</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String personId;</div><div class="line">  <span class="keyword">private</span> String firstName;</div><div class="line">  <span class="keyword">private</span> String lastName;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  <span class="keyword">private</span> String[][] aliases;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成上述两个结构不甚相似的对象时，则需要我们额外做一些工作，剩下的便和之前一致了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">factory.classMap(Person.class, PersonDto.class) <span class="comment">// &lt;2&gt;</span></div><div class="line">      .field(<span class="string">"id"</span>,<span class="string">"personId"</span>)</div><div class="line">      .field(<span class="string">"name.first"</span>, <span class="string">"firstName"</span>)</div><div class="line">      .field(<span class="string">"name.last"</span>, <span class="string">"lastName"</span>)</div><div class="line">      .field(<span class="string">"knownAliases&#123;first&#125;"</span>, <span class="string">"aliases&#123;[0]&#125;"</span>)</div><div class="line">      .field(<span class="string">"knownAliases&#123;last&#125;"</span>, <span class="string">"aliases&#123;[1]&#125;"</span>)</div><div class="line">      .byDefault() <span class="comment">//&lt;1&gt;</span></div><div class="line">      .register();</div></pre></td></tr></table></figure>
<p>这些<code>.{}[]</code>这些略微有点复杂的表达式不需要被掌握，只是想表明：如果你有这样需求，Orika也能支持。上述连续点的行为被称为 fluent-style ，这再不少框架中有体现。</p>
<p><1> 注意byDefault()这个方法，在指定了classMap行为之后，相同字段互相映射这样的默认行为需要调用一次这个方法，才能被继承。</1></p>
<p><2> classMap()方法返回了一个ClassMapBuilder对象，如上所示，我们见识到了它的field(),byDefault(),register()方法，这个建造者指定了对象映射的众多行为，还包括几个其他有用的方法：</2></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">classMapBuilder.field(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//Person和PersonDto的双向映射</span></div><div class="line">classMapBuilder.fieldAToB(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//单向映射  </span></div><div class="line">classMapBuilder.fieldBToA(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//单向映射</span></div><div class="line">classMapBuilder.exclude(<span class="string">"a"</span>);<span class="comment">//移除指定的字段映射，即使字段名相同也不会拷贝</span></div><div class="line">classMapBuilder.field(<span class="string">"a"</span>,<span class="string">"b"</span>).mapNulls(<span class="keyword">false</span>).mapNullsInReverse(<span class="keyword">false</span>);<span class="comment">//是否拷贝空属性，默认是true</span></div></pre></td></tr></table></figure>
<p>更多的API可以参见源码</p>
<h3 id="集合映射"><a href="#集合映射" class="headerlink" title="集合映射"></a>集合映射</h3><p>在类中我们之前已经见识过了List<address>与List<addressdto>的映射。如果根对象就是一个集合，List<person> 映射为 List<persondto>也是很常见的需求，这也很方便：</persondto></person></addressdto></address></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">List&lt;PersonDto&gt; personDtos = mapperFactory.getMapperFacade().mapAsList(persons, PersonDto.class);</div></pre></td></tr></table></figure>
<h3 id="递归映射"><a href="#递归映射" class="headerlink" title="递归映射"></a>递归映射</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> B b;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> C c;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> D d;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Orika默认支持递归映射。</p>
<h3 id="泛型映射"><a href="#泛型映射" class="headerlink" title="泛型映射"></a>泛型映射</h3><p>对泛型的支持是Orika的另一强大功能，这点在文档中只是被提及，网上并没有找到任何一个例子，所以在此我想稍微着重的介绍一下。既然文档没有相关的介绍，那如何了解Orika是怎样支持泛型映射的呢？只能翻出Orika的源码，在其丰富的测试用例中，可以窥见其对各种泛型特性的支持：<a href="https://github.com/orika-mapper/orika/tree/master/tests/src/main/java/ma/glasnost/orika/test/generics" target="_blank" rel="external">https://github.com/orika-mapper/orika/tree/master/tests/src/main/java/ma/glasnost/orika/test/generics</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseDto</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当出现泛型时，按照前面的思路去拷贝，看看结果会如何，泛型示例1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest1</span><span class="params">()</span></span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;String&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    response.setData(<span class="string">"test generic"</span>);</div><div class="line">    ResponseDto&lt;String&gt; responseDto = mapperFactory.getMapperFacade().map(response, ResponseDto.class);<span class="comment">// *</span></div><div class="line">    Assert.assertFalse(<span class="string">"test generic"</span>.equals(responseDto.getData()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会发现responseDto并不会Copy成功吗，特别是在*处，你会发现无所适从，没办法把ResponseDto<string>传递进去 ，同样的，还有下面的泛型示例2</string></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest2</span><span class="params">()</span></span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;Person&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    person.setName(<span class="string">"test generic"</span>);</div><div class="line">    response.setData(person);</div><div class="line">    Response&lt;PersonDto&gt; responseDto = mapperFactory.getMapperFacade().map(response, Response.class);</div><div class="line">    Assert.assertFalse(responseDto.getData() <span class="keyword">instanceof</span> PersonDto);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Response中的String和PersonDto在运行时(Runtime)泛型擦除这一特性难住了不少人，那么，Orika如何解决泛型映射呢？</p>
<p>我们可以发现MapperFacade的具有一系列的重载方法，对各种类型的泛型拷贝进行支持</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171117093043.png" alt="泛型支持"></p>
<p>可以看到几乎每个方法都传入了一个Type，用于获取拷贝类的真实类型，而不是传入.class字节码，下面介绍正确的打开姿势：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest1</span><span class="params">()</span> </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;String&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    response.setData(<span class="string">"test generic"</span>);</div><div class="line">    Type&lt;Response&lt;String&gt;&gt; fromType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;String&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Type&lt;ResponseDto&lt;String&gt;&gt; toType = <span class="keyword">new</span> TypeBuilder&lt;ResponseDto&lt;String&gt;&gt;() &#123;&#125;.build();</div><div class="line">    ResponseDto&lt;String&gt; responseDto = mapperFactory.getMapperFacade().map(response, fromType, toType);</div><div class="line">    Assert.assertTrue(<span class="string">"test generic"</span>.equals(responseDto.getData()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest2</span><span class="params">()</span> </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;Person&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    person.setName(<span class="string">"test generic"</span>);</div><div class="line">    response.setData(person);</div><div class="line">    Type&lt;Response&lt;Person&gt;&gt; fromType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;Person&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Type&lt;Response&lt;PersonDto&gt;&gt; toType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;PersonDto&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Response&lt;PersonDto&gt; responseDto = mapperFactory.getMapperFacade().map(response, fromType, toType);</div><div class="line">    Assert.assertEquals(<span class="string">"test generic"</span> , responseDto.getData().getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="浅拷贝or深拷贝"><a href="#浅拷贝or深拷贝" class="headerlink" title="浅拷贝or深拷贝"></a>浅拷贝or深拷贝</h3><p>虽然不值得一提，但职业敏感度还是催使我们想要测试一下，Orika是深拷贝还是浅拷贝，毕竟浅拷贝有时候会出现一些意想不到的坑点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deepCloneTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    Address address = <span class="keyword">new</span> Address();</div><div class="line">    person.setAddress(address);</div><div class="line">    PersonDto personDto = mapperFactory.getMapperFacade().map(person, PersonDto.class);</div><div class="line">    Assert.assertFalse(personDto.getAddress().hashCode() == person.getAddress().hashCode());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结论：在使用Orika时可以放心，其实现的是深拷贝，不用担心原始类和克隆类指向同一个对象的问题。</p>
<h3 id="更多的特性？"><a href="#更多的特性？" class="headerlink" title="更多的特性？"></a>更多的特性？</h3><p>你如果关心Orika是否能完成你某项特殊的需求，在这里可能会对你有所帮助：<a href="http://orika-mapper.github.io/orika-docs/faq.html" target="_blank" rel="external">http://orika-mapper.github.io/orika-docs/faq.html</a></p>
<p>怎么样，你是不是还在使用BeanUtils呢？尝试一下Orika吧！</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/15/orika/" data-id="cjbbm27ql0025hcud17lu8tx6" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/15/orika/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/15/orika/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spi" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/09/spi/">JAVA拾遗--关于SPI机制</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/09/spi/">
            <time datetime="2017-11-09T08:18:51.000Z" itemprop="datePublished">2017-11-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>JDK提供的SPI(Service Provider Interface)机制，可能很多人不太熟悉，因为这个机制是针对厂商或者插件的，也可以在一些框架的扩展中看到。其核心类<code>java.util.ServiceLoader</code>可以在<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html" target="_blank" rel="external">jdk1.8</a>的文档中看到详细的介绍。虽然不太常见，但并不代表它不常用，恰恰相反，你无时无刻不在用它。玄乎了，莫急，思考一下你的项目中是否有用到第三方日志包，是否有用到数据库驱动？其实这些都和SPI有关。再来思考一下，现代的框架是如何加载日志依赖，加载数据库驱动的，你可能会对class.forName(“com.mysql.jdbc.Driver”)这段代码不陌生，这是每个java初学者必定遇到过的，但如今的数据库驱动仍然是这样加载的吗？你还能找到这段代码吗？这一切的疑问，将在本篇文章结束后得到解答。</p>
<p>首先介绍SPI机制是个什么东西</p>
<h2 id="实现一个自定义的SPI"><a href="#实现一个自定义的SPI" class="headerlink" title="实现一个自定义的SPI"></a>实现一个自定义的SPI</h2><h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1 项目结构"></a>1 项目结构</h3><p><img src="http://ov0zuistv.bkt.clouddn.com/spi_%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="SPI项目结构"></p>
<ol>
<li>invoker是我们的用来测试的主项目。</li>
<li>interface是针对厂商和插件商定义的接口项目，只提供接口，不提供实现。</li>
<li>good-printer,bad-printer分别是两个厂商对interface的不同实现，所以他们会依赖于interface项目。</li>
</ol>
<p>这个简单的demo就是让大家体验，在不改变invoker代码，只更改依赖的前提下，切换interface的实现厂商。</p>
<h3 id="2-interface模块"><a href="#2-interface模块" class="headerlink" title="2 interface模块"></a>2 interface模块</h3><p><strong>2.1 moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Printer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>interface只定义一个接口，不提供实现。规范的制定方一般都是比较牛叉的存在，这些接口通常位于java，javax前缀的包中。这里的Printer就是模拟一个规范接口。</p>
<h3 id="3-good-printer模块"><a href="#3-good-printer模块" class="headerlink" title="3 good-printer模块"></a>3 good-printer模块</h3><p><strong>3.1 good-printer\pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>规范的具体实现类必然要依赖规范接口</p>
<p><strong>3.2 moe.cnkirito.spi.api.GoodPrinter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodPrinter</span> <span class="keyword">implements</span> <span class="title">Printer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"你是个好人~"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作为Printer规范接口的实现一</p>
<p><strong>3.3 resources\META-INF\services\moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">moe.cnkirito.spi.api.GoodPrinter</div></pre></td></tr></table></figure>
<p>这里需要重点说明，每一个SPI接口都需要在自己项目的静态资源目录中声明一个services文件，文件名为实现规范接口的类名全路径，在此例中便是<code>moe.cnkirito.spi.api.Printer</code>，在文件中，则写上一行具体实现类的全路径，在此例中便是<code>moe.cnkirito.spi.api.GoodPrinter</code>。</p>
<p>这样一个厂商的实现便完成了。</p>
<h3 id="4-bad-printer模块"><a href="#4-bad-printer模块" class="headerlink" title="4 bad-printer模块"></a>4 bad-printer模块</h3><p>我们在按照和good-printer模块中定义的一样的方式，完成另一个厂商对Printer规范的实现。</p>
<p><strong>4.1 bad-printer\pom.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>4.2 moe.cnkirito.spi.api.BadPrinter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadPrinter</span> <span class="keyword">implements</span> <span class="title">Printer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"我抽烟，喝酒，蹦迪，但我知道我是好女孩~"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>4.3 resources\META-INF\services\moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">moe.cnkirito.spi.api.BadPrinter</div></pre></td></tr></table></figure>
<p>这样，另一个厂商的实现便完成了。</p>
<p><strong>5 invoker模块</strong></p>
<p>这里的invoker便是我们自己的项目了。如果一开始我们想使用厂商good-printer的Printer实现，是需要将其的依赖引入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>good-printer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>5.1 编写调用主类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ServiceLoader&lt;Printer&gt; printerLoader = ServiceLoader.load(Printer.class);</div><div class="line">        <span class="keyword">for</span> (Printer printer : printerLoader) &#123;</div><div class="line">            printer.print();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServiceLoader是<code>java.util</code>提供的用于加载固定类路径下文件的一个加载器，正是它加载了对应接口声明的实现类。</p>
<p><strong>5.2 打印结果1</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">你是个好人~</div></pre></td></tr></table></figure>
<p>如果在后续的方案中，想替换厂商的Printer实现，只需要将依赖更换</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bad-printer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>调用主类无需变更代码，这符合开闭原则</p>
<p><strong>5.3 打印结果2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">我抽烟，喝酒，蹦迪，但我知道我是好女孩~</div></pre></td></tr></table></figure>
<p>是不是很神奇呢？这一切对于调用者来说都是透明的，只需要切换依赖即可！</p>
<h2 id="SPI在实际项目中的应用"><a href="#SPI在实际项目中的应用" class="headerlink" title="SPI在实际项目中的应用"></a>SPI在实际项目中的应用</h2><p>先总结下有什么新知识，resources/META-INF/services下的文件似乎我们之前没怎么接触过，ServiceLoader也没怎么接触过。那么现在我们打开自己项目的依赖，看看有什么发现。</p>
<ol>
<li><p>在mysql-connector-java-xxx.jar中发现了META-INF\services\java.sql.Driver文件，里面只有两行记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">com.mysql.jdbc.Driver</div><div class="line">com.mysql.fabric.jdbc.FabricMySQLDriver</div></pre></td></tr></table></figure>
<p>我们可以分析出，<code>java.sql.Driver</code>是一个规范接口，<code>com.mysql.jdbc.Driver</code><br><code>com.mysql.fabric.jdbc.FabricMySQLDriver</code>则是mysql-connector-java-xxx.jar对这个规范的实现接口。</p>
</li>
<li><p>在jcl-over-slf4j-xxxx.jar中发现了META-INF\services\org.apache.commons.logging.LogFactory文件，里面只有一行记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">org.apache.commons.logging.impl.SLF4JLogFactory</div></pre></td></tr></table></figure>
<p>相信不用我赘述，大家都能理解这是什么含义了</p>
</li>
<li><p>更多的还有很多，有兴趣可以自己翻一翻项目路径下的那些jar包</p>
</li>
</ol>
<p>既然说到了数据库驱动，索性再多说一点，还记得一道经典的面试题：class.forName(“com.mysql.jdbc.Driver”)到底做了什么事？</p>
<p>先思考下：自己会怎么回答？</p>
<p>都知道class.forName与类加载机制有关，会触发执行com.mysql.jdbc.Driver类中的静态方法，从而使主类加载数据库驱动。如果再追问，为什么它的静态块没有自动触发？可答：因为数据库驱动类的特殊性质，JDBC规范中明确要求Driver类必须向DriverManager注册自己，导致其必须由class.forName手动触发，这可以在java.sql.Driver中得到解释。完美了吗？还没，来到最新的DriverManager源码中，可以看到这样的注释,翻译如下：</p>
<blockquote>
<p><code>DriverManager</code> 类的方法 <code>getConnection</code> 和 <code>getDrivers</code> 已经得到提高以支持 Java Standard Edition <a href="http://tool.oschina.net/uploads/apidocs/technotes/guides/jar/jar.html#Service%20Provider" target="_blank" rel="external">Service Provider</a> 机制。 JDBC 4.0 Drivers 必须包括 <code>META-INF/services/java.sql.Driver</code> 文件。此文件包含 <code>java.sql.Driver</code> 的 JDBC 驱动程序实现的名称。例如，要加载 <code>my.sql.Driver</code> 类，<code>META-INF/services/java.sql.Driver</code> 文件需要包含下面的条目：</p>
<p> <strong>my.sql.Driver</strong></p>
<p>应用程序不再需要使用 <code>Class.forName()</code> 显式地加载 JDBC 驱动程序。当前使用 <code>Class.forName()</code> 加载 JDBC 驱动程序的现有程序将在不作修改的情况下继续工作。</p>
</blockquote>
<p>可以发现，Class.forName已经被弃用了，所以，这道题目的最佳回答，应当是和面试官牵扯到JAVA中的SPI机制，进而聊聊加载驱动的演变历史。</p>
<p><strong>java.sql.DriverManager</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</div><div class="line">    Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</div><div class="line"></div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</div><div class="line">            driversIterator.next();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span>(Throwable t) &#123;</div><div class="line">    <span class="comment">// Do nothing</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然那，本节的内容还是主要介绍SPI，驱动这一块这是引申而出，如果不太理解，可以多去翻一翻jdk1.8中Driver和DriverManager的源码，相信会有不小的收获。</p>
<h2 id="SPI在扩展方面的应用"><a href="#SPI在扩展方面的应用" class="headerlink" title="SPI在扩展方面的应用"></a>SPI在扩展方面的应用</h2><p>SPI不仅仅是为厂商指定的标准，同样也为框架扩展提供了一个思路。框架可以预留出SPI接口，这样可以在不侵入代码的前提下，通过增删依赖来扩展框架。前提是，框架得预留出核心接口，也就是本例中interface模块中类似的接口，剩下的适配工作便留给了开发者。</p>
<p>例如我的上一篇文章 <a href="https://www.cnkirito.moe/2017/11/07/spring-cloud-sleuth/" target="_blank" rel="external">https://www.cnkirito.moe/2017/11/07/spring-cloud-sleuth/</a> 中介绍的motan中Filter的扩展，便是采用了SPI机制，熟悉这个设定之后再回头去了解一些框架的SPI扩展就不会太陌生了。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/09/spi/" data-id="cjbbm27r10031hcudjo0k3vsl" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/09/spi/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/09/spi/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-cloud-sleuth" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/07/spring-cloud-sleuth/">使用Spring Cloud Sleuth实现链路监控</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/07/spring-cloud-sleuth/">
            <time datetime="2017-11-07T08:58:01.000Z" itemprop="datePublished">2017-11-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Cloud/">Spring Cloud</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>在服务比较少的年代，一个系统的接口响应缓慢通常能够迅速被发现，但如今的微服务模块，大多具有规模大，依赖关系复杂等特性，错综复杂的网状结构使得我们不容易定位到某一个执行缓慢的接口。分布式的服务跟踪组件就是为了解决这一个问题。其次，它解决了另一个难题，在没有它之前，我们客户会一直询问：你们的系统有监控吗？你们的系统有监控吗？你们的系统有监控吗？现在，谢天谢地，他们终于不问了。是有点玩笑的成分，但可以肯定的一点是，实现全链路监控是保证系统健壮性的关键因子。</p>
<p>介绍Spring Cloud Sleuth和Zipkin的文章在网上其实并不少，所以我打算就我目前的系统来探讨一下，如何实现链路监控。全链路监控这个词意味着只要是不同系统模块之间的调用都应当被监控，这就包括了如下几种常用的交互方式：</p>
<p>1 Http协议，如RestTemplate，Feign，Okhttp3，HttpClient…</p>
<p>2 Rpc远程调用，如Motan，Dubbo，GRPC…</p>
<p>3 分布式Event，如RabbitMq，Kafka…</p>
<p>而我们项目目前混合使用了Http协议，Motan Rpc协议，所以本篇文章会着墨于实现这两块的链路监控。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/sleuth%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7.png" alt="项目结构"></p>
<p>上面的项目结构是本次demo的核心结构，其中</p>
<ol>
<li>zipkin-server作为服务跟踪的服务端，记录各个模块发送而来的调用请求，最终形成调用链路的报告。</li>
<li>order,goods两个模块为用来做测试的业务模块，分别实现了http形式和rpc形式的远程调用，最终我们会在zipkin-server的ui页面验证他们的调用记录。</li>
<li>interface存放了order和goods模块的公用接口，rpc调用需要一个公用的接口。</li>
<li>filter-opentracing存放了自定义的motan扩展代码，用于实现motan rpc调用的链路监控。</li>
</ol>
<h2 id="Zipkin服务端"><a href="#Zipkin服务端" class="headerlink" title="Zipkin服务端"></a>Zipkin服务端</h2><p><strong>添加依赖</strong></p>
<p><a href="https://github.com/lexburner/sleuth-starter/blob/master/zipkin-server/pom.xml" target="_blank" rel="external">全部依赖</a></p>
<p><strong>核心依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-storage-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.28.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>zipkin-autoconfigure-ui</code>提供了默认了UI页面，<code>zipkin-storage-mysql</code>选择将链路调用信息存储在mysql中，更多的选择可以有<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/elasticsearch" target="_blank" rel="external">elasticsearch</a>，<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/cassandra" target="_blank" rel="external">cassandra</a>。</p>
<p><strong>zipkin-server/src/main/resources/application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">zipkin-server</span></div><div class="line"><span class="attr">  datasource:</span></div><div class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://localhost:3306/zipkin</span></div><div class="line"><span class="attr">    username:</span> <span class="string">root</span></div><div class="line"><span class="attr">    password:</span> <span class="string">root</span></div><div class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">zipkin:</span></div><div class="line"><span class="attr">   storage:</span></div><div class="line"><span class="attr">      type:</span> <span class="string">mysql</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9411</span></div></pre></td></tr></table></figure>
<p><strong>创建启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableZipkinServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipkinServerApp</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MySQLStorage <span class="title">mySQLStorage</span><span class="params">(DataSource datasource)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MySQLStorage.builder().datasource(datasource).executor(Runnable::run).build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(ZipkinServerApp.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当前版本在手动配置数据库之后才不会启动报错，可能与版本有关。mysql相关的脚本可以在此处下载：<a href="https://github.com/lexburner/sleuth-starter/blob/master/zipkin-server/src/main/resources/mysql.sql" target="_blank" rel="external">mysql初始化脚本</a>。</p>
<p>zipkin-server单独启动后，就可以看到链路监控页面了，此时由于没有收集到任何链路调用记录，显示如下：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/zipkin_blank.png" alt="zipkin服务端页面"></p>
<h2 id="HTTP链路监控"><a href="#HTTP链路监控" class="headerlink" title="HTTP链路监控"></a>HTTP链路监控</h2><p>编写order和goods两个服务，在order暴露一个http端口，在goods中使用RestTemplate远程调用，之后查看在zipkin服务端查看调用信息。</p>
<p>首先添加依赖，让普通的应用具备收集和发送报告的能力，这一切在spring cloud sleuth的帮助下都变得很简单</p>
<p><strong>添加依赖</strong></p>
<p><a href="">全部依赖</a></p>
<p><strong>核心依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>spring-cloud-starter-zipkin</code>依赖内部包含了两个依赖，等于同时引入了<code>spring-cloud-starter-sleuth</code>，<code>spring-cloud-sleuth-zipkin</code>两个依赖。名字特别像，注意区分。</p>
<p>以order为例介绍配置文件</p>
<p><strong>order/src/main/resources/application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order</span> <span class="comment"># 1</span></div><div class="line"><span class="attr">  zipkin:</span></div><div class="line"><span class="attr">    base-url:</span> <span class="attr">http://localhost:9411</span> <span class="comment"># 2</span></div><div class="line"><span class="attr">  sleuth:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    sampler:</span></div><div class="line"><span class="attr">      percentage:</span> <span class="number">1</span> <span class="comment"># 3</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8060</span></div></pre></td></tr></table></figure>
<p><1> 指定项目名称可以方便的标记应用，在之后的监控页面可以看到这里的配置名称</1></p>
<p><2> 指定zipkin的服务端，用于发送链路调用报告</2></p>
<p><3> 采样率，值为[0,1]之间的任意实数，顾名思义，这里代表100%采集报告。</3></p>
<p><strong>编写调用类</strong></p>
<p>服务端order</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line"></div><div class="line">    Logger logger = LoggerFactory.getLogger(OrderController.class);</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/order/&#123;id&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> MainOrder <span class="title">getOrder</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</div><div class="line">        logger.info(<span class="string">"order invoking ..."</span>); <span class="comment">//&lt;1&gt;</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MainOrder(id, <span class="keyword">new</span> BigDecimal(<span class="number">200</span>D), <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端goods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MainOrder <span class="title">test</span><span class="params">()</span></span>&#123;</div><div class="line">    ResponseEntity&lt;MainOrder&gt; mainOrderResponseEntity = restTemplate.getForEntity(<span class="string">"http://localhost:8060/api/order/1144"</span>, MainOrder.class);</div><div class="line">    MainOrder body = mainOrderResponseEntity.getBody();</div><div class="line">    <span class="keyword">return</span> body;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 首先观察这一行日志在控制台是如何输出的</1></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017-11-08 09:54:00.633  INFO [order,d251f40af64361d2,e46132755dc395e1,true] 2780 --- [nio-8060-exec-1] m.c.sleuth.order.web.OrderController     : order invoking ...</div></pre></td></tr></table></figure>
<p>比没有引入sleuth之前多了一些信息，其中<code>order,d251f40af64361d2,e46132755dc395e1,true</code>分别代表了应用名称，traceId，spanId，当前调用是否被采集，关于trace，span这些专业词语，强烈建议去看看Dapper这篇论文，有很多中文翻译版本，并不是想象中的学术范，非常容易理解，很多链路监控文章中的截图都来自于这篇论文，我在此就不再赘述概念了。</p>
<p>紧接着，回到zipkin-server的监控页面，查看变化</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0%E8%A2%AB%E8%AE%B0%E5%BD%95.png" alt="应用名称"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E6%9F%A5%E7%9C%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E7%BB%86%E8%AE%B0%E5%BD%95.png" alt="调用详细记录"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E6%9F%A5%E7%9C%8B.png" alt="依赖关系"></p>
<p>到这里，Http监控就已经完成了，如果你的应用使用了其他的Http工具，如okhttp3，也可以去[opentracing，zipkin相关的文档中寻找依赖。</p>
<h2 id="RPC链路监控"><a href="#RPC链路监控" class="headerlink" title="RPC链路监控"></a>RPC链路监控</h2><p>虽说spring cloud是大势所趋，其推崇的http调用方式也是链路监控的主要对象，但不得不承认目前大多数的系统内部调用仍然是RPC的方式，至少我们内部的系统是如此，由于我们内部采用的RPC框架是weibo开源的motan，这里以此为例，介绍RPC的链路监控。motan使用SPI机制，实现了对链路监控的支持，<a href="https://github.com/weibocom/motan/issues/304这条issue中可以得知其加入了opentracing标准化追踪。但目前只能通过自己添加组件的方式才能配合spring-cloud-sleuth使用，下面来看看实现步骤。" target="_blank" rel="external">https://github.com/weibocom/motan/issues/304这条issue中可以得知其加入了opentracing标准化追踪。但目前只能通过自己添加组件的方式才能配合spring-cloud-sleuth使用，下面来看看实现步骤。</a></p>
<p><strong>filter-opentracing</strong></p>
<p>实现思路：引入SleuthTracingFilter，作为全局的motan过滤器，给每一次motan的调用打上traceId和spanId，并编写一个SleuthTracingContext，持有一个SleuthTracerFactory工厂，用于适配不同的Tracer实现。</p>
<p>具体的实现可以参考文末的地址</p>
<p><strong>order/src/main/resources/META-INF/services/com.weibo.api.motan.filter.Filter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.weibo.api.motan.filter.sleuth.SleuthTracingFilter</div></pre></td></tr></table></figure>
<p>添加一行过滤器的声明，使得项目能够识别</p>
<p><strong>配置SleuthTracingContext</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function">SleuthTracingContext <span class="title">sleuthTracingContext</span><span class="params">(@Autowired(required = <span class="keyword">false</span>)</span>  org.springframework.cloud.sleuth.Tracer tracer)</span>&#123;</div><div class="line">    SleuthTracingContext context = <span class="keyword">new</span> SleuthTracingContext();</div><div class="line">    context.setTracerFactory(<span class="keyword">new</span> SleuthTracerFactory() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> org.springframework.cloud.sleuth.<span class="function">Tracer <span class="title">getTracer</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> tracer;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用spring-cloud-sleuth的Tracer作为motan调用的收集器</p>
<p><strong>为服务端和客户端配置过滤器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">basicServiceConfigBean.setFilter(<span class="string">"sleuth-tracing"</span>);</div><div class="line"></div><div class="line">basicRefererConfigBean.setFilter(<span class="string">"sleuth-tracing"</span>);</div></pre></td></tr></table></figure>
<p><strong>编写调用测试类</strong></p>
<p>order作为客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MotanReferer</span></div><div class="line">GoodsApi goodsApi;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/goods"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getGoodsList</span><span class="params">()</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"getGoodsList invoking ..."</span>);</div><div class="line">    <span class="keyword">return</span> goodsApi.getGoodsList();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>goods作为服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MotanService</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsApiImpl</span> <span class="keyword">implements</span> <span class="title">GoodsApi</span> </span>&#123;</div><div class="line"></div><div class="line">    Logger logger = LoggerFactory.getLogger(GoodsApiImpl.class);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGoodsList</span><span class="params">()</span> </span>&#123;</div><div class="line">        logger.info(<span class="string">"GoodsApi invoking ..."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>查看调用关系</strong></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E9%93%BE%E8%B7%AF%E8%B0%83%E7%94%A8%E4%BF%A1%E6%81%AF.png" alt="motan调用详细信息"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/motan_%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB.png" alt="依赖关系"></p>
<p>第一张图中，使用前缀http和motan来区别调用的类型，第二张图中，依赖变成了双向的，因为一开始的http调用goods依赖于order，而新增了motan rpc调用之后order又依赖于goods。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>系统间交互的方式除了http，rpc，还有另外的方式如mq，以后还可能会有更多的方式，但实现的监控的思路都是一致的，即如何无侵入式地给调用打上标签，记录报告。Dapper给实现链路监控提供了一个思路，而OpenTracing为各个框架不同的调用方式提供了适配接口….Spring Cloud Sleuth则是遵循了Spring一贯的风格，整合了丰富的资源，为我们的系统集成链路监控提供了很大的便捷性。</p>
<p>关于motan具体实现链路监控的代码由于篇幅限制，将源码放在了我的github中，如果你的系统使用了motan，可以用于参考：<a href="https://github.com/lexburner/sleuth-starter" target="_blank" rel="external">https://github.com/lexburner/sleuth-starter</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《Spring Cloud微服务实战》– 翟永超</p>
<p>黄桂钱老师的指导</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/" data-id="cjbbm27rh0034hcud623m4s18" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-data-redis-2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/28/spring-data-redis-2/">Spring Data Redis（二）--序列化</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/28/spring-data-redis-2/">
            <time datetime="2017-10-28T08:10:55.000Z" itemprop="datePublished">2017-10-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Data-Redis/">Spring Data Redis</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="默认序列化方案"><a href="#默认序列化方案" class="headerlink" title="默认序列化方案"></a>默认序列化方案</h2><p>在上一篇文章《Spring Data Redis（一）》中，我们执行了这样一个操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redisTemplate.opsForValue().set(<span class="string">"student:1"</span>,<span class="string">"kirito"</span>);</div></pre></td></tr></table></figure>
<p>试图使用RedisTemplate在Redis中存储一个键为“student:1”，值为“kirito”的String类型变量（redis中通常使用‘:’作为键的分隔符）。那么是否真的如我们所预想的那样，在Redis中存在这样的键值对呢？</p>
<p>这可以说是Redis中最基础的操作了，但严谨起见，还是验证一下为妙，使用RedisDesktopManager可视化工具，或者redis-cli都可以查看redis中的数据。</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028125803.png" alt="查看redis"></p>
<p>emmmmm，大概能看出是我们的键值对，但前面似乎多了一些奇怪的16进制字符，在不了解RedisTemplate工作原理的情况下，自然会对这个现象产生疑惑。</p>
<p>首先看看springboot如何帮我们自动完成RedisTemplate的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">     <span class="meta">@Bean</span></div><div class="line">     <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</div><div class="line">     <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">           RedisConnectionFactory redisConnectionFactory)</span></span></div><div class="line"><span class="function">                 <span class="keyword">throws</span> UnknownHostException </span>&#123;</div><div class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;Object, Object&gt;();</div><div class="line">        template.setConnectionFactory(redisConnectionFactory);</div><div class="line">        <span class="keyword">return</span> template;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没看出什么特殊的设置，于是我们进入RedisTemplate自身的源码中一窥究竟。</p>
<p>首先是在类开头声明了一系列的序列化器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> enableDefaultSerializer = <span class="keyword">true</span>;<span class="comment">// 配置默认序列化器</span></div><div class="line"><span class="keyword">private</span> RedisSerializer&lt;?&gt; defaultSerializer;</div><div class="line"><span class="keyword">private</span> ClassLoader classLoader;</div><div class="line"></div><div class="line"><span class="keyword">private</span> RedisSerializer keySerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer valueSerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer hashKeySerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer hashValueSerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer&lt;String&gt; stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</div></pre></td></tr></table></figure>
<p>看到了我们关心的<code>keySerializer</code>和<code>valueSerializer</code>，在RedisTemplate.afterPropertiesSet()方法中，可以看到，默认的序列化方案:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">super</span>.afterPropertiesSet();</div><div class="line">     <span class="keyword">boolean</span> defaultUsed = <span class="keyword">false</span>;</div><div class="line">     <span class="keyword">if</span> (defaultSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">        defaultSerializer = <span class="keyword">new</span> JdkSerializationRedisSerializer(</div><div class="line">              classLoader != <span class="keyword">null</span> ? classLoader : <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (enableDefaultSerializer) &#123;</div><div class="line">        <span class="keyword">if</span> (keySerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           keySerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (valueSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           valueSerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hashKeySerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           hashKeySerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hashValueSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           hashValueSerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	...</div><div class="line">    initialized = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>默认的方案是使用了<code>JdkSerializationRedisSerializer</code>，所以导致了前面的结果，注意：字符串和使用jdk序列化之后的字符串是两个概念。</p>
<p>我们可以查看set方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] rawValue = rawValue(value);</div><div class="line">   execute(<span class="keyword">new</span> ValueDeserializingRedisCallback(key) &#123;</div><div class="line"></div><div class="line">      <span class="keyword">protected</span> <span class="keyword">byte</span>[] inRedis(<span class="keyword">byte</span>[] rawKey, RedisConnection connection) &#123;</div><div class="line">         connection.set(rawKey, rawValue);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">   &#125;, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终与Redis交互使用的是原生的connection，键值则全部是字节数组，意味着所有的序列化都依赖于应用层完成，Redis只认字节！这也是引出本节介绍的初衷，序列化是与Redis打交道很关键的一个环节。</p>
<h2 id="StringRedisSerializer"><a href="#StringRedisSerializer" class="headerlink" title="StringRedisSerializer"></a>StringRedisSerializer</h2><p>在我不长的使用Redis的时间里，其实大多数操作是字符串操作，键值均为字符串，String.getBytes()即可满足需求。spring-data-redis也考虑到了这一点，其一，提供了StringRedisSerializer的实现，其二，提供了StringRedisTemplate，继承自RedisTemplate。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringRedisTemplate</span> <span class="keyword">extends</span> <span class="title">RedisTemplate</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRedisTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        RedisSerializer&lt;String&gt; stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line">        setKeySerializer(stringSerializer);</div><div class="line">        setValueSerializer(stringSerializer);</div><div class="line">        setHashKeySerializer(stringSerializer);</div><div class="line">        setHashValueSerializer(stringSerializer);</div><div class="line">    &#125;</div><div class="line">  	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即只能存取字符串。尝试执行如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line">StringRedisTemplate stringRedisTemplate;</div><div class="line"></div><div class="line">stringRedisTemplate.opsForValue().set(<span class="string">"student:2"</span>, <span class="string">"SkYe"</span>);</div></pre></td></tr></table></figure>
<p>再同样观察RedisDesktopManager中的变化：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028140012.png" alt="查看redis"></p>
<p>由于更换了序列化器，我们得到的结果也不同了。</p>
<h2 id="项目中序列化器使用的注意点"><a href="#项目中序列化器使用的注意点" class="headerlink" title="项目中序列化器使用的注意点"></a>项目中序列化器使用的注意点</h2><p>理论上，字符串（本质是字节）其实是万能格式，是否可以使用StringRedisTemplate将复杂的对象存入Redis中，答案当然是肯定的。可以在应用层手动将对象序列化成字符串，如使用fastjson，jackson等工具，反序列化时也是通过字符串还原出原来的对象。而如果是用<code>redisTemplate.opsForValue().set(&quot;student:3&quot;,new Student(3,&quot;kirito&quot;));</code>便是依赖于内部的序列化器帮我们完成这样的一个流程，和使用<code>stringRedisTemplate.opsForValue().set(&quot;student:3&quot;,JSON.toJSONString(new Student(3,&quot;kirito&quot;)));</code></p>
<p>其实是一个等价的操作。但有两点得时刻记住两点:</p>
<ol>
<li>Redis只认字节。</li>
<li>使用什么样的序列化器序列化，就必须使用同样的序列化器反序列化。</li>
</ol>
<p>曾经在review代码时发现，项目组的两位同事操作redis，一个使用了RedisTemplate，一个使用了StringRedisTemplate，当他们操作同一个键时，key虽然相同，但由于序列化器不同，导致无法获取成功。差异虽小，但影响是非常可怕的。</p>
<p>另外一点是，微服务不同模块连接了同一个Redis，在共享内存中交互数据，可能会由于版本升级，模块差异，导致相互的序列化方案不一致，也会引起问题。如果项目中途切换了序列化方案，也可能会引起Redis中老旧持久化数据的反序列化异常，同样需要引起注意。最优的方案自然是在项目初期就统一好序列化方案，所有模块引用同一份依赖，避免不必要的麻烦（或者干脆全部使用默认配置）。</p>
<h2 id="序列化接口RedisSerializer"><a href="#序列化接口RedisSerializer" class="headerlink" title="序列化接口RedisSerializer"></a>序列化接口RedisSerializer</h2><p>无论是RedisTemplate中默认使用的<code>JdkSerializationRedisSerializer</code>，还是StringRedisTemplate中使用的<code>StringRedisSerializer</code>都是实现自统一的接口<code>RedisSerializer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">   <span class="keyword">byte</span>[] serialize(T t) <span class="keyword">throws</span> SerializationException;</div><div class="line">   <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在spring-data-redis中提供了其他的默认实现，用于替换默认的序列化方案。</p>
<ul>
<li>GenericToStringSerializer 依赖于内部的ConversionService，将所有的类型转存为字符串</li>
<li>GenericJackson2JsonRedisSerializer和Jackson2JsonRedisSerializer 以JSON的形式序列化对象</li>
<li>OxmSerializer 以XML的形式序列化对象</li>
</ul>
<p>我们可能出于什么样的目的修改序列化器呢？按照个人理解可以总结为以下几点：</p>
<ol>
<li>各个工程间约定了数据格式，如使用JSON等通用数据格式，可以让异构的系统接入Redis同样也能识别数据，而JdkSerializationRedisSerializer则不具备这样灵活的特性</li>
<li>数据的可视化，在项目初期我曾经偏爱JSON序列化，在运维时可以清晰地查看各个value的值，非常方便。</li>
<li>效率问题，如果需要将大的对象存入Value中，或者Redis IO非常频繁，替换合适的序列化器便可以达到优化的效果。</li>
</ol>
<h2 id="替换默认的序列化器"><a href="#替换默认的序列化器" class="headerlink" title="替换默认的序列化器"></a>替换默认的序列化器</h2><p>可以将全局的RedisTemplate覆盖，也可以在使用时在局部实例化一个RedisTemplate替换（不依赖于IOC容器）需要根据实际的情况选择替换的方式，以Jackson2JsonRedisSerializer为例介绍全局替换的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</div><div class="line">    RedisTemplate redisTemplate = <span class="keyword">new</span> RedisTemplate();</div><div class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</div><div class="line">    Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</div><div class="line"></div><div class="line">    ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();<span class="comment">// &lt;1&gt;</span></div><div class="line">    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</div><div class="line">    objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</div><div class="line"></div><div class="line">    jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</div><div class="line"></div><div class="line">    redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer()); <span class="comment">// &lt;2&gt;</span></div><div class="line">    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer); <span class="comment">// &lt;2&gt;</span></div><div class="line"></div><div class="line">    redisTemplate.afterPropertiesSet();</div><div class="line">    <span class="keyword">return</span> redisTemplate;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 修改Jackson序列化时的默认行为</1></p>
<p><2> 手动指定RedisTemplate的Key和Value的序列化器</2></p>
<p>然后使用RedisTemplate进行保存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line">StringRedisTemplate stringRedisTemplate;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    Student student3 = <span class="keyword">new</span> Student();</div><div class="line">    student3.setName(<span class="string">"kirito"</span>);</div><div class="line">    student3.setId(<span class="string">"3"</span>);</div><div class="line">    student3.setHobbies(Arrays.asList(<span class="string">"coding"</span>,<span class="string">"write blog"</span>,<span class="string">"eat chicken"</span>));</div><div class="line">    redisTemplate.opsForValue().set(<span class="string">"student:3"</span>,student3);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着，去RedisDesktopManager中查看结果：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028225412.png" alt="查看Redis"></p>
<p>标准的JSON格式</p>
<h2 id="实现Kryo序列化"><a href="#实现Kryo序列化" class="headerlink" title="实现Kryo序列化"></a>实现Kryo序列化</h2><p>我们也可以考虑根据自己项目和需求的特点，扩展序列化器，这是非常方便的。比如前面提到的，为了追求性能，可能考虑使用Kryo序列化器替换缓慢的JDK序列化器，如下是一个参考实现（为了demo而写，未经过生产验证）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoRedisSerializer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(KryoRedisSerializer.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryos = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">            <span class="keyword">return</span> kryo;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> SerializationException &#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"serialize param must not be null"</span>);</div><div class="line">        &#125;</div><div class="line">        Kryo kryo = kryos.get();</div><div class="line">        Output output = <span class="keyword">new</span> Output(<span class="number">64</span>, -<span class="number">1</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            kryo.writeClassAndObject(output, obj);</div><div class="line">            <span class="keyword">return</span> output.toBytes();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            closeOutputStream(output);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        Kryo kryo = kryos.get();</div><div class="line">        Input input = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            input = <span class="keyword">new</span> Input(bytes);</div><div class="line">            <span class="keyword">return</span> (T) kryo.readClassAndObject(input);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            closeInputStream(input);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeOutputStream</span><span class="params">(OutputStream output)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (output != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                output.flush();</div><div class="line">                output.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(<span class="string">"serialize object close outputStream exception"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeInputStream</span><span class="params">(InputStream input)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                input.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(<span class="string">"serialize object close inputStream exception"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于Kyro是线程不安全的，所以使用了一个ThreadLocal来维护，也可以挑选其他高性能的序列化方案如Hessian，Protobuf…</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/28/spring-data-redis-2/" data-id="cjbbm27rh003chcud5mczdsjz" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/28/spring-data-redis-2/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/28/spring-data-redis-2/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-data-redis-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/27/spring-data-redis-1/">Spring Data Redis（一）--解析RedisTemplate</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/27/spring-data-redis-1/">
            <time datetime="2017-10-27T08:10:55.000Z" itemprop="datePublished">2017-10-27</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Data-Redis/">Spring Data Redis</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>谈及系统优化，缓存一直是不可或缺的一点。在缓存中间件层面，我们有MemCache，Redis等选择；在系统分层层面，又需要考虑多级缓存；在系统可用性层面，又要考虑到缓存雪崩，缓存穿透，缓存失效等常见的缓存问题…缓存的使用与优化值得我们花费一定的精力去深入理解。《Spring Data Redis》这个系列打算围绕spring-data-redis来进行分析，从hello world到源码分析，夹杂一些不多实战经验（经验有限），不止限于spring-data-redis本身，也会扩展谈及缓存这个大的知识点。</p>
<p>至于为何选择redis，相信不用我赘述，redis如今非常流行，几乎成了项目必备的组件之一。而spring-boot-starter-data-redis模块又为我们在spring集成的项目中提供了开箱即用的功能，更加便捷了我们开发。系列的第一篇便是简单介绍下整个组件最常用的一个工具类：RedisTemplate。</p>
<h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1 引入依赖"></a>1 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>springboot的老用户会发现redis依赖名称发生了一点小的变化，在springboot1.4之前，redis依赖的名称为：spring-boot-starter-redis，而在之后较新的版本中，使用spring-boot-starter-redis依赖，则会在项目启动时得到一个过期警告。意味着，我们应该彻底放弃旧的依赖。spring-data这个项目定位为spring提供一个统一的数据仓库接口，如（spring-boot-starter-data-jpa,spring-boot-starter-data-mongo,spring-boot-starter-data-rest），将redis纳入后，改名为了spring-boot-starter-data-redis。</p>
<h2 id="2-配置redis连接"><a href="#2-配置redis连接" class="headerlink" title="2 配置redis连接"></a>2 配置redis连接</h2><p><code>resources/application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  redis:</span></div><div class="line"><span class="attr">    host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line"><span class="attr">    database:</span> <span class="number">0</span></div><div class="line"><span class="attr">    port:</span> <span class="number">6379</span></div><div class="line"><span class="attr">    password:</span></div></pre></td></tr></table></figure>
<p>本机启动一个单点的redis即可，使用redis的0号库作为默认库（默认有16个库），在生产项目中一般会配置redis集群和哨兵保证redis的高可用，同样可以在application.yml中修改，非常方便。</p>
<h2 id="3-编写测试类"><a href="#3-编写测试类" class="headerlink" title="3 编写测试类"></a>3 编写测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.assertj.core.api.Assertions;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</div><div class="line"></div><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</div><div class="line">   <span class="meta">@Autowired</span></div><div class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;<span class="comment">// &lt;1&gt;</span></div><div class="line"></div><div class="line">   <span class="meta">@Test</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">     redisTemplate.opsForValue().set(<span class="string">"student:1"</span>, <span class="string">"kirito"</span>); <span class="comment">// &lt;2&gt;</span></div><div class="line">     Assertions.assertThat(redisTemplate.opsForValue().get(<span class="string">"student:1"</span>)).isEqualTo(<span class="string">"kirito"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 引入了RedisTemplate，这个类是spring-starter-data-redis提供给应用直接访问redis的入口。从其命名就可以看出，其是模板模式在spring中的体现，与restTemplate，jdbcTemplate类似，而springboot为我们做了自动的配置，具体会在下文详解。</1></p>
<p><2> redisTemplate通常不直接操作键值，而是通过opsForXxx()访问，在本例中，key和value均为字符串类型。绑定字符串在实际开发中也是最为常用的操作类型。</2></p>
<h2 id="4-详解RedisTemplate的API"><a href="#4-详解RedisTemplate的API" class="headerlink" title="4 详解RedisTemplate的API"></a>4 详解RedisTemplate的API</h2><p>RedisTemplate为我们操作Redis提供了丰富的API，可以将他们简单进行下归类。</p>
<h3 id="4-1-常用数据操作"><a href="#4-1-常用数据操作" class="headerlink" title="4.1 常用数据操作"></a>4.1 常用数据操作</h3><p>这一类API也是我们最常用的一类。</p>
<p>众所周知，redis存在5种数据类型：</p>
<p>字符串类型（string），散列类型（hash），列表类型（list），集合类型（set），有序集合类型（zset）</p>
<p>而redisTemplate实现了RedisOperations接口，在其中，定义了一系列与redis相关的基础数据操作接口，数据类型分别于下来API对应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//非绑定key操作</span></div><div class="line"><span class="function">ValueOperations&lt;K, V&gt; <span class="title">opsForValue</span><span class="params">()</span></span>;</div><div class="line">&lt;HK, HV&gt; <span class="function">HashOperations&lt;K, HK, HV&gt; <span class="title">opsForHash</span><span class="params">()</span></span>;</div><div class="line"><span class="function">ListOperations&lt;K, V&gt; <span class="title">opsForList</span><span class="params">()</span></span>;</div><div class="line"><span class="function">SetOperations&lt;K, V&gt; <span class="title">opsForSet</span><span class="params">()</span></span>;</div><div class="line"><span class="function">ZSetOperations&lt;K, V&gt; <span class="title">opsForZSet</span><span class="params">()</span></span>;</div><div class="line"><span class="comment">//绑定key操作</span></div><div class="line"><span class="function">BoundValueOperations&lt;K, V&gt; <span class="title">boundValueOps</span><span class="params">(K key)</span></span>;</div><div class="line">&lt;HK, HV&gt; <span class="function">BoundHashOperations&lt;K, HK, HV&gt; <span class="title">boundHashOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundListOperations&lt;K, V&gt; <span class="title">boundListOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundSetOperations&lt;K, V&gt; <span class="title">boundSetOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundZSetOperations&lt;K, V&gt; <span class="title">boundZSetOps</span><span class="params">(K key)</span></span>;</div></pre></td></tr></table></figure>
<p>若以bound开头，则意味着在操作之初就会绑定一个key，后续的所有操作便默认认为是对该key的操作，算是一个小优化。</p>
<h3 id="4-2-对原生Redis指令的支持"><a href="#4-2-对原生Redis指令的支持" class="headerlink" title="4.2 对原生Redis指令的支持"></a>4.2 对原生Redis指令的支持</h3><p>Redis原生指令中便提供了一些很有用的操作，如设置key的过期时间，判断key是否存在等等…</p>
<p>常用的API列举：</p>
<table>
<thead>
<tr>
<th>RedisTemplate API</th>
<th>原生Redis指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>public void delete(K key)</td>
<td>DEL key [key …]</td>
<td>删除给定的一个或多个 <code>key</code></td>
</tr>
<tr>
<td>public Boolean hasKey(K key)</td>
<td>EXISTS key</td>
<td>检查给定 <code>key</code> 是否存在</td>
</tr>
<tr>
<td>public Boolean expire/expireAt(…)</td>
<td>EXPIRE key seconds</td>
<td>为给定 <code>key</code> 设置生存时间，当 <code>key</code> 过期时(生存时间为 <code>0</code> )，它会被自动删除。</td>
</tr>
<tr>
<td>public Long getExpire(K key)</td>
<td>TTL key</td>
<td>以秒为单位，返回给定 <code>key</code> 的剩余生存时间(TTL, time to live)。</td>
</tr>
</tbody>
</table>
<p>更多的原生Redis指令支持可以参考javadoc</p>
<h3 id="4-3-CAS操作"><a href="#4-3-CAS操作" class="headerlink" title="4.3 CAS操作"></a>4.3 CAS操作</h3><p>CAS（Compare and Swap）通常有3个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。CAS也通常与并发，乐观锁，非阻塞，机器指令等关键词放到一起讲解。可能会有很多朋友在秒杀场景的架构设计中见到了Redis，本质上便是利用了Redis分布式共享内存的特性以及一系列的CAS指令。还记得在4.1中通过redisTemplate.opsForValue()或者redisTemplate.boundValueOps()可以得到一个ValueOperations或BoundValueOperations接口(以值为字符串的操作接口为例)，这些接口除了提供了基础操作外，还提供了一系列CAS操作，也可以放到RedisTemplate中一起理解。</p>
<p>常用的API列举：</p>
<table>
<thead>
<tr>
<th style="text-align:left">ValueOperations API</th>
<th style="text-align:left">原生Redis指令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Boolean setIfAbsent(K key, V value)</td>
<td style="text-align:left">SETNX key value</td>
<td style="text-align:left">将 <code>key</code> 的值设为 <code>value</code> ，当且仅当 <code>key</code> 不存在。设置成功，返回 <code>1</code> ， 设置失败，返回 <code>0</code> 。</td>
</tr>
<tr>
<td style="text-align:left">V getAndSet(K key, V value)</td>
<td style="text-align:left">GETSET key value</td>
<td style="text-align:left">将给定 <code>key</code> 的值设为 <code>value</code> ，并返回 <code>key</code> 的旧值(old value)。</td>
</tr>
<tr>
<td style="text-align:left">Long increment(K key, long delta)/Double increment(K key, double delta)</td>
<td style="text-align:left">INCR/INCRBY/INCRBYFLOAT</td>
<td style="text-align:left">将 <code>key</code> 所储存的值加上增量 <code>increment</code> 。 如果 <code>key</code> 不存在，那么 <code>key</code> 的值会先被初始化为 <code>0</code> ，然后再执行INCR/INCRBY/INCRBYFLOAT命令。线程安全的+</td>
</tr>
</tbody>
</table>
<p>关于CAS的理解可以参考我之前的文章<a href="https://www.cnkirito.moe/2017/03/12/java%E5%B9%B6%E5%8F%91%E5%AE%9E%E8%B7%B5--ConcurrentHashMap%E4%B8%8ECAS/" target="_blank" rel="external">java并发实践–CAS</a>或者其他博文。</p>
<h3 id="4-4-发布订阅"><a href="#4-4-发布订阅" class="headerlink" title="4.4 发布订阅"></a>4.4 发布订阅</h3><p>redis之所以被冠以银弹，万金油的称号，关键在于其实现的功能真是太多了，甚至实现了一部分中间件队列的功能，其内置的channel机制，可以用于实现分布式的队列和广播。</p>
<p>RedisTemplate提供了convertAndSend()功能，用于发送消息，与RedisMessageListenerContainer 配合接收，便实现了一个简易的发布订阅。如果想要使用Redis实现发布订阅，可以参考我之前的文章。<a href="https://www.cnkirito.moe/2017/09/13/event-2/" target="_blank" rel="external">浅析分布式下的事件驱动机制</a></p>
<h3 id="4-5-Lua脚本"><a href="#4-5-Lua脚本" class="headerlink" title="4.5 Lua脚本"></a>4.5 Lua脚本</h3><p>RedisTemplate中包含了这样一个Lua执行器，意味着我们可以使用RedisTemplate执行Lua脚本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ScriptExecutor&lt;K&gt; scriptExecutor;</div></pre></td></tr></table></figure>
<p>Lua这门语言也非常有意思，小巧而精悍，有兴趣的朋友可以去了解一下nginx+lua开发，使用openResty框架。而Redis内置了Lua的解析器，由于Redis单线程的特性（不严谨），可以使用Lua脚本，完成一些线程安全的符合操作（CAS操作仅仅只能保证单个操作的线程安全，无法保证复合操作，如果你有这样的需求，可以考虑使用Redis+Lua脚本）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> scriptExecutor.execute(script, keys, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述操作便可以完成对Lua脚本的调用。这儿有一个简单的示例，使用Redis+Lua脚本实现分布式的应用限流。<a href="https://www.cnkirito.moe/2017/03/18/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/" target="_blank" rel="external">分布式限流</a></p>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h3><p>Spring Data Redis系列的第一篇，介绍了spring-data对redis操作的封装，顺带了解redis具备的一系列特性，如果你对redis的理解还仅仅停留在它是一个分布式的key-value数据库，那么相信现在你一定会感叹其竟然如此强大。后续将会对缓存在项目中的应用以及spring-boot-starter-data-redis进一步解析。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/27/spring-data-redis-1/" data-id="cjbbm27rh0039hcuderu4ymqk" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/27/spring-data-redis-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/27/spring-data-redis-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/12/15/rpc-dynamic-proxy/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2017/12/15/rpc-dynamic-proxy/" class="title">深入理解RPC之动态代理篇</a></p>
                            <p class="item-date"><time datetime="2017-12-15T12:16:28.000Z" itemprop="datePublished">2017-12-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/12/11/rpc-serialize-2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2017/12/11/rpc-serialize-2/" class="title">深入理解RPC之序列化篇--总结篇</a></p>
                            <p class="item-date"><time datetime="2017-12-11T14:58:54.000Z" itemprop="datePublished">2017-12-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/12/06/NJIAS2017/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/技术杂谈/">技术杂谈</a></p>
                            <p class="item-title"><a href="/2017/12/06/NJIAS2017/" class="title">南京IAS架构师峰会观后感</a></p>
                            <p class="item-date"><time datetime="2017-12-05T17:15:28.000Z" itemprop="datePublished">2017-12-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/11/28/rpc-serialize-1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2017/11/28/rpc-serialize-1/" class="title">深入理解RPC之序列化篇--Kryo</a></p>
                            <p class="item-date"><time datetime="2017-11-28T14:15:28.000Z" itemprop="datePublished">2017-11-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/11/28/view-1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JAVA/">JAVA</a></p>
                            <p class="item-title"><a href="/2017/11/28/view-1/" class="title">给初中级JAVA准备的面试题</a></p>
                            <p class="item-date"><time datetime="2017-11-28T14:15:28.000Z" itemprop="datePublished">2017-11-28</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Security/">Spring Security</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Security-OAuth2/">Spring Security OAuth2</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Session/">Spring Session</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术杂谈/">技术杂谈</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构设计/">架构设计</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/规则引擎/">规则引擎</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/领域驱动设计/">领域驱动设计</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/DevOps/" style="font-size: 11.67px;">DevOps</a> <a href="/tags/JAVA/" style="font-size: 20px;">JAVA</a> <a href="/tags/JMM/" style="font-size: 10px;">JMM</a> <a href="/tags/RPC/" style="font-size: 15px;">RPC</a> <a href="/tags/Spring/" style="font-size: 18.33px;">Spring</a> <a href="/tags/Spring-Cloud/" style="font-size: 13.33px;">Spring Cloud</a> <a href="/tags/Spring-Cloud-Zuul/" style="font-size: 11.67px;">Spring Cloud Zuul</a> <a href="/tags/Spring-Data-Redis/" style="font-size: 11.67px;">Spring Data Redis</a> <a href="/tags/Spring-Security/" style="font-size: 16.67px;">Spring Security</a> <a href="/tags/Spring-Security-OAuth2/" style="font-size: 13.33px;">Spring Security OAuth2</a> <a href="/tags/Spring-Session/" style="font-size: 13.33px;">Spring Session</a> <a href="/tags/Validation/" style="font-size: 11.67px;">Validation</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/Zipkin/" style="font-size: 10px;">Zipkin</a> <a href="/tags/drools/" style="font-size: 15px;">drools</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/事务/" style="font-size: 10px;">事务</a> <a href="/tags/代码规范/" style="font-size: 10px;">代码规范</a> <a href="/tags/多线程/" style="font-size: 16.67px;">多线程</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/技术杂谈/" style="font-size: 16.67px;">技术杂谈</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/杂谈/" style="font-size: 10px;">杂谈</a> <a href="/tags/架构设计/" style="font-size: 15px;">架构设计</a> <a href="/tags/求职/" style="font-size: 10px;">求职</a> <a href="/tags/规则引擎/" style="font-size: 15px;">规则引擎</a> <a href="/tags/领域驱动设计/" style="font-size: 11.67px;">领域驱动设计</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://www.zhihu.com/people/xu-jing-feng-29/activities">我的知乎</a>
                    </li>
                
                    <li>
                        <a href="https://ntzyz.io/">namespace_ntzyz</a>
                    </li>
                
                    <li>
                        <a href="http://blog.didispace.com/">程序猿DD|博客</a>
                    </li>
                
                    <li>
                        <a href="http://vip.iocoder.cn">芋道源码</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 徐靖峰<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = '';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'hexo-theme-icarus' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>