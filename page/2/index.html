<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>徐靖峰|个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="徐靖峰|个人博客">
<meta property="og:url" content="http://lexburner.github.io/page/2/index.html">
<meta property="og:site_name" content="徐靖峰|个人博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="徐靖峰|个人博客">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    



</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">徐靖峰|个人博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">徐靖峰</h2>
            <h3 id="title">JAVA Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shanghai, China</span>
            <a id="follow" target="_blank" href="https://github.com/lexburner">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                69
                <span>文章</span>
            </div>
            <div class="article-info-block">
                30
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/lexburner" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/css/images/kirito_wechat.jpg" target="_blank" title="wechat" class=tooltip>
                            <i class="fa fa-wechat"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-rpc-serialize-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/28/rpc-serialize-1/">深入理解RPC之序列化篇--Kryo</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/28/rpc-serialize-1/">
            <time datetime="2017-11-28T14:15:28.000Z" itemprop="datePublished">2017-11-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/RPC/">RPC</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/RPC/">RPC</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>一年前，笔者刚刚接触RPC框架，从单体式应用向分布式应用的变革无疑是让人兴奋的，同时也对RPC背后到底做了哪些工作产生了兴趣，但其底层的设计对新手而言并不是很友好，其涉及的一些常用技术点都有一定的门槛。如传输层常常使用的netty，之前完全没听过，想要学习它，需要掌握前置知识点nio；协议层，包括了很多自定义的协议，而每个RPC框架的实现都有差异；代理层的动态代理技术，如jdk动态代理，虽然实战经验不多，但至少还算会用，而cglib则又有一个盲区；序列化层倒还算是众多层次中相对简单的一环，但RPC为了追求可扩展性，性能等诸多因素，通常会支持多种序列化方式以供使用者插拔使用，一些常用的序列化方案hessian，kryo，Protobuf又得熟知…</p>
<p>这个系列打算就RPC框架涉及到的一些知识点进行探讨，本篇先从序列化层的一种选择–kryo开始进行介绍。</p>
<h2 id="序列化概述"><a href="#序列化概述" class="headerlink" title="序列化概述"></a>序列化概述</h2><p>大白话介绍下RPC中序列化的概念，可以简单理解为对象–&gt;字节的过程，同理，反序列化则是相反的过程。为什么需要序列化？因为网络传输只认字节。所以互信的过程依赖于序列化。有人会问，FastJson转换成字符串算不算序列化？对象持久化到数据库算不算序列化？没必要较真，广义上理解即可。</p>
<h2 id="JDK序列化"><a href="#JDK序列化" class="headerlink" title="JDK序列化"></a>JDK序列化</h2><p>可能你没用过kryo，没用过hessian，但你一定用过jdk序列化。我最早接触jdk序列化，是在大二的JAVA大作业中，《XX管理系统》需要把对象保存到文件中（那时还没学数据库），jdk原生支持的序列化方式用起来也很方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;  </div><div class="line">   <span class="keyword">private</span> String name;  </div><div class="line">&#125;  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;  </div><div class="line">      <span class="comment">// create a Student</span></div><div class="line">      Student st = <span class="keyword">new</span> Student(<span class="string">"kirito"</span>);  </div><div class="line">     <span class="comment">// serialize the st to student.db file  </span></div><div class="line">     ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"student.db"</span>));  </div><div class="line">     oos.writeObject(st);  </div><div class="line">     oos.close();  </div><div class="line">     <span class="comment">// deserialize the object from student.db</span></div><div class="line">     ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"student.db"</span>));  </div><div class="line">     Student kirito = (Student) ois.readObject();  </div><div class="line">     ois.close();  </div><div class="line">    <span class="comment">// assert</span></div><div class="line">    <span class="keyword">assert</span> <span class="string">"kirito"</span>.equals(kirito.getName());  </div><div class="line">   &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Student实体类需要实现Serializable接口，以告知其可被序列化。</p>
<p>序列化协议的选择通常有下列一些常用的指标：</p>
<ol>
<li>通用性。是否只能用于java间序列化/反序列化，是否跨语言，跨平台。</li>
<li>性能。分为空间开销和时间开销。序列化后的数据一般用于存储或网络传输，其大小是很重要的一个参数；解析的时间也影响了序列化协议的选择，如今的系统都在追求极致的性能。</li>
<li>可扩展性。系统升级不可避免，某一实体的属性变更，会不会导致反序列化异常，也应该纳入序列化协议的考量范围。</li>
<li>易用性。API使用是否复杂，会影响开发效率。</li>
</ol>
<p>容易用的模型通常性能不好，性能好的模型通常用起来都比较麻烦。显然，JDK序列化属于前者。我们不过多介绍它，直接引入今天的主角kryo作为它的替代品。</p>
<h2 id="Kryo入门"><a href="#Kryo入门" class="headerlink" title="Kryo入门"></a>Kryo入门</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>由于其底层依赖于ASM技术，与Spring等框架可能会发生ASM依赖的版本冲突（文档中表示这个冲突还挺容易出现）所以提供了另外一个依赖以供解决此问题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;  </div><div class="line">   <span class="keyword">private</span> String name;  </div><div class="line">&#125;  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">        Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">        Output output = <span class="keyword">new</span> Output(<span class="keyword">new</span> FileOutputStream(<span class="string">"student.db"</span>));</div><div class="line">        Student kirito = <span class="keyword">new</span> Student(<span class="string">"kirito"</span>);</div><div class="line">        kryo.writeObject(output, kirito);</div><div class="line">        output.close();</div><div class="line">        Input input = <span class="keyword">new</span> Input(<span class="keyword">new</span> FileInputStream(<span class="string">"student.db"</span>));</div><div class="line">        Student kiritoBak = kryo.readObject(input, Student.class);</div><div class="line">        input.close();</div><div class="line">        <span class="keyword">assert</span> <span class="string">"kirito"</span>.equals(kiritoBak.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不需要注释也能理解它的执行流程，和jdk序列化差距并不是很大。</p>
<h3 id="三种读写方式"><a href="#三种读写方式" class="headerlink" title="三种读写方式"></a>三种读写方式</h3><p>Kryo共支持三种读写方式</p>
<ol>
<li>如果知道class字节码，并且对象不为空</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kryo.writeObject(output, someObject);</div><div class="line"><span class="comment">// ...</span></div><div class="line">SomeClass someObject = kryo.readObject(input, SomeClass.class);</div></pre></td></tr></table></figure>
<p>快速入门中的序列化/反序列化的方式便是这一种。而Kryo考虑到someObject可能为null，也会导致返回的结果为null，所以提供了第二套读写方式。</p>
<ol>
<li>如果知道class字节码，并且对象可能为空</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kryo.writeObjectOrNull(output, someObject);</div><div class="line"><span class="comment">// ...</span></div><div class="line">SomeClass someObject = kryo.readObjectOrNull(input, SomeClass.class);</div></pre></td></tr></table></figure>
<p>但这两种方法似乎都不能满足我们的需求，在RPC调用中，序列化和反序列化分布在不同的端点，对象的类型确定，我们不想依赖于手动指定参数，最好是…emmmmm…将字节码的信息直接存放到序列化结果中，在反序列化时自行读取字节码信息。Kryo考虑到了这一点，于是提供了第三种方式。</p>
<ol>
<li>如果实现类的字节码未知，并且对象可能为null</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kryo.writeClassAndObject(output, object);</div><div class="line"><span class="comment">// ...</span></div><div class="line">Object object = kryo.readClassAndObject(input);</div><div class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> SomeClass) &#123;</div><div class="line">   <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们牺牲了一些空间一些性能去存放字节码信息，但这种方式是我们在RPC中应当使用的方式。</p>
<h3 id="我们关心的问题"><a href="#我们关心的问题" class="headerlink" title="我们关心的问题"></a>我们关心的问题</h3><p>继续介绍Kryo特性之前，不妨让我们先思考一下，一个序列化工具或者一个序列化协议，应当需要考虑哪些问题。比如，支持哪些类型的序列化？循环引用会不会出现问题？在某个类增删字段之后反序列化会报错吗？等等等等….</p>
<p>带着我们考虑到的这些疑惑，以及我们暂时没考虑到的，但Kryo帮我们考虑到的，来看看Kryo到底支持哪些特性。</p>
<h3 id="支持的序列化类型"><a href="#支持的序列化类型" class="headerlink" title="支持的序列化类型"></a>支持的序列化类型</h3><table>
<thead>
<tr>
<th>boolean</th>
<th>Boolean</th>
<th>byte</th>
<th>Byte</th>
<th>char</th>
</tr>
</thead>
<tbody>
<tr>
<td>Character</td>
<td>short</td>
<td>Short</td>
<td>int</td>
<td>Integer</td>
</tr>
<tr>
<td>long</td>
<td>Long</td>
<td>float</td>
<td>Float</td>
<td>double</td>
</tr>
<tr>
<td>Double</td>
<td>byte[]</td>
<td>String</td>
<td>BigInteger</td>
<td>BigDecimal</td>
</tr>
<tr>
<td>Collection</td>
<td>Date</td>
<td>Collections.emptyList</td>
<td>Collections.singleton</td>
<td>Map</td>
</tr>
<tr>
<td>StringBuilder</td>
<td>TreeMap</td>
<td>Collections.emptyMap</td>
<td>Collections.emptySet</td>
<td>KryoSerializable</td>
</tr>
<tr>
<td>StringBuffer</td>
<td>Class</td>
<td>Collections.singletonList</td>
<td>Collections.singletonMap</td>
<td>Currency</td>
</tr>
<tr>
<td>Calendar</td>
<td>TimeZone</td>
<td>Enum</td>
<td>EnumSet</td>
</tr>
</tbody>
</table>
<p>表格中支持的类型一览无余，这都是其默认支持的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">kryo.addDefaultSerializer(SomeClass.class, SomeSerializer.class);</div></pre></td></tr></table></figure>
<p>这样的方式，也可以为一个Kryo实例扩展序列化器。</p>
<p>总体而言，Kryo支持以下的类型：</p>
<ul>
<li>枚举</li>
<li>集合、数组</li>
<li>子类/多态</li>
<li>循环引用</li>
<li>内部类</li>
<li>泛型</li>
</ul>
<p>但需要注意的是，<strong>Kryo不支持Bean中增删字段</strong>。如果使用Kryo序列化了一个类，存入了Redis，对类进行了修改，会导致反序列化的异常。</p>
<p>另外需要注意的一点是使用反射创建的一些类序列化的支持。如使用Arrays.asList();创建的List对象，会引起序列化异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.Arrays$ArrayList</div></pre></td></tr></table></figure>
<p>但new ArrayList()创建的List对象则不会，使用时需要注意，可以使用第三方库对Kryo进行序列化类型的扩展。如<a href="https://github.com/magro/kryo-serializers所提供的。" target="_blank" rel="external">https://github.com/magro/kryo-serializers所提供的。</a></p>
<p><strong>不支持包含无参构造器类的反序列化</strong>，尝试反序列化一个不包含无参构造器的类将会得到以下的异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): moe.cnkirito.Xxx</div></pre></td></tr></table></figure>
<p>保证每个类具有无参构造器是应当遵守的编程规范，但实际开发中一些第三库的相关类不包含无参构造，的确是有点麻烦。</p>
<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><p>Kryo是线程不安全的，意味着每当需要序列化和反序列化时都需要实例化一次，或者借助ThreadLocal来维护以保证其线程安全。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryos = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">		Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">		<span class="comment">// configure kryo instance, customize settings</span></div><div class="line">		<span class="keyword">return</span> kryo;</div><div class="line">	&#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Somewhere else, use Kryo</span></div><div class="line">Kryo k = kryos.get();</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="Kryo相关配置参数详解"><a href="#Kryo相关配置参数详解" class="headerlink" title="Kryo相关配置参数详解"></a>Kryo相关配置参数详解</h3><p>每个Kryo实例都可以拥有两个配置参数，这值得被拉出来单独聊一聊。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kryo.setRegistrationRequired(<span class="keyword">false</span>);<span class="comment">//关闭注册行为</span></div><div class="line">kryo.setReferences(<span class="keyword">true</span>);<span class="comment">//支持循环引用</span></div></pre></td></tr></table></figure>
<p>Kryo支持对注册行为，如<code>kryo.register(SomeClazz.class);</code>,这会赋予该Class一个从0开始的编号，但Kryo使用注册行为最大的问题在于，其不保证同一个Class每一次注册的号码想用，这与注册的顺序有关，也就意味着在不同的机器、同一个机器重启前后都有可能拥有不同的编号，这会导致序列化产生问题，所以在分布式项目中，一般关闭注册行为。</p>
<p>第二个注意点在于循环引用，Kryo为了追求高性能，可以关闭循环引用的支持。不过我并不认为关闭它是一件好的选择，大多数情况下，请保持<code>kryo.setReferences(true)</code>。</p>
<h3 id="常用Kryo工具类"><a href="#常用Kryo工具类" class="headerlink" title="常用Kryo工具类"></a>常用Kryo工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoSerializer</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) &#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Output output = <span class="keyword">new</span> Output(byteArrayOutputStream);<span class="comment">//&lt;1&gt;</span></div><div class="line">        kryo.writeClassAndObject(output, obj);<span class="comment">//&lt;2&gt;</span></div><div class="line">        output.close();</div><div class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</div><div class="line">        Kryo kryo = kryoLocal.get();</div><div class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Input input = <span class="keyword">new</span> Input(byteArrayInputStream);<span class="comment">// &lt;1&gt;</span></div><div class="line">        input.close();</div><div class="line">        <span class="keyword">return</span> (T) kryo.readClassAndObject(input);<span class="comment">//&lt;2&gt;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryoLocal = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;<span class="comment">//&lt;3&gt;</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">            kryo.setReferences(<span class="keyword">true</span>);<span class="comment">//默认值为true,强调作用</span></div><div class="line">            kryo.setRegistrationRequired(<span class="keyword">false</span>);<span class="comment">//默认值为false,强调作用</span></div><div class="line">            <span class="keyword">return</span> kryo;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> Kryo的Input和Output接收一个InputStream和OutputStream，Kryo通常完成字节数组和对象的转换，所以常用的输入输出流实现为ByteArrayInputStream/ByteArrayOutputStream。</1></p>
<p><2> writeClassAndObject和readClassAndObject配对使用在分布式场景下是最常见的，序列化时将字节码存入序列化结果中，便可以在反序列化时不必要传入字节码信息。</2></p>
<p><3> 使用ThreadLocal维护Kryo实例，这样减少了每次使用都实例化一次Kryo的开销又可以保证其线程安全。</3></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://github.com/EsotericSoftware/kryo" target="_blank" rel="external">https://github.com/EsotericSoftware/kryo</a></p>
<p><a href="http://www.cnblogs.com/hntyzgn/p/7122709.html" target="_blank" rel="external">Kryo 使用指南</a></p>
<p><a href="https://kb.cnblogs.com/page/515982/" target="_blank" rel="external">序列化与反序列化</a></p>
<hr>
<p>更多的序列化方案，和RPC其他层次中会涉及到的技术，在后续的文章中进行逐步介绍。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/28/rpc-serialize-1/" data-id="cjcg8h2on002z5sudqdwpebwl" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/28/rpc-serialize-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/28/rpc-serialize-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-orika" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/15/orika/">打开orika的正确方式</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/15/orika/">
            <time datetime="2017-11-15T11:09:57.000Z" itemprop="datePublished">2017-11-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><h3 id="架构分层"><a href="#架构分层" class="headerlink" title="架构分层"></a>架构分层</h3><p>开发分布式的项目时，DO持久化对象和DTO传输对象的转换是不可避免的。集中式项目中，DO-DAO-SERVICE-WEB的分层再寻常不过，但分布式架构（或微服务架构）需要拆分模块时，不得不思考一个问题：WEB层能不能出现DAO或者DO对象？我给出的答案是否定的。</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/52029421305_2.gif" alt="新的项目分层结构"></p>
<p>这张图曾出现在我过去的文章中，其强调了一个分层的要素：服务层(应用层)和表现层应当解耦，后者不应当触碰到任何持久化对象，其所有的数据来源，均应当由前者提供。</p>
<h3 id="DTO的位置"><a href="#DTO的位置" class="headerlink" title="DTO的位置"></a>DTO的位置</h3><p>就系统的某一个模块，可以大致分成领域层model，接口定义层api，接口实现层/服务层service，表现层web。</p>
<ul>
<li>service 依赖 model +  api </li>
<li>web 依赖 api</li>
</ul>
<p>在我们系统构建初期，DTO对象被想当然的丢到了model层，这导致web对model产生了依赖；而在后期，为了满足前面的架构分层，最终将DTO对象移动到了api层（没有单独做一层）</p>
<h3 id="没有DTO时的痛点"><a href="#没有DTO时的痛点" class="headerlink" title="没有DTO时的痛点"></a>没有DTO时的痛点</h3><p>激发出DTO这样一个新的分层其实还有两个原因。</p>
<p>其一，便是我们再也不能忍受在RPC调用时JPA/hibernate懒加载这一特性带来的坑点。如果试图在消费端获取服务端传来的一个懒加载持久化对象，那么很抱歉，下意识就会发现这行不通，懒加载技术本质是使用字节码技术完成对象的代理，然而代理对象无法天然地远程传输，这与你的协议（RPC or HTTP）无关。</p>
<p>其二，远程调用需要额外注意网络传输的开销，如果生产者方从数据库加载出了一个一对多的依赖，而消费者只需要一这个实体的某个属性，多的实体会使得性能产生下降，并没有很好的方式对其进行控制（忽略手动set）。可能有更多痛点，由此可见，共享持久层，缺少DTO层时，我们的系统灵活性和性能都受到了制约。</p>
<h2 id="从DTO到Orika"><a href="#从DTO到Orika" class="headerlink" title="从DTO到Orika"></a>从DTO到Orika</h2><p>各类博客不乏对DTO的讨论，对领域驱动的理解，但却鲜有文章介绍，如何完成DO对象到DTO对象的转换。我们期待有一款高性能的，易用的工具来帮助我们完成实体类的转换。便引出了今天的主角：Orika。</p>
<h3 id="Orika是什么？"><a href="#Orika是什么？" class="headerlink" title="Orika是什么？"></a>Orika是什么？</h3><blockquote>
<p>Orika是一个简单、快速的JavaBean拷贝框架，它能够递归地将数据从一个JavaBean复制到另一个JavaBean，这在多层应用开发中是非常有用的。</p>
</blockquote>
<h3 id="Orika的竞品"><a href="#Orika的竞品" class="headerlink" title="Orika的竞品"></a>Orika的竞品</h3><p>相信大多数朋友接触过apache的BeanUtils，直到认识了spring的BeanUtils，前者被后者完爆，后来又出现了Dozer，Orika等重量级的Bean拷贝工具，在性能和特性上都有了很大的提升。</p>
<p>先给结论，众多Bean拷贝工具中，今天介绍的Orika具有想当大的优势。口说无凭，可参考下面文章中的各个工具的对比：<a href="http://tech.dianwoda.com/2017/11/04/gao-xing-neng-te-xing-feng-fu-de-beanying-she-gong-ju-orika/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">http://tech.dianwoda.com/2017/11/04/gao-xing-neng-te-xing-feng-fu-de-beanying-she-gong-ju-orika/?utm_source=tuicool&amp;utm_medium=referral</a> </p>
<p>简单整理后，如下所示：</p>
<ul>
<li><strong>BeanUtils</strong></li>
</ul>
<p>apache的<code>BeanUtils</code>和spring的<code>BeanUtils</code>中拷贝方法的原理都是先用jdk中 <code>java.beans.Introspector</code>类的<code>getBeanInfo()</code>方法获取对象的属性信息及属性get/set方法，接着使用反射（<code>Method</code>的<code>invoke(Object obj, Object... args)</code>）方法进行赋值。apache支持名称相同但类型不同的属性的转换，spring支持忽略某些属性不进行映射，他们都设置了缓存保存已解析过的<code>BeanInfo</code>信息。</p>
<ul>
<li><strong>BeanCopier</strong></li>
</ul>
<p>cglib的<code>BeanCopier</code>采用了不同的方法：它不是利用反射对属性进行赋值，而是直接使用ASM的<code>MethodVisitor</code>直接编写各属性的<code>get/set</code>方法（具体过程可见<code>BeanCopier</code>类的<code>generateClass(ClassVisitor v)</code>方法）生成class文件，然后进行执行。由于是直接生成字节码执行，所以<code>BeanCopier</code>的性能较采用反射的<code>BeanUtils</code>有较大提高，这一点可在后面的测试中看出。</p>
<ul>
<li><strong>Dozer</strong></li>
</ul>
<p>使用以上类库虽然可以不用手动编写<code>get/set</code>方法，但是他们都不能对不同名称的对象属性进行映射。在定制化的属性映射方面做得比较好的有<a href="http://note.youdao.com/" target="_blank" rel="external">Dozer</a>，Dozer支持简单属性映射、复杂类型映射、双向映射、隐式映射以及递归映射。可使用xml或者注解进行映射的配置，支持自动类型转换，使用方便。但Dozer底层是使用reflect包下<code>Field</code>类的<code>set(Object obj, Object value)</code>方法进行属性赋值，执行速度上不是那么理想。</p>
<ul>
<li><strong>Orika</strong></li>
</ul>
<p>那么有没有特性丰富，速度又快的Bean映射工具呢，这就是下面要介绍的<a href="http://note.youdao.com/" target="_blank" rel="external">Orika</a>，Orika是近期在github活跃的项目，底层采用了javassist类库生成Bean映射的字节码，之后直接加载执行生成的字节码文件，因此在速度上比使用反射进行赋值会快很多，下面详细介绍Orika的使用方法。</p>
<h2 id="Orika入门"><a href="#Orika入门" class="headerlink" title="Orika入门"></a>Orika入门</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ma.glasnost.orika<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>orika-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;orika.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><ul>
<li><strong>MapperFactory</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div></pre></td></tr></table></figure>
<p>MapperFactory用于注册字段映射，配置转换器，自定义映射器等，而我们关注的主要是字段映射这个特性，在下面的小节中会介绍。</p>
<ul>
<li><strong>MapperFacade</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MapperFacade mapper = mapperFactory.getMapperFacade();</div><div class="line">PersonSource source = <span class="keyword">new</span> PersonSource();</div><div class="line">PersonDest destination = mapper.map(source, PersonDest.class);</div></pre></td></tr></table></figure>
<p>MapperFacade和spring，apache中的BeanUtils具有相同的地位，负责对象间的映射，也是实际使用中，我们使用的最多的类。</p>
<p>至于转换器，自定义映射器等等概念，属于Orika的高级特性，也是Orika为什么被称作一个重量级框架的原因，引入Orika的初衷是为了高性能，易用的拷贝对象，引入它们会给系统带来一定的侵入性，所以本文暂不介绍，详细的介绍，可参考官方文档：<a href="http://orika-mapper.github.io/orika-docs/intro.html" target="_blank" rel="external">http://orika-mapper.github.io/orika-docs/intro.html</a></p>
<h3 id="映射字段名完全相同的对象"><a href="#映射字段名完全相同的对象" class="headerlink" title="映射字段名完全相同的对象"></a>映射字段名完全相同的对象</h3><p>如果DO对象和DTO对象的命名遵守一定的规范，那无疑会减少我们很大的工作量。那么，规范是怎么样的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  List&lt;Address&gt; addresses; <span class="comment">// &lt;1&gt;</span></div><div class="line">  <span class="comment">// getters/setters omitted</span></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonDto</span> </span>&#123; </div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  List&lt;AddressDto&gt; addresses; <span class="comment">// &lt;1&gt;</span></div><div class="line">  <span class="comment">// getters/setters omitted</span></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddressDto</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本字段类型自不用说，关键是打上<1>标签的地方，按照通常的习惯，<code>List&lt;AddressDto&gt;</code>变量名会被命名为addressDtos，但我更加推荐与DO对象统一命名，命名为addresses。这样Orika在映射时便可以自动映射两者。</1></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">Person person = <span class="keyword">new</span> Person();</div><div class="line"><span class="comment">//一顿赋值</span></div><div class="line">PersonDto personDto = mapperFactory.getMapperFacade().map(person, PersonDto.class);</div></pre></td></tr></table></figure>
<p>这样便完成了两个对象之间的拷贝，你可能会思考：需要我们指定两个类的映射关系吗？集合可以自动映射吗？这一切Orika都帮助我们完成了，在默认行为下，只要类的字段名相同，Orika便会尽自己最大的努力帮助我们映射。</p>
<h3 id="映射字段名不一致的对象"><a href="#映射字段名不一致的对象" class="headerlink" title="映射字段名不一致的对象"></a>映射字段名不一致的对象</h3><p>我对于DTO的理解是：DTO应当尽可能与DO的字段保持一致，不增不减不改，但可能出于一些特殊原因，需要映射两个名称不同的字段，Orika当然也支持这样常见的需求。只需要在MapperFactory中事先注册便可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line">  <span class="keyword">private</span> Name name;</div><div class="line">  <span class="keyword">private</span> List&lt;Name&gt; knownAliases;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Name</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String first;</div><div class="line">  <span class="keyword">private</span> String last; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonDto</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String personId;</div><div class="line">  <span class="keyword">private</span> String firstName;</div><div class="line">  <span class="keyword">private</span> String lastName;</div><div class="line">  <span class="keyword">private</span> Date birthDate;</div><div class="line">  <span class="keyword">private</span> String[][] aliases;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成上述两个结构不甚相似的对象时，则需要我们额外做一些工作，剩下的便和之前一致了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">factory.classMap(Person.class, PersonDto.class) <span class="comment">// &lt;2&gt;</span></div><div class="line">      .field(<span class="string">"id"</span>,<span class="string">"personId"</span>)</div><div class="line">      .field(<span class="string">"name.first"</span>, <span class="string">"firstName"</span>)</div><div class="line">      .field(<span class="string">"name.last"</span>, <span class="string">"lastName"</span>)</div><div class="line">      .field(<span class="string">"knownAliases&#123;first&#125;"</span>, <span class="string">"aliases&#123;[0]&#125;"</span>)</div><div class="line">      .field(<span class="string">"knownAliases&#123;last&#125;"</span>, <span class="string">"aliases&#123;[1]&#125;"</span>)</div><div class="line">      .byDefault() <span class="comment">//&lt;1&gt;</span></div><div class="line">      .register();</div></pre></td></tr></table></figure>
<p>这些<code>.{}[]</code>这些略微有点复杂的表达式不需要被掌握，只是想表明：如果你有这样需求，Orika也能支持。上述连续点的行为被称为 fluent-style ，这再不少框架中有体现。</p>
<p><1> 注意byDefault()这个方法，在指定了classMap行为之后，相同字段互相映射这样的默认行为需要调用一次这个方法，才能被继承。</1></p>
<p><2> classMap()方法返回了一个ClassMapBuilder对象，如上所示，我们见识到了它的field(),byDefault(),register()方法，这个建造者指定了对象映射的众多行为，还包括几个其他有用的方法：</2></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">classMapBuilder.field(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//Person和PersonDto的双向映射</span></div><div class="line">classMapBuilder.fieldAToB(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//单向映射  </span></div><div class="line">classMapBuilder.fieldBToA(<span class="string">"a"</span>,<span class="string">"b"</span>);<span class="comment">//单向映射</span></div><div class="line">classMapBuilder.exclude(<span class="string">"a"</span>);<span class="comment">//移除指定的字段映射，即使字段名相同也不会拷贝</span></div><div class="line">classMapBuilder.field(<span class="string">"a"</span>,<span class="string">"b"</span>).mapNulls(<span class="keyword">false</span>).mapNullsInReverse(<span class="keyword">false</span>);<span class="comment">//是否拷贝空属性，默认是true</span></div></pre></td></tr></table></figure>
<p>更多的API可以参见源码</p>
<h3 id="集合映射"><a href="#集合映射" class="headerlink" title="集合映射"></a>集合映射</h3><p>在类中我们之前已经见识过了List<address>与List<addressdto>的映射。如果根对象就是一个集合，List<person> 映射为 List<persondto>也是很常见的需求，这也很方便：</persondto></person></addressdto></address></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">List&lt;PersonDto&gt; personDtos = mapperFactory.getMapperFacade().mapAsList(persons, PersonDto.class);</div></pre></td></tr></table></figure>
<h3 id="递归映射"><a href="#递归映射" class="headerlink" title="递归映射"></a>递归映射</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> B b;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> C c;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> D d;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Orika默认支持递归映射。</p>
<h3 id="泛型映射"><a href="#泛型映射" class="headerlink" title="泛型映射"></a>泛型映射</h3><p>对泛型的支持是Orika的另一强大功能，这点在文档中只是被提及，网上并没有找到任何一个例子，所以在此我想稍微着重的介绍一下。既然文档没有相关的介绍，那如何了解Orika是怎样支持泛型映射的呢？只能翻出Orika的源码，在其丰富的测试用例中，可以窥见其对各种泛型特性的支持：<a href="https://github.com/orika-mapper/orika/tree/master/tests/src/main/java/ma/glasnost/orika/test/generics" target="_blank" rel="external">https://github.com/orika-mapper/orika/tree/master/tests/src/main/java/ma/glasnost/orika/test/generics</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseDto</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当出现泛型时，按照前面的思路去拷贝，看看结果会如何，泛型示例1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest1</span><span class="params">()</span></span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;String&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    response.setData(<span class="string">"test generic"</span>);</div><div class="line">    ResponseDto&lt;String&gt; responseDto = mapperFactory.getMapperFacade().map(response, ResponseDto.class);<span class="comment">// *</span></div><div class="line">    Assert.assertFalse(<span class="string">"test generic"</span>.equals(responseDto.getData()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会发现responseDto并不会Copy成功吗，特别是在*处，你会发现无所适从，没办法把ResponseDto<string>传递进去 ，同样的，还有下面的泛型示例2</string></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest2</span><span class="params">()</span></span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;Person&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    person.setName(<span class="string">"test generic"</span>);</div><div class="line">    response.setData(person);</div><div class="line">    Response&lt;PersonDto&gt; responseDto = mapperFactory.getMapperFacade().map(response, Response.class);</div><div class="line">    Assert.assertFalse(responseDto.getData() <span class="keyword">instanceof</span> PersonDto);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Response中的String和PersonDto在运行时(Runtime)泛型擦除这一特性难住了不少人，那么，Orika如何解决泛型映射呢？</p>
<p>我们可以发现MapperFacade的具有一系列的重载方法，对各种类型的泛型拷贝进行支持</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171117093043.png" alt="泛型支持"></p>
<p>可以看到几乎每个方法都传入了一个Type，用于获取拷贝类的真实类型，而不是传入.class字节码，下面介绍正确的打开姿势：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest1</span><span class="params">()</span> </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;String&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    response.setData(<span class="string">"test generic"</span>);</div><div class="line">    Type&lt;Response&lt;String&gt;&gt; fromType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;String&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Type&lt;ResponseDto&lt;String&gt;&gt; toType = <span class="keyword">new</span> TypeBuilder&lt;ResponseDto&lt;String&gt;&gt;() &#123;&#125;.build();</div><div class="line">    ResponseDto&lt;String&gt; responseDto = mapperFactory.getMapperFacade().map(response, fromType, toType);</div><div class="line">    Assert.assertTrue(<span class="string">"test generic"</span>.equals(responseDto.getData()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericTest2</span><span class="params">()</span> </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Response&lt;Person&gt; response = <span class="keyword">new</span> Response&lt;&gt;();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    person.setName(<span class="string">"test generic"</span>);</div><div class="line">    response.setData(person);</div><div class="line">    Type&lt;Response&lt;Person&gt;&gt; fromType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;Person&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Type&lt;Response&lt;PersonDto&gt;&gt; toType = <span class="keyword">new</span> TypeBuilder&lt;Response&lt;PersonDto&gt;&gt;() &#123;&#125;.build();</div><div class="line">    Response&lt;PersonDto&gt; responseDto = mapperFactory.getMapperFacade().map(response, fromType, toType);</div><div class="line">    Assert.assertEquals(<span class="string">"test generic"</span> , responseDto.getData().getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="浅拷贝or深拷贝"><a href="#浅拷贝or深拷贝" class="headerlink" title="浅拷贝or深拷贝"></a>浅拷贝or深拷贝</h3><p>虽然不值得一提，但职业敏感度还是催使我们想要测试一下，Orika是深拷贝还是浅拷贝，毕竟浅拷贝有时候会出现一些意想不到的坑点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deepCloneTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    MapperFactory mapperFactory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</div><div class="line">    Person person = <span class="keyword">new</span> Person();</div><div class="line">    Address address = <span class="keyword">new</span> Address();</div><div class="line">    person.setAddress(address);</div><div class="line">    PersonDto personDto = mapperFactory.getMapperFacade().map(person, PersonDto.class);</div><div class="line">    Assert.assertFalse(personDto.getAddress().hashCode() == person.getAddress().hashCode());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结论：在使用Orika时可以放心，其实现的是深拷贝，不用担心原始类和克隆类指向同一个对象的问题。</p>
<h3 id="更多的特性？"><a href="#更多的特性？" class="headerlink" title="更多的特性？"></a>更多的特性？</h3><p>你如果关心Orika是否能完成你某项特殊的需求，在这里可能会对你有所帮助：<a href="http://orika-mapper.github.io/orika-docs/faq.html" target="_blank" rel="external">http://orika-mapper.github.io/orika-docs/faq.html</a></p>
<p>怎么样，你是不是还在使用BeanUtils呢？尝试一下Orika吧！</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/15/orika/" data-id="cjcg8h2o3002m5sud4vllwj7o" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/15/orika/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/15/orika/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spi" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/09/spi/">JAVA拾遗--关于SPI机制</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/09/spi/">
            <time datetime="2017-11-09T08:18:51.000Z" itemprop="datePublished">2017-11-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>JDK提供的SPI(Service Provider Interface)机制，可能很多人不太熟悉，因为这个机制是针对厂商或者插件的，也可以在一些框架的扩展中看到。其核心类<code>java.util.ServiceLoader</code>可以在<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html" target="_blank" rel="external">jdk1.8</a>的文档中看到详细的介绍。虽然不太常见，但并不代表它不常用，恰恰相反，你无时无刻不在用它。玄乎了，莫急，思考一下你的项目中是否有用到第三方日志包，是否有用到数据库驱动？其实这些都和SPI有关。再来思考一下，现代的框架是如何加载日志依赖，加载数据库驱动的，你可能会对class.forName(“com.mysql.jdbc.Driver”)这段代码不陌生，这是每个java初学者必定遇到过的，但如今的数据库驱动仍然是这样加载的吗？你还能找到这段代码吗？这一切的疑问，将在本篇文章结束后得到解答。</p>
<p>首先介绍SPI机制是个什么东西</p>
<h2 id="实现一个自定义的SPI"><a href="#实现一个自定义的SPI" class="headerlink" title="实现一个自定义的SPI"></a>实现一个自定义的SPI</h2><h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1 项目结构"></a>1 项目结构</h3><p><img src="http://ov0zuistv.bkt.clouddn.com/spi_%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="SPI项目结构"></p>
<ol>
<li>invoker是我们的用来测试的主项目。</li>
<li>interface是针对厂商和插件商定义的接口项目，只提供接口，不提供实现。</li>
<li>good-printer,bad-printer分别是两个厂商对interface的不同实现，所以他们会依赖于interface项目。</li>
</ol>
<p>这个简单的demo就是让大家体验，在不改变invoker代码，只更改依赖的前提下，切换interface的实现厂商。</p>
<h3 id="2-interface模块"><a href="#2-interface模块" class="headerlink" title="2 interface模块"></a>2 interface模块</h3><p><strong>2.1 moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Printer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>interface只定义一个接口，不提供实现。规范的制定方一般都是比较牛叉的存在，这些接口通常位于java，javax前缀的包中。这里的Printer就是模拟一个规范接口。</p>
<h3 id="3-good-printer模块"><a href="#3-good-printer模块" class="headerlink" title="3 good-printer模块"></a>3 good-printer模块</h3><p><strong>3.1 good-printer\pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>规范的具体实现类必然要依赖规范接口</p>
<p><strong>3.2 moe.cnkirito.spi.api.GoodPrinter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodPrinter</span> <span class="keyword">implements</span> <span class="title">Printer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"你是个好人~"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作为Printer规范接口的实现一</p>
<p><strong>3.3 resources\META-INF\services\moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">moe.cnkirito.spi.api.GoodPrinter</div></pre></td></tr></table></figure>
<p>这里需要重点说明，每一个SPI接口都需要在自己项目的静态资源目录中声明一个services文件，文件名为实现规范接口的类名全路径，在此例中便是<code>moe.cnkirito.spi.api.Printer</code>，在文件中，则写上一行具体实现类的全路径，在此例中便是<code>moe.cnkirito.spi.api.GoodPrinter</code>。</p>
<p>这样一个厂商的实现便完成了。</p>
<h3 id="4-bad-printer模块"><a href="#4-bad-printer模块" class="headerlink" title="4 bad-printer模块"></a>4 bad-printer模块</h3><p>我们在按照和good-printer模块中定义的一样的方式，完成另一个厂商对Printer规范的实现。</p>
<p><strong>4.1 bad-printer\pom.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>4.2 moe.cnkirito.spi.api.BadPrinter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadPrinter</span> <span class="keyword">implements</span> <span class="title">Printer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"我抽烟，喝酒，蹦迪，但我知道我是好女孩~"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>4.3 resources\META-INF\services\moe.cnkirito.spi.api.Printer</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">moe.cnkirito.spi.api.BadPrinter</div></pre></td></tr></table></figure>
<p>这样，另一个厂商的实现便完成了。</p>
<p><strong>5 invoker模块</strong></p>
<p>这里的invoker便是我们自己的项目了。如果一开始我们想使用厂商good-printer的Printer实现，是需要将其的依赖引入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>good-printer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>5.1 编写调用主类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ServiceLoader&lt;Printer&gt; printerLoader = ServiceLoader.load(Printer.class);</div><div class="line">        <span class="keyword">for</span> (Printer printer : printerLoader) &#123;</div><div class="line">            printer.print();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServiceLoader是<code>java.util</code>提供的用于加载固定类路径下文件的一个加载器，正是它加载了对应接口声明的实现类。</p>
<p><strong>5.2 打印结果1</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">你是个好人~</div></pre></td></tr></table></figure>
<p>如果在后续的方案中，想替换厂商的Printer实现，只需要将依赖更换</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>moe.cnkirito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bad-printer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>调用主类无需变更代码，这符合开闭原则</p>
<p><strong>5.3 打印结果2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">我抽烟，喝酒，蹦迪，但我知道我是好女孩~</div></pre></td></tr></table></figure>
<p>是不是很神奇呢？这一切对于调用者来说都是透明的，只需要切换依赖即可！</p>
<h2 id="SPI在实际项目中的应用"><a href="#SPI在实际项目中的应用" class="headerlink" title="SPI在实际项目中的应用"></a>SPI在实际项目中的应用</h2><p>先总结下有什么新知识，resources/META-INF/services下的文件似乎我们之前没怎么接触过，ServiceLoader也没怎么接触过。那么现在我们打开自己项目的依赖，看看有什么发现。</p>
<ol>
<li><p>在mysql-connector-java-xxx.jar中发现了META-INF\services\java.sql.Driver文件，里面只有两行记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">com.mysql.jdbc.Driver</div><div class="line">com.mysql.fabric.jdbc.FabricMySQLDriver</div></pre></td></tr></table></figure>
<p>我们可以分析出，<code>java.sql.Driver</code>是一个规范接口，<code>com.mysql.jdbc.Driver</code><br><code>com.mysql.fabric.jdbc.FabricMySQLDriver</code>则是mysql-connector-java-xxx.jar对这个规范的实现接口。</p>
</li>
<li><p>在jcl-over-slf4j-xxxx.jar中发现了META-INF\services\org.apache.commons.logging.LogFactory文件，里面只有一行记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">org.apache.commons.logging.impl.SLF4JLogFactory</div></pre></td></tr></table></figure>
<p>相信不用我赘述，大家都能理解这是什么含义了</p>
</li>
<li><p>更多的还有很多，有兴趣可以自己翻一翻项目路径下的那些jar包</p>
</li>
</ol>
<p>既然说到了数据库驱动，索性再多说一点，还记得一道经典的面试题：class.forName(“com.mysql.jdbc.Driver”)到底做了什么事？</p>
<p>先思考下：自己会怎么回答？</p>
<p>都知道class.forName与类加载机制有关，会触发执行com.mysql.jdbc.Driver类中的静态方法，从而使主类加载数据库驱动。如果再追问，为什么它的静态块没有自动触发？可答：因为数据库驱动类的特殊性质，JDBC规范中明确要求Driver类必须向DriverManager注册自己，导致其必须由class.forName手动触发，这可以在java.sql.Driver中得到解释。完美了吗？还没，来到最新的DriverManager源码中，可以看到这样的注释,翻译如下：</p>
<blockquote>
<p><code>DriverManager</code> 类的方法 <code>getConnection</code> 和 <code>getDrivers</code> 已经得到提高以支持 Java Standard Edition <a href="http://tool.oschina.net/uploads/apidocs/technotes/guides/jar/jar.html#Service%20Provider" target="_blank" rel="external">Service Provider</a> 机制。 JDBC 4.0 Drivers 必须包括 <code>META-INF/services/java.sql.Driver</code> 文件。此文件包含 <code>java.sql.Driver</code> 的 JDBC 驱动程序实现的名称。例如，要加载 <code>my.sql.Driver</code> 类，<code>META-INF/services/java.sql.Driver</code> 文件需要包含下面的条目：</p>
<p> <strong>my.sql.Driver</strong></p>
<p>应用程序不再需要使用 <code>Class.forName()</code> 显式地加载 JDBC 驱动程序。当前使用 <code>Class.forName()</code> 加载 JDBC 驱动程序的现有程序将在不作修改的情况下继续工作。</p>
</blockquote>
<p>可以发现，Class.forName已经被弃用了，所以，这道题目的最佳回答，应当是和面试官牵扯到JAVA中的SPI机制，进而聊聊加载驱动的演变历史。</p>
<p><strong>java.sql.DriverManager</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</div><div class="line">    Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</div><div class="line"></div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</div><div class="line">            driversIterator.next();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span>(Throwable t) &#123;</div><div class="line">    <span class="comment">// Do nothing</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然那，本节的内容还是主要介绍SPI，驱动这一块这是引申而出，如果不太理解，可以多去翻一翻jdk1.8中Driver和DriverManager的源码，相信会有不小的收获。</p>
<h2 id="SPI在扩展方面的应用"><a href="#SPI在扩展方面的应用" class="headerlink" title="SPI在扩展方面的应用"></a>SPI在扩展方面的应用</h2><p>SPI不仅仅是为厂商指定的标准，同样也为框架扩展提供了一个思路。框架可以预留出SPI接口，这样可以在不侵入代码的前提下，通过增删依赖来扩展框架。前提是，框架得预留出核心接口，也就是本例中interface模块中类似的接口，剩下的适配工作便留给了开发者。</p>
<p>例如我的上一篇文章 <a href="https://www.cnkirito.moe/2017/11/07/spring-cloud-sleuth/" target="_blank" rel="external">https://www.cnkirito.moe/2017/11/07/spring-cloud-sleuth/</a> 中介绍的motan中Filter的扩展，便是采用了SPI机制，熟悉这个设定之后再回头去了解一些框架的SPI扩展就不会太陌生了。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/09/spi/" data-id="cjcg8h2ov00395sud04v6gy29" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/09/spi/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/09/spi/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-cloud-sleuth" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/07/spring-cloud-sleuth/">使用Spring Cloud Sleuth实现链路监控</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/07/spring-cloud-sleuth/">
            <time datetime="2017-11-07T08:58:01.000Z" itemprop="datePublished">2017-11-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Cloud/">Spring Cloud</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>在服务比较少的年代，一个系统的接口响应缓慢通常能够迅速被发现，但如今的微服务模块，大多具有规模大，依赖关系复杂等特性，错综复杂的网状结构使得我们不容易定位到某一个执行缓慢的接口。分布式的服务跟踪组件就是为了解决这一个问题。其次，它解决了另一个难题，在没有它之前，我们客户会一直询问：你们的系统有监控吗？你们的系统有监控吗？你们的系统有监控吗？现在，谢天谢地，他们终于不问了。是有点玩笑的成分，但可以肯定的一点是，实现全链路监控是保证系统健壮性的关键因子。</p>
<p>介绍Spring Cloud Sleuth和Zipkin的文章在网上其实并不少，所以我打算就我目前的系统来探讨一下，如何实现链路监控。全链路监控这个词意味着只要是不同系统模块之间的调用都应当被监控，这就包括了如下几种常用的交互方式：</p>
<p>1 Http协议，如RestTemplate，Feign，Okhttp3，HttpClient…</p>
<p>2 Rpc远程调用，如Motan，Dubbo，GRPC…</p>
<p>3 分布式Event，如RabbitMq，Kafka…</p>
<p>而我们项目目前混合使用了Http协议，Motan Rpc协议，所以本篇文章会着墨于实现这两块的链路监控。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/sleuth%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7.png" alt="项目结构"></p>
<p>上面的项目结构是本次demo的核心结构，其中</p>
<ol>
<li>zipkin-server作为服务跟踪的服务端，记录各个模块发送而来的调用请求，最终形成调用链路的报告。</li>
<li>order,goods两个模块为用来做测试的业务模块，分别实现了http形式和rpc形式的远程调用，最终我们会在zipkin-server的ui页面验证他们的调用记录。</li>
<li>interface存放了order和goods模块的公用接口，rpc调用需要一个公用的接口。</li>
<li>filter-opentracing存放了自定义的motan扩展代码，用于实现motan rpc调用的链路监控。</li>
</ol>
<h2 id="Zipkin服务端"><a href="#Zipkin服务端" class="headerlink" title="Zipkin服务端"></a>Zipkin服务端</h2><p><strong>添加依赖</strong></p>
<p><a href="https://github.com/lexburner/sleuth-starter/blob/master/zipkin-server/pom.xml" target="_blank" rel="external">全部依赖</a></p>
<p><strong>核心依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-storage-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.28.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>zipkin-autoconfigure-ui</code>提供了默认了UI页面，<code>zipkin-storage-mysql</code>选择将链路调用信息存储在mysql中，更多的选择可以有<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/elasticsearch" target="_blank" rel="external">elasticsearch</a>，<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/cassandra" target="_blank" rel="external">cassandra</a>。</p>
<p><strong>zipkin-server/src/main/resources/application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">zipkin-server</span></div><div class="line"><span class="attr">  datasource:</span></div><div class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://localhost:3306/zipkin</span></div><div class="line"><span class="attr">    username:</span> <span class="string">root</span></div><div class="line"><span class="attr">    password:</span> <span class="string">root</span></div><div class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></div><div class="line"><span class="attr">zipkin:</span></div><div class="line"><span class="attr">   storage:</span></div><div class="line"><span class="attr">      type:</span> <span class="string">mysql</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9411</span></div></pre></td></tr></table></figure>
<p><strong>创建启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableZipkinServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipkinServerApp</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MySQLStorage <span class="title">mySQLStorage</span><span class="params">(DataSource datasource)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MySQLStorage.builder().datasource(datasource).executor(Runnable::run).build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(ZipkinServerApp.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当前版本在手动配置数据库之后才不会启动报错，可能与版本有关。mysql相关的脚本可以在此处下载：<a href="https://github.com/lexburner/sleuth-starter/blob/master/zipkin-server/src/main/resources/mysql.sql" target="_blank" rel="external">mysql初始化脚本</a>。</p>
<p>zipkin-server单独启动后，就可以看到链路监控页面了，此时由于没有收集到任何链路调用记录，显示如下：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/zipkin_blank.png" alt="zipkin服务端页面"></p>
<h2 id="HTTP链路监控"><a href="#HTTP链路监控" class="headerlink" title="HTTP链路监控"></a>HTTP链路监控</h2><p>编写order和goods两个服务，在order暴露一个http端口，在goods中使用RestTemplate远程调用，之后查看在zipkin服务端查看调用信息。</p>
<p>首先添加依赖，让普通的应用具备收集和发送报告的能力，这一切在spring cloud sleuth的帮助下都变得很简单</p>
<p><strong>添加依赖</strong></p>
<p><a href="">全部依赖</a></p>
<p><strong>核心依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>spring-cloud-starter-zipkin</code>依赖内部包含了两个依赖，等于同时引入了<code>spring-cloud-starter-sleuth</code>，<code>spring-cloud-sleuth-zipkin</code>两个依赖。名字特别像，注意区分。</p>
<p>以order为例介绍配置文件</p>
<p><strong>order/src/main/resources/application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">order</span> <span class="comment"># 1</span></div><div class="line"><span class="attr">  zipkin:</span></div><div class="line"><span class="attr">    base-url:</span> <span class="attr">http://localhost:9411</span> <span class="comment"># 2</span></div><div class="line"><span class="attr">  sleuth:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    sampler:</span></div><div class="line"><span class="attr">      percentage:</span> <span class="number">1</span> <span class="comment"># 3</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8060</span></div></pre></td></tr></table></figure>
<p><1> 指定项目名称可以方便的标记应用，在之后的监控页面可以看到这里的配置名称</1></p>
<p><2> 指定zipkin的服务端，用于发送链路调用报告</2></p>
<p><3> 采样率，值为[0,1]之间的任意实数，顾名思义，这里代表100%采集报告。</3></p>
<p><strong>编写调用类</strong></p>
<p>服务端order</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line"></div><div class="line">    Logger logger = LoggerFactory.getLogger(OrderController.class);</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/order/&#123;id&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> MainOrder <span class="title">getOrder</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</div><div class="line">        logger.info(<span class="string">"order invoking ..."</span>); <span class="comment">//&lt;1&gt;</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MainOrder(id, <span class="keyword">new</span> BigDecimal(<span class="number">200</span>D), <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端goods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MainOrder <span class="title">test</span><span class="params">()</span></span>&#123;</div><div class="line">    ResponseEntity&lt;MainOrder&gt; mainOrderResponseEntity = restTemplate.getForEntity(<span class="string">"http://localhost:8060/api/order/1144"</span>, MainOrder.class);</div><div class="line">    MainOrder body = mainOrderResponseEntity.getBody();</div><div class="line">    <span class="keyword">return</span> body;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 首先观察这一行日志在控制台是如何输出的</1></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017-11-08 09:54:00.633  INFO [order,d251f40af64361d2,e46132755dc395e1,true] 2780 --- [nio-8060-exec-1] m.c.sleuth.order.web.OrderController     : order invoking ...</div></pre></td></tr></table></figure>
<p>比没有引入sleuth之前多了一些信息，其中<code>order,d251f40af64361d2,e46132755dc395e1,true</code>分别代表了应用名称，traceId，spanId，当前调用是否被采集，关于trace，span这些专业词语，强烈建议去看看Dapper这篇论文，有很多中文翻译版本，并不是想象中的学术范，非常容易理解，很多链路监控文章中的截图都来自于这篇论文，我在此就不再赘述概念了。</p>
<p>紧接着，回到zipkin-server的监控页面，查看变化</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0%E8%A2%AB%E8%AE%B0%E5%BD%95.png" alt="应用名称"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E6%9F%A5%E7%9C%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E7%BB%86%E8%AE%B0%E5%BD%95.png" alt="调用详细记录"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E6%9F%A5%E7%9C%8B.png" alt="依赖关系"></p>
<p>到这里，Http监控就已经完成了，如果你的应用使用了其他的Http工具，如okhttp3，也可以去[opentracing，zipkin相关的文档中寻找依赖。</p>
<h2 id="RPC链路监控"><a href="#RPC链路监控" class="headerlink" title="RPC链路监控"></a>RPC链路监控</h2><p>虽说spring cloud是大势所趋，其推崇的http调用方式也是链路监控的主要对象，但不得不承认目前大多数的系统内部调用仍然是RPC的方式，至少我们内部的系统是如此，由于我们内部采用的RPC框架是weibo开源的motan，这里以此为例，介绍RPC的链路监控。motan使用SPI机制，实现了对链路监控的支持，<a href="https://github.com/weibocom/motan/issues/304这条issue中可以得知其加入了opentracing标准化追踪。但目前只能通过自己添加组件的方式才能配合spring-cloud-sleuth使用，下面来看看实现步骤。" target="_blank" rel="external">https://github.com/weibocom/motan/issues/304这条issue中可以得知其加入了opentracing标准化追踪。但目前只能通过自己添加组件的方式才能配合spring-cloud-sleuth使用，下面来看看实现步骤。</a></p>
<p><strong>filter-opentracing</strong></p>
<p>实现思路：引入SleuthTracingFilter，作为全局的motan过滤器，给每一次motan的调用打上traceId和spanId，并编写一个SleuthTracingContext，持有一个SleuthTracerFactory工厂，用于适配不同的Tracer实现。</p>
<p>具体的实现可以参考文末的地址</p>
<p><strong>order/src/main/resources/META-INF/services/com.weibo.api.motan.filter.Filter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.weibo.api.motan.filter.sleuth.SleuthTracingFilter</div></pre></td></tr></table></figure>
<p>添加一行过滤器的声明，使得项目能够识别</p>
<p><strong>配置SleuthTracingContext</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function">SleuthTracingContext <span class="title">sleuthTracingContext</span><span class="params">(@Autowired(required = <span class="keyword">false</span>)</span>  org.springframework.cloud.sleuth.Tracer tracer)</span>&#123;</div><div class="line">    SleuthTracingContext context = <span class="keyword">new</span> SleuthTracingContext();</div><div class="line">    context.setTracerFactory(<span class="keyword">new</span> SleuthTracerFactory() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> org.springframework.cloud.sleuth.<span class="function">Tracer <span class="title">getTracer</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> tracer;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用spring-cloud-sleuth的Tracer作为motan调用的收集器</p>
<p><strong>为服务端和客户端配置过滤器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">basicServiceConfigBean.setFilter(<span class="string">"sleuth-tracing"</span>);</div><div class="line"></div><div class="line">basicRefererConfigBean.setFilter(<span class="string">"sleuth-tracing"</span>);</div></pre></td></tr></table></figure>
<p><strong>编写调用测试类</strong></p>
<p>order作为客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MotanReferer</span></div><div class="line">GoodsApi goodsApi;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/goods"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getGoodsList</span><span class="params">()</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"getGoodsList invoking ..."</span>);</div><div class="line">    <span class="keyword">return</span> goodsApi.getGoodsList();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>goods作为服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MotanService</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsApiImpl</span> <span class="keyword">implements</span> <span class="title">GoodsApi</span> </span>&#123;</div><div class="line"></div><div class="line">    Logger logger = LoggerFactory.getLogger(GoodsApiImpl.class);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGoodsList</span><span class="params">()</span> </span>&#123;</div><div class="line">        logger.info(<span class="string">"GoodsApi invoking ..."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>查看调用关系</strong></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E9%93%BE%E8%B7%AF%E8%B0%83%E7%94%A8%E4%BF%A1%E6%81%AF.png" alt="motan调用详细信息"></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/motan_%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB.png" alt="依赖关系"></p>
<p>第一张图中，使用前缀http和motan来区别调用的类型，第二张图中，依赖变成了双向的，因为一开始的http调用goods依赖于order，而新增了motan rpc调用之后order又依赖于goods。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>系统间交互的方式除了http，rpc，还有另外的方式如mq，以后还可能会有更多的方式，但实现的监控的思路都是一致的，即如何无侵入式地给调用打上标签，记录报告。Dapper给实现链路监控提供了一个思路，而OpenTracing为各个框架不同的调用方式提供了适配接口….Spring Cloud Sleuth则是遵循了Spring一贯的风格，整合了丰富的资源，为我们的系统集成链路监控提供了很大的便捷性。</p>
<p>关于motan具体实现链路监控的代码由于篇幅限制，将源码放在了我的github中，如果你的系统使用了motan，可以用于参考：<a href="https://github.com/lexburner/sleuth-starter" target="_blank" rel="external">https://github.com/lexburner/sleuth-starter</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《Spring Cloud微服务实战》– 翟永超</p>
<p>黄桂钱老师的指导</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/" data-id="cjcg8h2p0003g5sudxbqk13no" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/11/07/spring-cloud-sleuth/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-data-redis-2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/28/spring-data-redis-2/">Spring Data Redis（二）--序列化</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/28/spring-data-redis-2/">
            <time datetime="2017-10-28T08:10:55.000Z" itemprop="datePublished">2017-10-28</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Data-Redis/">Spring Data Redis</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="默认序列化方案"><a href="#默认序列化方案" class="headerlink" title="默认序列化方案"></a>默认序列化方案</h2><p>在上一篇文章《Spring Data Redis（一）》中，我们执行了这样一个操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redisTemplate.opsForValue().set(<span class="string">"student:1"</span>,<span class="string">"kirito"</span>);</div></pre></td></tr></table></figure>
<p>试图使用RedisTemplate在Redis中存储一个键为“student:1”，值为“kirito”的String类型变量（redis中通常使用‘:’作为键的分隔符）。那么是否真的如我们所预想的那样，在Redis中存在这样的键值对呢？</p>
<p>这可以说是Redis中最基础的操作了，但严谨起见，还是验证一下为妙，使用RedisDesktopManager可视化工具，或者redis-cli都可以查看redis中的数据。</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028125803.png" alt="查看redis"></p>
<p>emmmmm，大概能看出是我们的键值对，但前面似乎多了一些奇怪的16进制字符，在不了解RedisTemplate工作原理的情况下，自然会对这个现象产生疑惑。</p>
<p>首先看看springboot如何帮我们自动完成RedisTemplate的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">     <span class="meta">@Bean</span></div><div class="line">     <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</div><div class="line">     <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">           RedisConnectionFactory redisConnectionFactory)</span></span></div><div class="line"><span class="function">                 <span class="keyword">throws</span> UnknownHostException </span>&#123;</div><div class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;Object, Object&gt;();</div><div class="line">        template.setConnectionFactory(redisConnectionFactory);</div><div class="line">        <span class="keyword">return</span> template;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没看出什么特殊的设置，于是我们进入RedisTemplate自身的源码中一窥究竟。</p>
<p>首先是在类开头声明了一系列的序列化器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> enableDefaultSerializer = <span class="keyword">true</span>;<span class="comment">// 配置默认序列化器</span></div><div class="line"><span class="keyword">private</span> RedisSerializer&lt;?&gt; defaultSerializer;</div><div class="line"><span class="keyword">private</span> ClassLoader classLoader;</div><div class="line"></div><div class="line"><span class="keyword">private</span> RedisSerializer keySerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer valueSerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer hashKeySerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer hashValueSerializer = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">private</span> RedisSerializer&lt;String&gt; stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</div></pre></td></tr></table></figure>
<p>看到了我们关心的<code>keySerializer</code>和<code>valueSerializer</code>，在RedisTemplate.afterPropertiesSet()方法中，可以看到，默认的序列化方案:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">super</span>.afterPropertiesSet();</div><div class="line">     <span class="keyword">boolean</span> defaultUsed = <span class="keyword">false</span>;</div><div class="line">     <span class="keyword">if</span> (defaultSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">        defaultSerializer = <span class="keyword">new</span> JdkSerializationRedisSerializer(</div><div class="line">              classLoader != <span class="keyword">null</span> ? classLoader : <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (enableDefaultSerializer) &#123;</div><div class="line">        <span class="keyword">if</span> (keySerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           keySerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (valueSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           valueSerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hashKeySerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           hashKeySerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hashValueSerializer == <span class="keyword">null</span>) &#123;</div><div class="line">           hashValueSerializer = defaultSerializer;</div><div class="line">           defaultUsed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	...</div><div class="line">    initialized = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>默认的方案是使用了<code>JdkSerializationRedisSerializer</code>，所以导致了前面的结果，注意：字符串和使用jdk序列化之后的字符串是两个概念。</p>
<p>我们可以查看set方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">byte</span>[] rawValue = rawValue(value);</div><div class="line">   execute(<span class="keyword">new</span> ValueDeserializingRedisCallback(key) &#123;</div><div class="line"></div><div class="line">      <span class="keyword">protected</span> <span class="keyword">byte</span>[] inRedis(<span class="keyword">byte</span>[] rawKey, RedisConnection connection) &#123;</div><div class="line">         connection.set(rawKey, rawValue);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">   &#125;, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终与Redis交互使用的是原生的connection，键值则全部是字节数组，意味着所有的序列化都依赖于应用层完成，Redis只认字节！这也是引出本节介绍的初衷，序列化是与Redis打交道很关键的一个环节。</p>
<h2 id="StringRedisSerializer"><a href="#StringRedisSerializer" class="headerlink" title="StringRedisSerializer"></a>StringRedisSerializer</h2><p>在我不长的使用Redis的时间里，其实大多数操作是字符串操作，键值均为字符串，String.getBytes()即可满足需求。spring-data-redis也考虑到了这一点，其一，提供了StringRedisSerializer的实现，其二，提供了StringRedisTemplate，继承自RedisTemplate。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringRedisTemplate</span> <span class="keyword">extends</span> <span class="title">RedisTemplate</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRedisTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        RedisSerializer&lt;String&gt; stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line">        setKeySerializer(stringSerializer);</div><div class="line">        setValueSerializer(stringSerializer);</div><div class="line">        setHashKeySerializer(stringSerializer);</div><div class="line">        setHashValueSerializer(stringSerializer);</div><div class="line">    &#125;</div><div class="line">  	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即只能存取字符串。尝试执行如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line">StringRedisTemplate stringRedisTemplate;</div><div class="line"></div><div class="line">stringRedisTemplate.opsForValue().set(<span class="string">"student:2"</span>, <span class="string">"SkYe"</span>);</div></pre></td></tr></table></figure>
<p>再同样观察RedisDesktopManager中的变化：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028140012.png" alt="查看redis"></p>
<p>由于更换了序列化器，我们得到的结果也不同了。</p>
<h2 id="项目中序列化器使用的注意点"><a href="#项目中序列化器使用的注意点" class="headerlink" title="项目中序列化器使用的注意点"></a>项目中序列化器使用的注意点</h2><p>理论上，字符串（本质是字节）其实是万能格式，是否可以使用StringRedisTemplate将复杂的对象存入Redis中，答案当然是肯定的。可以在应用层手动将对象序列化成字符串，如使用fastjson，jackson等工具，反序列化时也是通过字符串还原出原来的对象。而如果是用<code>redisTemplate.opsForValue().set(&quot;student:3&quot;,new Student(3,&quot;kirito&quot;));</code>便是依赖于内部的序列化器帮我们完成这样的一个流程，和使用<code>stringRedisTemplate.opsForValue().set(&quot;student:3&quot;,JSON.toJSONString(new Student(3,&quot;kirito&quot;)));</code></p>
<p>其实是一个等价的操作。但有两点得时刻记住两点:</p>
<ol>
<li>Redis只认字节。</li>
<li>使用什么样的序列化器序列化，就必须使用同样的序列化器反序列化。</li>
</ol>
<p>曾经在review代码时发现，项目组的两位同事操作redis，一个使用了RedisTemplate，一个使用了StringRedisTemplate，当他们操作同一个键时，key虽然相同，但由于序列化器不同，导致无法获取成功。差异虽小，但影响是非常可怕的。</p>
<p>另外一点是，微服务不同模块连接了同一个Redis，在共享内存中交互数据，可能会由于版本升级，模块差异，导致相互的序列化方案不一致，也会引起问题。如果项目中途切换了序列化方案，也可能会引起Redis中老旧持久化数据的反序列化异常，同样需要引起注意。最优的方案自然是在项目初期就统一好序列化方案，所有模块引用同一份依赖，避免不必要的麻烦（或者干脆全部使用默认配置）。</p>
<h2 id="序列化接口RedisSerializer"><a href="#序列化接口RedisSerializer" class="headerlink" title="序列化接口RedisSerializer"></a>序列化接口RedisSerializer</h2><p>无论是RedisTemplate中默认使用的<code>JdkSerializationRedisSerializer</code>，还是StringRedisTemplate中使用的<code>StringRedisSerializer</code>都是实现自统一的接口<code>RedisSerializer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">   <span class="keyword">byte</span>[] serialize(T t) <span class="keyword">throws</span> SerializationException;</div><div class="line">   <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在spring-data-redis中提供了其他的默认实现，用于替换默认的序列化方案。</p>
<ul>
<li>GenericToStringSerializer 依赖于内部的ConversionService，将所有的类型转存为字符串</li>
<li>GenericJackson2JsonRedisSerializer和Jackson2JsonRedisSerializer 以JSON的形式序列化对象</li>
<li>OxmSerializer 以XML的形式序列化对象</li>
</ul>
<p>我们可能出于什么样的目的修改序列化器呢？按照个人理解可以总结为以下几点：</p>
<ol>
<li>各个工程间约定了数据格式，如使用JSON等通用数据格式，可以让异构的系统接入Redis同样也能识别数据，而JdkSerializationRedisSerializer则不具备这样灵活的特性</li>
<li>数据的可视化，在项目初期我曾经偏爱JSON序列化，在运维时可以清晰地查看各个value的值，非常方便。</li>
<li>效率问题，如果需要将大的对象存入Value中，或者Redis IO非常频繁，替换合适的序列化器便可以达到优化的效果。</li>
</ol>
<h2 id="替换默认的序列化器"><a href="#替换默认的序列化器" class="headerlink" title="替换默认的序列化器"></a>替换默认的序列化器</h2><p>可以将全局的RedisTemplate覆盖，也可以在使用时在局部实例化一个RedisTemplate替换（不依赖于IOC容器）需要根据实际的情况选择替换的方式，以Jackson2JsonRedisSerializer为例介绍全局替换的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</div><div class="line">    RedisTemplate redisTemplate = <span class="keyword">new</span> RedisTemplate();</div><div class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</div><div class="line">    Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</div><div class="line"></div><div class="line">    ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();<span class="comment">// &lt;1&gt;</span></div><div class="line">    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</div><div class="line">    objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</div><div class="line"></div><div class="line">    jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</div><div class="line"></div><div class="line">    redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer()); <span class="comment">// &lt;2&gt;</span></div><div class="line">    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer); <span class="comment">// &lt;2&gt;</span></div><div class="line"></div><div class="line">    redisTemplate.afterPropertiesSet();</div><div class="line">    <span class="keyword">return</span> redisTemplate;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 修改Jackson序列化时的默认行为</1></p>
<p><2> 手动指定RedisTemplate的Key和Value的序列化器</2></p>
<p>然后使用RedisTemplate进行保存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line">StringRedisTemplate stringRedisTemplate;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    Student student3 = <span class="keyword">new</span> Student();</div><div class="line">    student3.setName(<span class="string">"kirito"</span>);</div><div class="line">    student3.setId(<span class="string">"3"</span>);</div><div class="line">    student3.setHobbies(Arrays.asList(<span class="string">"coding"</span>,<span class="string">"write blog"</span>,<span class="string">"eat chicken"</span>));</div><div class="line">    redisTemplate.opsForValue().set(<span class="string">"student:3"</span>,student3);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着，去RedisDesktopManager中查看结果：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171028225412.png" alt="查看Redis"></p>
<p>标准的JSON格式</p>
<h2 id="实现Kryo序列化"><a href="#实现Kryo序列化" class="headerlink" title="实现Kryo序列化"></a>实现Kryo序列化</h2><p>我们也可以考虑根据自己项目和需求的特点，扩展序列化器，这是非常方便的。比如前面提到的，为了追求性能，可能考虑使用Kryo序列化器替换缓慢的JDK序列化器，如下是一个参考实现（为了demo而写，未经过生产验证）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoRedisSerializer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(KryoRedisSerializer.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; kryos = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            Kryo kryo = <span class="keyword">new</span> Kryo();</div><div class="line">            <span class="keyword">return</span> kryo;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> SerializationException &#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"serialize param must not be null"</span>);</div><div class="line">        &#125;</div><div class="line">        Kryo kryo = kryos.get();</div><div class="line">        Output output = <span class="keyword">new</span> Output(<span class="number">64</span>, -<span class="number">1</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            kryo.writeClassAndObject(output, obj);</div><div class="line">            <span class="keyword">return</span> output.toBytes();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            closeOutputStream(output);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        Kryo kryo = kryos.get();</div><div class="line">        Input input = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            input = <span class="keyword">new</span> Input(bytes);</div><div class="line">            <span class="keyword">return</span> (T) kryo.readClassAndObject(input);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            closeInputStream(input);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeOutputStream</span><span class="params">(OutputStream output)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (output != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                output.flush();</div><div class="line">                output.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(<span class="string">"serialize object close outputStream exception"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeInputStream</span><span class="params">(InputStream input)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                input.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(<span class="string">"serialize object close inputStream exception"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于Kyro是线程不安全的，所以使用了一个ThreadLocal来维护，也可以挑选其他高性能的序列化方案如Hessian，Protobuf…</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/28/spring-data-redis-2/" data-id="cjcg8h2p9003s5sudvhrx45qc" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/28/spring-data-redis-2/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/28/spring-data-redis-2/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-data-redis-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/27/spring-data-redis-1/">Spring Data Redis（一）--解析RedisTemplate</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/27/spring-data-redis-1/">
            <time datetime="2017-10-27T08:10:55.000Z" itemprop="datePublished">2017-10-27</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Data-Redis/">Spring Data Redis</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>谈及系统优化，缓存一直是不可或缺的一点。在缓存中间件层面，我们有MemCache，Redis等选择；在系统分层层面，又需要考虑多级缓存；在系统可用性层面，又要考虑到缓存雪崩，缓存穿透，缓存失效等常见的缓存问题…缓存的使用与优化值得我们花费一定的精力去深入理解。《Spring Data Redis》这个系列打算围绕spring-data-redis来进行分析，从hello world到源码分析，夹杂一些不多实战经验（经验有限），不止限于spring-data-redis本身，也会扩展谈及缓存这个大的知识点。</p>
<p>至于为何选择redis，相信不用我赘述，redis如今非常流行，几乎成了项目必备的组件之一。而spring-boot-starter-data-redis模块又为我们在spring集成的项目中提供了开箱即用的功能，更加便捷了我们开发。系列的第一篇便是简单介绍下整个组件最常用的一个工具类：RedisTemplate。</p>
<h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1 引入依赖"></a>1 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>springboot的老用户会发现redis依赖名称发生了一点小的变化，在springboot1.4之前，redis依赖的名称为：spring-boot-starter-redis，而在之后较新的版本中，使用spring-boot-starter-redis依赖，则会在项目启动时得到一个过期警告。意味着，我们应该彻底放弃旧的依赖。spring-data这个项目定位为spring提供一个统一的数据仓库接口，如（spring-boot-starter-data-jpa,spring-boot-starter-data-mongo,spring-boot-starter-data-rest），将redis纳入后，改名为了spring-boot-starter-data-redis。</p>
<h2 id="2-配置redis连接"><a href="#2-配置redis连接" class="headerlink" title="2 配置redis连接"></a>2 配置redis连接</h2><p><code>resources/application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  redis:</span></div><div class="line"><span class="attr">    host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line"><span class="attr">    database:</span> <span class="number">0</span></div><div class="line"><span class="attr">    port:</span> <span class="number">6379</span></div><div class="line"><span class="attr">    password:</span></div></pre></td></tr></table></figure>
<p>本机启动一个单点的redis即可，使用redis的0号库作为默认库（默认有16个库），在生产项目中一般会配置redis集群和哨兵保证redis的高可用，同样可以在application.yml中修改，非常方便。</p>
<h2 id="3-编写测试类"><a href="#3-编写测试类" class="headerlink" title="3 编写测试类"></a>3 编写测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.assertj.core.api.Assertions;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</div><div class="line"></div><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</div><div class="line">   <span class="meta">@Autowired</span></div><div class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;<span class="comment">// &lt;1&gt;</span></div><div class="line"></div><div class="line">   <span class="meta">@Test</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">     redisTemplate.opsForValue().set(<span class="string">"student:1"</span>, <span class="string">"kirito"</span>); <span class="comment">// &lt;2&gt;</span></div><div class="line">     Assertions.assertThat(redisTemplate.opsForValue().get(<span class="string">"student:1"</span>)).isEqualTo(<span class="string">"kirito"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 引入了RedisTemplate，这个类是spring-starter-data-redis提供给应用直接访问redis的入口。从其命名就可以看出，其是模板模式在spring中的体现，与restTemplate，jdbcTemplate类似，而springboot为我们做了自动的配置，具体会在下文详解。</1></p>
<p><2> redisTemplate通常不直接操作键值，而是通过opsForXxx()访问，在本例中，key和value均为字符串类型。绑定字符串在实际开发中也是最为常用的操作类型。</2></p>
<h2 id="4-详解RedisTemplate的API"><a href="#4-详解RedisTemplate的API" class="headerlink" title="4 详解RedisTemplate的API"></a>4 详解RedisTemplate的API</h2><p>RedisTemplate为我们操作Redis提供了丰富的API，可以将他们简单进行下归类。</p>
<h3 id="4-1-常用数据操作"><a href="#4-1-常用数据操作" class="headerlink" title="4.1 常用数据操作"></a>4.1 常用数据操作</h3><p>这一类API也是我们最常用的一类。</p>
<p>众所周知，redis存在5种数据类型：</p>
<p>字符串类型（string），散列类型（hash），列表类型（list），集合类型（set），有序集合类型（zset）</p>
<p>而redisTemplate实现了RedisOperations接口，在其中，定义了一系列与redis相关的基础数据操作接口，数据类型分别于下来API对应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//非绑定key操作</span></div><div class="line"><span class="function">ValueOperations&lt;K, V&gt; <span class="title">opsForValue</span><span class="params">()</span></span>;</div><div class="line">&lt;HK, HV&gt; <span class="function">HashOperations&lt;K, HK, HV&gt; <span class="title">opsForHash</span><span class="params">()</span></span>;</div><div class="line"><span class="function">ListOperations&lt;K, V&gt; <span class="title">opsForList</span><span class="params">()</span></span>;</div><div class="line"><span class="function">SetOperations&lt;K, V&gt; <span class="title">opsForSet</span><span class="params">()</span></span>;</div><div class="line"><span class="function">ZSetOperations&lt;K, V&gt; <span class="title">opsForZSet</span><span class="params">()</span></span>;</div><div class="line"><span class="comment">//绑定key操作</span></div><div class="line"><span class="function">BoundValueOperations&lt;K, V&gt; <span class="title">boundValueOps</span><span class="params">(K key)</span></span>;</div><div class="line">&lt;HK, HV&gt; <span class="function">BoundHashOperations&lt;K, HK, HV&gt; <span class="title">boundHashOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundListOperations&lt;K, V&gt; <span class="title">boundListOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundSetOperations&lt;K, V&gt; <span class="title">boundSetOps</span><span class="params">(K key)</span></span>;</div><div class="line"><span class="function">BoundZSetOperations&lt;K, V&gt; <span class="title">boundZSetOps</span><span class="params">(K key)</span></span>;</div></pre></td></tr></table></figure>
<p>若以bound开头，则意味着在操作之初就会绑定一个key，后续的所有操作便默认认为是对该key的操作，算是一个小优化。</p>
<h3 id="4-2-对原生Redis指令的支持"><a href="#4-2-对原生Redis指令的支持" class="headerlink" title="4.2 对原生Redis指令的支持"></a>4.2 对原生Redis指令的支持</h3><p>Redis原生指令中便提供了一些很有用的操作，如设置key的过期时间，判断key是否存在等等…</p>
<p>常用的API列举：</p>
<table>
<thead>
<tr>
<th>RedisTemplate API</th>
<th>原生Redis指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>public void delete(K key)</td>
<td>DEL key [key …]</td>
<td>删除给定的一个或多个 <code>key</code></td>
</tr>
<tr>
<td>public Boolean hasKey(K key)</td>
<td>EXISTS key</td>
<td>检查给定 <code>key</code> 是否存在</td>
</tr>
<tr>
<td>public Boolean expire/expireAt(…)</td>
<td>EXPIRE key seconds</td>
<td>为给定 <code>key</code> 设置生存时间，当 <code>key</code> 过期时(生存时间为 <code>0</code> )，它会被自动删除。</td>
</tr>
<tr>
<td>public Long getExpire(K key)</td>
<td>TTL key</td>
<td>以秒为单位，返回给定 <code>key</code> 的剩余生存时间(TTL, time to live)。</td>
</tr>
</tbody>
</table>
<p>更多的原生Redis指令支持可以参考javadoc</p>
<h3 id="4-3-CAS操作"><a href="#4-3-CAS操作" class="headerlink" title="4.3 CAS操作"></a>4.3 CAS操作</h3><p>CAS（Compare and Swap）通常有3个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。CAS也通常与并发，乐观锁，非阻塞，机器指令等关键词放到一起讲解。可能会有很多朋友在秒杀场景的架构设计中见到了Redis，本质上便是利用了Redis分布式共享内存的特性以及一系列的CAS指令。还记得在4.1中通过redisTemplate.opsForValue()或者redisTemplate.boundValueOps()可以得到一个ValueOperations或BoundValueOperations接口(以值为字符串的操作接口为例)，这些接口除了提供了基础操作外，还提供了一系列CAS操作，也可以放到RedisTemplate中一起理解。</p>
<p>常用的API列举：</p>
<table>
<thead>
<tr>
<th style="text-align:left">ValueOperations API</th>
<th style="text-align:left">原生Redis指令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Boolean setIfAbsent(K key, V value)</td>
<td style="text-align:left">SETNX key value</td>
<td style="text-align:left">将 <code>key</code> 的值设为 <code>value</code> ，当且仅当 <code>key</code> 不存在。设置成功，返回 <code>1</code> ， 设置失败，返回 <code>0</code> 。</td>
</tr>
<tr>
<td style="text-align:left">V getAndSet(K key, V value)</td>
<td style="text-align:left">GETSET key value</td>
<td style="text-align:left">将给定 <code>key</code> 的值设为 <code>value</code> ，并返回 <code>key</code> 的旧值(old value)。</td>
</tr>
<tr>
<td style="text-align:left">Long increment(K key, long delta)/Double increment(K key, double delta)</td>
<td style="text-align:left">INCR/INCRBY/INCRBYFLOAT</td>
<td style="text-align:left">将 <code>key</code> 所储存的值加上增量 <code>increment</code> 。 如果 <code>key</code> 不存在，那么 <code>key</code> 的值会先被初始化为 <code>0</code> ，然后再执行INCR/INCRBY/INCRBYFLOAT命令。线程安全的+</td>
</tr>
</tbody>
</table>
<p>关于CAS的理解可以参考我之前的文章<a href="https://www.cnkirito.moe/2017/03/12/java%E5%B9%B6%E5%8F%91%E5%AE%9E%E8%B7%B5--ConcurrentHashMap%E4%B8%8ECAS/" target="_blank" rel="external">java并发实践–CAS</a>或者其他博文。</p>
<h3 id="4-4-发布订阅"><a href="#4-4-发布订阅" class="headerlink" title="4.4 发布订阅"></a>4.4 发布订阅</h3><p>redis之所以被冠以银弹，万金油的称号，关键在于其实现的功能真是太多了，甚至实现了一部分中间件队列的功能，其内置的channel机制，可以用于实现分布式的队列和广播。</p>
<p>RedisTemplate提供了convertAndSend()功能，用于发送消息，与RedisMessageListenerContainer 配合接收，便实现了一个简易的发布订阅。如果想要使用Redis实现发布订阅，可以参考我之前的文章。<a href="https://www.cnkirito.moe/2017/09/13/event-2/" target="_blank" rel="external">浅析分布式下的事件驱动机制</a></p>
<h3 id="4-5-Lua脚本"><a href="#4-5-Lua脚本" class="headerlink" title="4.5 Lua脚本"></a>4.5 Lua脚本</h3><p>RedisTemplate中包含了这样一个Lua执行器，意味着我们可以使用RedisTemplate执行Lua脚本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ScriptExecutor&lt;K&gt; scriptExecutor;</div></pre></td></tr></table></figure>
<p>Lua这门语言也非常有意思，小巧而精悍，有兴趣的朋友可以去了解一下nginx+lua开发，使用openResty框架。而Redis内置了Lua的解析器，由于Redis单线程的特性（不严谨），可以使用Lua脚本，完成一些线程安全的符合操作（CAS操作仅仅只能保证单个操作的线程安全，无法保证复合操作，如果你有这样的需求，可以考虑使用Redis+Lua脚本）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> scriptExecutor.execute(script, keys, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述操作便可以完成对Lua脚本的调用。这儿有一个简单的示例，使用Redis+Lua脚本实现分布式的应用限流。<a href="https://www.cnkirito.moe/2017/03/18/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/" target="_blank" rel="external">分布式限流</a></p>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h3><p>Spring Data Redis系列的第一篇，介绍了spring-data对redis操作的封装，顺带了解redis具备的一系列特性，如果你对redis的理解还仅仅停留在它是一个分布式的key-value数据库，那么相信现在你一定会感叹其竟然如此强大。后续将会对缓存在项目中的应用以及spring-boot-starter-data-redis进一步解析。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/27/spring-data-redis-1/" data-id="cjcg8h2p4003l5sud8tdo9txn" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/27/spring-data-redis-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/27/spring-data-redis-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-java-skill-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/25/java-skill-1/">java小技巧(一)--远程debug</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/25/java-skill-1/">
            <time datetime="2017-10-25T09:24:48.000Z" itemprop="datePublished">2017-10-25</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA/">JAVA</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <p>该系列介绍一些java开发中常用的一些小技巧，多小呢，从不会到会只需要一篇文章这么小。这一篇介绍如何使用jdk自带的扩展包配合Intellij IDEA实现远程debug。</p>
<p>项目中经常会有出现这样的问题，会令程序员抓狂：关键代码段没有打印日志，本地环境正常生产环境却又问题…这时候，远程debug可能会启动作用。</p>
<h2 id="1-准备用于debug的代码"><a href="#1-准备用于debug的代码" class="headerlink" title="1 准备用于debug的代码"></a>1 准备用于debug的代码</h2><p>准备一个RestController用于接收请求，最后可以通过本地断点验证是否成功开启了远程debug</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        i++;</div><div class="line">        i++;</div><div class="line">        i++;</div><div class="line">        i++;</div><div class="line">        i++;</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>项目使用springboot和maven构建，依赖就省略了，使用springboot提供的maven打包插件，方便我们打包成可运行的jar。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">executable</span>&gt;</span>true<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="2-使用maven插件打包成jar"><a href="#2-使用maven插件打包成jar" class="headerlink" title="2 使用maven插件打包成jar"></a>2 使用maven插件打包成jar</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/maven_install.png" alt="maven插件"></p>
<h2 id="3-准备启动脚本"><a href="#3-准备启动脚本" class="headerlink" title="3 准备启动脚本"></a>3 准备启动脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=64057 remote-debug-1.0-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<ol>
<li>使用java -jar的方式启动程序，并且添加了一串特殊的参数，这是我们能够开启远程debug的关键，以<code>-</code>开头的参数是jvm的标准启动参数，关于jvm启动参数相关的知识可以先去其他博客了解。</li>
<li>-agentlib:libname[=options], 用于装载本地lib包。在这条指令中便是加载了jdwp(Java Debug Wire Protocol)这个用于远程调试java的扩展包。而<code>transport=dt_socket,server=y,suspend=n,address=64057</code>这些便是jdwp装载时的定制参数，详细的参数作用可以搜索jdwp进行了解。我们需要关心的只有address=64057这个参数选项，本地调试程序使用64057端口与其通信，从而远程调试。</li>
</ol>
<h2 id="4-配置IDEA"><a href="#4-配置IDEA" class="headerlink" title="4 配置IDEA"></a>4 配置IDEA</h2><p><img src="http://ov0zuistv.bkt.clouddn.com/%E8%BF%9C%E7%A8%8Bdebug_idea%E9%85%8D%E7%BD%AE.png" alt="IDEA配置"></p>
<ol>
<li>与脚本中的指令完全一致</li>
<li>远程jar包运行的host，由于我的jar运行在本地，所以使用的是localhost，一般线上环境自然是修改为线上的地址</li>
<li>与远程jar包进行交互的端口号，idea会根据指令自动帮我们输入</li>
<li>选择与远程jar包一致的本地代码</li>
</ol>
<p><strong>请务必保证远程jar包的代码与本地代码一致！！！</strong></p>
<h2 id="5-验证"><a href="#5-验证" class="headerlink" title="5 验证"></a>5 验证</h2><p>保存第4步的配置后，先执行脚本让远程的jar包跑起来，再在IDEA中运行remote-debug</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/%E8%BF%90%E8%A1%8Cremote.png" alt="运行remote-jar"></p>
<p>如上便代表连接运行成功了</p>
<p>在本地打上断点，访问<code>localhost:8080/test</code></p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/debug%E4%BF%A1%E6%81%AF%E5%B1%95%E7%A4%BA.png" alt="远程debug信息展示"></p>
<p>可以在本地看到堆栈信息，大功告成。一行指令便完成了远程调试。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/25/java-skill-1/" data-id="cjcg8h2nq00235sudm75xnbvs" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/25/java-skill-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/25/java-skill-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-concurrent-2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/15/concurrent-2/">浅析项目中的并发(二)</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/15/concurrent-2/">
            <time datetime="2017-10-15T03:11:11.000Z" itemprop="datePublished">2017-10-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/架构设计/">架构设计</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/架构设计/">架构设计</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="分布式遭遇并发"><a href="#分布式遭遇并发" class="headerlink" title="分布式遭遇并发"></a>分布式遭遇并发</h2><p>在前面的章节，并发操作要么发生在单个应用内，一般使用基于JVM的lock解决并发问题，要么发生在数据库，可以考虑使用数据库层面的锁，而在分布式场景下，需要保证多个应用实例都能够执行同步代码，则需要做一些额外的工作，一个最典型分布式同步方案便是使用分布式锁。</p>
<p>分布式锁由很多种实现，但本质上都是类似的，即依赖于共享组件实现锁的询问和获取，如果说单体式应用中的Monitor是由JVM提供的，那么分布式下Monitor便是由共享组件提供，而典型的共享组件大家其实并不陌生，包括但不限于：Mysql，Redis，Zookeeper。同时他们也代表了三种类型的共享组件：数据库，缓存，分布式协调组件。基于Consul的分布式锁，其实和基于Zookeeper的分布式锁大同小异，都是借助于分布式协调组件实现锁，大而化之，这三种类型的分布式锁，原理也都差不多，只不过，锁的特性和实现细节有所差异。</p>
<h3 id="Redis实现分布式锁"><a href="#Redis实现分布式锁" class="headerlink" title="Redis实现分布式锁"></a>Redis实现分布式锁</h3><p>定义需求：A应用需要完成添加库存的操作，部署了A1，A2，A3多个实例，实例之间的操作要保证同步。</p>
<p>分析需求：显然，此时依赖于JVM的lock已经没办法解决问题了，A1添加锁，无法保证A2，A3的同步，这种场景可以考虑使用分布式锁应对。</p>
<p>建立一张Stock表，包含id，number两个字段，分别让A1，A2，A3并发对其操作，保证线程安全。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stock</span> </span>&#123;</div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line">    <span class="keyword">private</span> Integer number;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义数据库访问层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StockRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Stock</span>,<span class="title">String</span>&gt; </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一节的主角，redis分布式锁，使用开源的redis分布式锁实现：Redisson。</p>
<p>引入Redisson依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>定义测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    StockRepository stockRepository;</div><div class="line"></div><div class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    RedissonClient redissonClient;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String id = <span class="string">"1"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/addStock"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addStock</span><span class="params">()</span> </span>&#123;</div><div class="line">        RLock lock = redissonClient.getLock(<span class="string">"redisson:lock:stock:"</span> + id);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">            executorService.execute(() -&gt; &#123;</div><div class="line">                lock.lock();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Stock stock = stockRepository.findOne(id);</div><div class="line">                    stock.setNumber(stock.getNumber() + <span class="number">1</span>);</div><div class="line">                    stockRepository.save(stock);</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    lock.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 上述的代码使得并发发生在多个层面。其一，在应用内部，启用线程池完成库存的加1操作，本身便是线程不安全的，其二，在多个应用之间，这样的加1操作更加是不受约束的。若初始化id为1的Stock数量为0。分别在本地启用A1(8080)，A2(8081)，A3(8082)三个应用，同时并发执行一次addStock()，若线程安全，必然可以使得数据库中的Stock为300，这便是我们的检测依据。</p>
<p>简单解读下上述的代码，使用redisson获取一把RLock，RLock是<code>java.util.concurrent.locks.Lock</code>接口的实现类，Redisson帮助我们屏蔽Redis分布式锁的实现细节，使用过<code>java.util.concurrent.locks.Lock</code>的朋友都会知道下述的代码可以被称得上是同步的起手范式，毕竟这是Lock的java doc中给出的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Lock l = ...;</div><div class="line">l.lock();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">   <span class="comment">// access the resource protected by this lock</span></div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  l.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而<code>redissonClient.getLock(&quot;redisson:lock:stock:&quot; + id)</code>则是以<code>&quot;redisson:lock:stock:&quot; + id</code>该字符串作痛同步的Monitor，保证了不同id之间是互相不阻塞的。</p>
<p>为了保证发生并发，实际测试中我加入了Thread.sleep(1000)，使竞争得以发生。测试结果：</p>
<p><img src="http://ov0zuistv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171015115902.png" alt="测试结果"></p>
<p>Redis分布式锁的确起了作用。</p>
<h2 id="锁的注意点"><a href="#锁的注意点" class="headerlink" title="锁的注意点"></a>锁的注意点</h2><p>如果仅仅是实现一个能够用于demo的Redis分布式锁并不难，但为何大家更偏向于使用开源的实现呢？主要还是可用性和稳定性，we make things work是我在写博客，写代码时牢记在脑海中的，如果真的要细究如何自己实现一个分布式锁，或者平时使用锁保证并发，需要有哪些注意点呢？列举几点：阻塞，超时时间，可重入，可用性，其他特性。</p>
<h3 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h3><p>意味着各个操作之间的等待，A1正在执行增加库存时，A1其他的线程被阻塞，A2，A3中所有的线程被阻塞，在Redis中可以使用轮询策略以及redis底层提供的CAS原语(如setnx)来实现。（初学者可以理解为：在redis中设置一个key，想要执行lock代码时先询问是否有该key，如果有则代表其他线程在执行过程中，若没有，则设置该key，并且执行代码，执行完毕，释放key，而setnx保证操作的原子性）</p>
<h3 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h3><p>在特殊情况，可能会导致锁无法被释放，如死锁，死循环等等意料之外的情况，锁超时时间的设置是有必要的，一个很直观的想法是给key设置过期时间即可。</p>
<p>如在Redisson中，lock提供了一个重载方法<code>lock(long t, TimeUnit timeUnit);</code>可以自定义过期时间。</p>
<h3 id="可重入"><a href="#可重入" class="headerlink" title="可重入"></a>可重入</h3><p>这个特性很容易被忽视，可重入其实并不难理解，顾名思义，一个方法在调用过程中是否可以被再次调用。实现可重入需要满足三个特性：</p>
<ol>
<li>可以在执行的过程中可以被打断；</li>
<li>被打断之后，在该函数一次调用执行完之前，可以再次被调用（或进入，reentered)。</li>
<li>再次调用执行完之后，被打断的上次调用可以继续恢复执行，并正确执行。</li>
</ol>
<p>比如下述的代码引用了全局变量，便是不可重入的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> t;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    t = x;</div><div class="line">    x = y;</div><div class="line">    y = t;</div><div class="line">    System.out.println(<span class="string">"x is"</span> + x + <span class="string">" y is "</span> + y);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个更加直观的例子便是，同一个线程中，某个方法的递归调用不应该被阻塞，所以如果要实现这个特性，简单的使用某个key作为Monitor是欠妥的，可以加入线程编号，来保证可重入。</p>
<p>使用可重入分布式锁的来测试计算斐波那契数列（只是为了验证可重入性）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"testReentrant"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</div><div class="line">    RLock lock = redissonClient.getLock(<span class="string">"fibonacci"</span>);</div><div class="line">    lock.lock();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> result = fibonacci(<span class="number">10</span>);</div><div class="line">        System.out.println(result);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibonacci</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    RLock lock = redissonClient.getLock(<span class="string">"fibonacci"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + fibonacci(n - <span class="number">2</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终输出：55，可以发现，只要是在同一线程之内，无论是递归调用还是外部加锁(同一把锁)，都不会造成死锁。</p>
<h3 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h3><p>借助于第三方中间件实现的分布式锁，都有这个问题，中间件挂了，会导致锁不可用，所以需要保证锁的高可用，这就需要保证中间件的可用性，如redis可以使用哨兵+集群，保证了中间件的可用性，便保证了锁的可用性、</p>
<h3 id="其他特性"><a href="#其他特性" class="headerlink" title="其他特性"></a>其他特性</h3><p>除了可重入锁，锁的分类还有很多，在分布式下也同样可以实现，包括但不限于：公平锁，联锁，信号量，读写锁。Redisson也都提供了相关的实现类，其他的特性如并发容器等可以参考官方文档。</p>
<h2 id="新手遭遇并发"><a href="#新手遭遇并发" class="headerlink" title="新手遭遇并发"></a>新手遭遇并发</h2><p>基本算是把项目中遇到的并发过了一遍了，案例其实很多，再简单罗列下一些新手可能会遇到的问题。</p>
<p>使用了线程安全的容器就是线程安全了吗？很多新手误以为使用了并发容器如：concurrentHashMap就万事大吉了，却不知道，一知半解的隐患可能比全然不懂更大。来看下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> Map&lt;String, Integer&gt; counter = <span class="keyword">new</span> ConcurrentHashMap();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        counter.put(<span class="string">"stock1"</span>, <span class="number">0</span>);</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">100</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">            executorService.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    counter.put(<span class="string">"stock1"</span>, counter.get(<span class="string">"stock1"</span>) + <span class="number">1</span>);</div><div class="line">                    countDownLatch.countDown();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        countDownLatch.await();</div><div class="line">        System.out.println(<span class="string">"result is "</span> + counter.get(<span class="string">"stock1"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>counter.put(&quot;stock1&quot;, counter.get(&quot;stock1&quot;) + 1)</code>并不是原子操作，并发容器保证的是单步操作的线程安全特性，这一点往往初级程序员特别容易忽视。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>项目中的并发场景是非常多的，而根据场景不同，同一个场景下的业务需求不同，以及数据量，访问量的不同，都会影响到锁的使用，架构中经常被提到的一句话是：业务决定架构，放到并发中也同样适用：业务决定控制并发的手段，如本文未涉及的队列的使用，本质上是化并发为串行，也解决了并发问题，都是控制的手段。了解锁的使用很简单，但如果使用，在什么场景下使用什么样的锁，这才是价值所在。</p>
<p>同一个线程之间的递归调用不应该被阻塞，所以如果要实现这个特性，简单的使用某个key作为Monitor是欠妥的，可以加入线程编号，来保证可重入。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/15/concurrent-2/" data-id="cjcg8h2mn000p5sudtju1rtyn" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/15/concurrent-2/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/15/concurrent-2/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-concurrent-1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/11/concurrent-1/">浅析项目中的并发(一)</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/11/concurrent-1/">
            <time datetime="2017-10-11T13:29:40.000Z" itemprop="datePublished">2017-10-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/架构设计/">架构设计</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/架构设计/">架构设计</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
             <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>控制并发的方法很多，从最基础的synchronized，juc中的lock，到数据库的行级锁，乐观锁，悲观锁，再到中间件级别的redis，zookeeper分布式锁。特别是初级程序员，对于所谓的锁一直都是听的比用的多，第一篇文章不深入探讨并发，更多的是一个入门介绍，适合于初学者，主题是“根据并发出现的具体业务场景，使用合理的控制并发手段”。</p>
<h2 id="什么是并发"><a href="#什么是并发" class="headerlink" title="什么是并发"></a>什么是并发</h2><p>由一个大家都了解的例子引入我们今天的主题：并发</p>
<h3 id="类共享变量遭遇并发"><a href="#类共享变量遭遇并发" class="headerlink" title="类共享变量遭遇并发"></a>类共享变量遭遇并发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Integer count = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Demo demo = <span class="keyword">new</span> Demo();</div><div class="line">        Executor executor = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    demo.count++;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(<span class="number">5000</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"final count value:"</span>+demo1.count);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>final count value:973</code></p>
<p>本例中创建了一个初始化时具有10个线程的线程池，多线程对类变量count进行自增操作。这个过程中，自增操作并不是线程安全的，happens-before原则并不会保障多个线程执行的先后顺序，导致了最终结果并不是想要的1000</p>
<p>下面，我们把并发中的共享资源从类变量转移到数据库中。</p>
<h3 id="充血模型遭遇并发"><a href="#充血模型遭遇并发" class="headerlink" title="充血模型遭遇并发"></a>充血模型遭遇并发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    TestNumDao testNumDao;</div><div class="line"></div><div class="line">    <span class="meta">@Transactional</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</div><div class="line">        TestNum testNum = testNumDao.findOne(<span class="string">"1"</span>);</div><div class="line">        testNum.setCount(testNum.getCount()+<span class="number">1</span>);</div><div class="line">        testNumDao.save(testNum);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>依旧使用多线程，对数据库中的记录进行+1操作</p>
<pre><code>Demo2 demo2;

public String test(){
    Executor executor = Executors.newFixedThreadPool(10);
    for(int i=0;i&lt;1000;i++){
        executor.execute(new Runnable() {
            @Override
            public void run() {
                demo2.test();
            }
        });
    }
    return &quot;test&quot;;
}
</code></pre><p>数据库的记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">id	| count</div><div class="line">1	| 344</div></pre></td></tr></table></figure>
<p>初窥门径的程序员会认为事务最基本的ACID中便包含了原子性，但是事务的原子性和今天所讲的并发中的原子操作仅仅是名词上有点类似。而有点经验的程序员都能知道这中间发生了什么，这只是暴露了项目中并发问题的冰山一角，千万不要认为上面的代码没有必要列举出来，我在实际项目开发中，曾经见到有多年工作经验的程序员仍然写出了类似于上述会出现并发问题的代码。</p>
<h3 id="贫血模型遭遇并发"><a href="#贫血模型遭遇并发" class="headerlink" title="贫血模型遭遇并发"></a>贫血模型遭遇并发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"testSql"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testSql</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1000</span>);</div><div class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">        Executor executor = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    jdbcTemplate.execute(<span class="string">"update test_num set count = count + 1 where id = '1'"</span>);</div><div class="line">                    countDownLatch.countDown();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        countDownLatch.await();</div><div class="line">        <span class="keyword">long</span> costTime =System.currentTimeMillis() - start;</div><div class="line">        System.out.println(<span class="string">"共花费："</span>+costTime+<span class="string">" s"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"testSql"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>数据库结果： count ： 1000 达到了预期效果<br>这个例子我顺便记录了耗时,控制台打印:共花费：113 ms<br>简单对比一下二，三两个例子，都是想对数据库的count进行+1操作，唯一的区别就是，<strong>后者的+1计算发生在数据库，而前者的计算依赖于事先查出来的值，并且计算发生在程序的内存中</strong>。而现在大部分的ORM框架，导致了写充血模型的程序员变多，不注意并发的话，就会出现问题。下面我们来看看具体的业务场景。</p>
<h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><ol>
<li>修改个人信息</li>
<li>修改商品信息</li>
<li>扣除账户余额，扣减库存</li>
</ol>
<h2 id="业务场景分析"><a href="#业务场景分析" class="headerlink" title="业务场景分析"></a>业务场景分析</h2><p>第一个场景，互联网如此众多的用户修改个人信息，这算不算并发？答案是：算也不算。<br>算，从程序员角度来看，每一个用户请求进来，都是调用的同一个修改入口，具体一点，就是映射到controller层的同一个requestMapping，所以一定是并发的。<br>不算，虽然程序是并发的，但是从用户角度来分析，每个人只可以修改自己的信息，所以，不同用户的操作其实是隔离的，所以不算“并发”。这也是为什么很多开发者，在日常开发中一直不注意并发控制，却也没有发生太大问题的原因，大多数初级程序员开发的还都是CRM，OA，CMS系统。</p>
<p>回到我们的并发，第一种业务场景，是可以使用如上模式的，对于一条用户数据的修改，我们允许程序员读取数据到内存中，内存计算修改（耗时操作），提交更改，提交事务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Transaction start</span></div><div class="line">User user = userDao.findById(<span class="string">"1"</span>);</div><div class="line">user.setName(<span class="string">"newName"</span>);</div><div class="line">user.setAge(user.getAge()+<span class="number">1</span>);</div><div class="line">...<span class="comment">//其他耗时操作</span></div><div class="line">userDao.save(user);</div><div class="line"><span class="comment">//Transaction commit</span></div></pre></td></tr></table></figure>
<p>这个场景变现为：几乎不存在并发，不需要控制，场景乐观。</p>
<p>为了严谨，也可以选择控制并发，但我觉得这需要交给写这段代码的同事，让他自由发挥。</p>
<p>第二个场景已经有所不同了，同样是修改一个记录，但是系统中可能有多个操作员来维护，此时，商品数据表现为一个共享数据，所以存在微弱的并发，通常表现为数据的脏读，例如操作员A，B同时对一个商品信息维护，我们希望只能有一个操作员修改成功，另外一个操作员得到错误提示（该商品信息已经发生变化），否则，两个人都以为自己修改成功了，但是其实只有一个人完成了操作，另一个人的操作被覆盖了。</p>
<p>这个场景表现为：存在并发，需要控制，允许失败，场景乐观。</p>
<p>通常我建议这种场景使用乐观锁，即在商品属性添加一个<code>version</code>字段标记修改的版本，这样两个操作员拿到同一个版本号，第一个操作员修改成功后版本号变化，另一个操作员的修改就会失败了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span></span>&#123;</div><div class="line">	<span class="meta">@Version</span></div><div class="line">	<span class="keyword">int</span> version;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Transaction start</span></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">	Goods goods = goodsDao.findById(<span class="string">"1"</span>);</div><div class="line">	goods.setName(<span class="string">"newName"</span>);</div><div class="line">	goods.setPrice(goods.getPrice()+<span class="number">100.00</span>);</div><div class="line">	...<span class="comment">//其他耗时操作</span></div><div class="line">	goodsDao.save(goods);</div><div class="line">&#125;<span class="keyword">catch</span>(org.hibernate.StaleObjectStateException e)&#123;</div><div class="line">	<span class="comment">//返回给前台</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Transaction commit</span></div></pre></td></tr></table></figure>
<p>springdata配合jpa可以自动捕获version异常，也可以自动手动对比。</p>
<p>第三个场景<br>这个场景表现为：存在频繁的并发，需要控制，不允许失败，场景悲观。</p>
<p><strong>强调一下，本例不应该使用在项目中，只是为了举例而设置的一个场景，因为这种贫血模型无法满足复杂的业务场景，而且依靠单机事务来保证一致性，并发性能和可扩展性能不好。</strong></p>
<p>一个简易的秒杀场景，大量请求在短时间涌入，是不可能像第二种场景一样，100个并发请求，一个成功，其他99个全部异常的。</p>
<p>设计方案应该达到的效果是：有足够库存时，允许并发，库存到0时，之后的请求全部失败；有足够金额时，允许并发，金额不够支付时立刻告知余额不足。</p>
<p>可以利用数据库的行级锁，<br><code>update set balance = balance - money where userId = ? and balance &gt;= money;</code><br><code>update stock = stock - number where goodsId = ? and stock &gt;= number ;</code>  然后在后台 查看返回值是否影响行数为1，判断请求是否成功，利用数据库保证并发。</p>
<p>需要补充一点，我这里所讲的秒杀，并不是指双11那种级别的秒杀，那需要多层架构去控制并发，前端拦截，负载均衡….不能仅仅依赖于数据库的，会导致严重的性能问题。为了留一下一个直观的感受，这里对比一下oracle，mysql的两个主流存储引擎：innodb，myisam的性能问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">oracle:</div><div class="line">10000个线程共计1000000次并发请求：共花费：101017 ms =&gt;101s</div><div class="line">innodb:</div><div class="line">10000个线程共计1000000次并发请求：共花费：550330 ms =&gt;550s</div><div class="line">myisam:</div><div class="line">10000个线程共计1000000次并发请求：共花费：75802 ms =&gt;75s</div></pre></td></tr></table></figure></p>
<p>可见，如果真正有大量请求到达数据库，光是依靠数据库解决并发是不现实的，所以仅仅只用数据库来做保障而不是完全依赖。需要根据业务场景选择合适的控制并发手段。</p>

           
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/11/concurrent-1/" data-id="cjcg8h2mg000h5sud1ac0zblc" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/11/concurrent-1/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/11/concurrent-1/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <article id="post-spring-security-5" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/01/spring-security-5/">Spring Security(五)--动手实现一个IP_Login</a>
        </h1>
    

                
                    <div class="article-meta">
                    	
	
		<div class="article-type">
		    <span class="label label-success" style="float: left;padding: 3px 5px 3px 5px;margin-right: 15px;margin-top: 2px;">原创</span>
		</div>
	
		


                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/01/spring-security-5/">
            <time datetime="2017-10-01T14:44:34.000Z" itemprop="datePublished">2017-10-01</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring-Security/">Spring Security</a>
    </div>

                        <!-- 不显示标签 -->
                        <!-- 
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>
    </div>
 -->
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>在开始这篇文章之前，我们似乎应该思考下为什么需要搞清楚Spring Security的内部工作原理？按照第二篇文章中的配置，一个简单的表单认证不就达成了吗？更有甚者，为什么我们不自己写一个表单认证，用过滤器即可完成，大费周章引入Spring Security，看起来也并没有方便多少。对的，在引入Spring Security之前，我们得首先想到，是什么需求让我们引入了Spring Security，以及为什么是Spring Security，而不是shiro等等其他安全框架。我的理解是有如下几点：</p>
<p>1 在前文的介绍中，Spring Security支持防止csrf攻击，session-fixation protection，支持表单认证，basic认证，rememberMe…等等一些特性，有很多是开箱即用的功能，而大多特性都可以通过配置灵活的变更，这是它的强大之处。</p>
<p>2 Spring Security的兄弟的项目Spring Security SSO，OAuth2等支持了多种协议，而这些都是基于Spring Security的，方便了项目的扩展。</p>
<p>3 SpringBoot的支持，更加保证了Spring Security的开箱即用。</p>
<p>4 为什么需要理解其内部工作原理?一个有自我追求的程序员都不会满足于浅尝辄止，如果一个开源技术在我们的日常工作中十分常用，那么我偏向于阅读其源码，这样可以让我们即使排查不期而至的问题，也方便日后需求扩展。</p>
<p>5 Spring及其子项目的官方文档是我见过的最良心的文档！<del>相比较于Apache的部分文档</del></p>
<p>这一节，为了对之前分析的Spring Security源码和组件有一个清晰的认识，介绍一个使用IP完成登录的简单demo。</p></p>
            <p class="article-more-link">
                <a href="/2017/10/01/spring-security-5/#more">查看更多</a>
            </p>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://lexburner.github.io/2017/10/01/spring-security-5/" data-id="cjcg8h2ps004k5sudn2c60e09" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://lexburner.github.io/2017/10/01/spring-security-5/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://lexburner.github.io/2017/10/01/spring-security-5/">评论</a>
    

        </footer>
    </div>
	
    
	
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2018/01/14/gracefully-shutdown/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JAVA/">JAVA</a></p>
                            <p class="item-title"><a href="/2018/01/14/gracefully-shutdown/" class="title">研究优雅停机时的一点思考</a></p>
                            <p class="item-date"><time datetime="2018-01-14T12:16:28.000Z" itemprop="datePublished">2018-01-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2018/01/11/threadPool/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2018/01/11/threadPool/" class="title">深入理解RPC之动态代理篇</a></p>
                            <p class="item-date"><time datetime="2018-01-11T14:21:28.000Z" itemprop="datePublished">2018-01-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2018/01/05/rpc-registry/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2018/01/05/rpc-registry/" class="title">深入理解RPC之服务注册与发现篇</a></p>
                            <p class="item-date"><time datetime="2018-01-05T12:16:28.000Z" itemprop="datePublished">2018-01-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/12/28/rpc-protocol/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2017/12/28/rpc-protocol/" class="title">深入理解RPC之协议篇</a></p>
                            <p class="item-date"><time datetime="2017-12-28T12:16:28.000Z" itemprop="datePublished">2017-12-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- 去除图片 -->
                        <!-- <div class="item-thumbnail">
                            <a href="/2017/12/27/motan-async/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/RPC/">RPC</a></p>
                            <p class="item-title"><a href="/2017/12/27/motan-async/" class="title">Motan中使用异步RPC接口</a></p>
                            <p class="item-date"><time datetime="2017-12-27T13:34:34.000Z" itemprop="datePublished">2017-12-27</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Data-Redis/">Spring Data Redis</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Security/">Spring Security</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Security-OAuth2/">Spring Security OAuth2</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Session/">Spring Session</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术杂谈/">技术杂谈</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构设计/">架构设计</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/规则引擎/">规则引擎</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/领域驱动设计/">领域驱动设计</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/DevOps/" style="font-size: 11.43px;">DevOps</a> <a href="/tags/JAVA/" style="font-size: 20px;">JAVA</a> <a href="/tags/JMM/" style="font-size: 10px;">JMM</a> <a href="/tags/RPC/" style="font-size: 17.14px;">RPC</a> <a href="/tags/Spring/" style="font-size: 18.57px;">Spring</a> <a href="/tags/Spring-Cloud/" style="font-size: 12.86px;">Spring Cloud</a> <a href="/tags/Spring-Cloud-Zuul/" style="font-size: 11.43px;">Spring Cloud Zuul</a> <a href="/tags/Spring-Data-Redis/" style="font-size: 11.43px;">Spring Data Redis</a> <a href="/tags/Spring-Security/" style="font-size: 15.71px;">Spring Security</a> <a href="/tags/Spring-Security-OAuth2/" style="font-size: 12.86px;">Spring Security OAuth2</a> <a href="/tags/Spring-Session/" style="font-size: 12.86px;">Spring Session</a> <a href="/tags/Validation/" style="font-size: 11.43px;">Validation</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/Zipkin/" style="font-size: 10px;">Zipkin</a> <a href="/tags/drools/" style="font-size: 14.29px;">drools</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/motan/" style="font-size: 10px;">motan</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/事务/" style="font-size: 11.43px;">事务</a> <a href="/tags/代码规范/" style="font-size: 10px;">代码规范</a> <a href="/tags/多线程/" style="font-size: 15.71px;">多线程</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/技术杂谈/" style="font-size: 15.71px;">技术杂谈</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/杂谈/" style="font-size: 10px;">杂谈</a> <a href="/tags/架构设计/" style="font-size: 14.29px;">架构设计</a> <a href="/tags/求职/" style="font-size: 10px;">求职</a> <a href="/tags/规则引擎/" style="font-size: 14.29px;">规则引擎</a> <a href="/tags/领域驱动设计/" style="font-size: 11.43px;">领域驱动设计</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://www.zhihu.com/people/xu-jing-feng-29/activities">我的知乎</a>
                    </li>
                
                    <li>
                        <a href="https://ntzyz.io/">namespace_ntzyz</a>
                    </li>
                
                    <li>
                        <a href="http://blog.didispace.com/">程序猿DD|博客</a>
                    </li>
                
                    <li>
                        <a href="http://vip.iocoder.cn">芋道源码</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 徐靖峰<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = '';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'hexo-theme-icarus' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>